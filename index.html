
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Raidex Mini App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
<meta name="format-detection" content="telephone=no, date=no, email=no, address=no" />
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
  *,
  *::before,
  *::after {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
  }

  html,
  body {
    width: 100%;
    height: 100%;
    overflow: hidden;
  }

  body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Arial, sans-serif;
    background-color: var(--tg-theme-bg-color, #0b1220);
    color: var(--tg-theme-text-color, #ffffff);
  }

      /* --- Styles Ø§Ù„Ø£Ø³Ø§Ø³ÙŠÙ‡ --- */
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: Arial, sans-serif;
        background: #0b1220;
        color: white;
        overflow: hidden;
      }
      /* Loading */
      .loading-container {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
        background: #000;
      }
      .loading-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .loading-bar {
        position: absolute;
        bottom: 50px;
        left: 10%;
        width: 80%;
        height: 30px;
        background: rgba(255, 255, 255, 0.3);
        border-radius: 15px;
        overflow: hidden;
        text-align: center;
        line-height: 30px;
      }
      .loading-fill {
        width: 0%;
        height: 100%;
        background: #007bff;
        transition: width 0.3s;
        color: white;
        font-weight: bold;
      }
      /* Character */
      #character-screen {
        display: none;
        height: 100vh;
        background: #0b1220;
        text-align: center;
        padding-top: 30px;
        z-index: 50;
        position: relative;
      }
      .characters {
        display: flex;
        flex-direction: column;
        gap: 25px;
        align-items: center;
      }
      .char {
        background: #1e293b;
        padding: 15px;
        border-radius: 15px;
        width: 60%;
        max-width: 400px;
        cursor: pointer;
        transition: transform 0.2s;
      }
      .char:hover {
        transform: scale(1.05);
      }
      .char img {
        width: 100%;
        border-radius: 10px;
      }
    /* City */
#city-screen {
  display: none;
  height: 100vh;
  background: #121a2f;
  position: relative;
}

.right-arrow-menu {
  position: fixed;
  top: 50%;
  right: 0;
  transform: translateY(-50%);
  z-index: 1000;
  display: none; /* Ø®Ù„ÙŠÙ‡Ø§ none */
}

/* Ø²Ø± Ø§Ù„Ø³Ù‡Ù… Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙ…ÙŠÙ† */
.right-arrow-btn {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 2px solid #ffd66b;
  background: #1b1b2f;
  color: #ffd66b;
  font-size: 22px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 4px 0;
  transition: background 0.2s ease, transform 0.2s ease;
}

.right-arrow-btn:hover {
  background: #ffd66b;
  color: #1b1b2f;
  transform: scale(1.05);
}

/* Ø¯ÙˆØ±Ø§Ù† Ø§Ù„Ø³Ù‡Ù… Ù„Ù…Ø§ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ØªÙØªØ­ */
.right-arrow-btn.open {
  transform: rotate(180deg);
}

/* ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© + Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ø§Ù„Ø³Ù„Ø§ÙŠØ¯ */
.right-options {
  position: absolute;
  top: 50%;
  right: 50px;
  transform: translateY(-50%) translateX(100%);
  background: rgba(15, 15, 25, 0.95);
  border-radius: 16px;
  padding: 12px;
  display: flex;
  flex-direction: column;
  gap: 10px;
  min-width: 160px;
  transition: transform 0.25s ease-out;
}

.right-options.open {
  transform: translateY(-50%) translateX(0);
}

/* ØªÙƒØ¨ÙŠØ± Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø¬ÙˆÙ‡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© */
.icon-circle {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  border: 2px solid #ffd66b;
  background: #26293f;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  font-size: 24px;
  transition: background 0.2s ease, transform 0.2s ease;
}

.icon-circle:hover {
  background: #ffd66b;
  transform: translateY(-2px);
}
#building-bottom-actions {
  position: fixed;
  left: 50%;
  bottom: 80px;
  transform: translateX(-50%);
  display: none;        /* Ø¨Ø¯Ù„ flex */
  gap: 12px;
  z-index: 250;
}

#building-bottom-actions button {
  min-width: 120px;
  padding: 10px 16px;
  border-radius: 14px;
  border: none;
  font-weight: bold;
  font-size: 13px;
  cursor: pointer;
  box-shadow: 0 8px 20px rgba(0,0,0,0.6);
}
#bottom-info-btn {
  background: rgba(15,23,42,0.95);
  color: #e5e7eb;
  border: 2px solid #64748b;
}

#bottom-upgrade-btn {
  background: linear-gradient(135deg, #f97316, #facc15);
  color: #111827;
  border: 2px solid #facc15;
}
#building-bottom-actions button:hover {
  transform: translateY(-2px);
}

.building-action-card {
  min-width: 120px;
  padding: 8px 10px;
  border-radius: 14px;
  border: none;
  cursor: pointer;
  box-shadow: 0 10px 20px rgba(0,0,0,0.7);
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 4px;
}

/* ÙƒØ§Ø±Øª INFO Ø£Ø¨ÙŠØ¶ */
#bottom-info-btn {
  background: #ffffff;
  color: #020617;
  border: 2px solid #ffffff;
}

/* ÙƒØ§Ø±Øª UPGRADE Ø°Ù‡Ø¨ÙŠ */
#bottom-upgrade-btn {
  background: linear-gradient(135deg, #f97316, #facc15);
  color: #111827;
  border: 2px solid #facc15;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© Ø¯Ø§Ø¦Ø±ÙŠØ© */
.ba-icon {
  width: 32px;
  height: 32px;
  border-radius: 999px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 18px;
}

/* Ø£ÙŠÙ‚ÙˆÙ†Ø© INFO ØªØ§Ø®Ø¯ Ù„ÙˆÙ† Ø§Ù„Ù…Ø±Ø¨Ø¹ Ø§Ù„Ø¹Ù„ÙˆÙŠ (ØºØ§Ù…Ù‚) */
.ba-icon-info {
  background: #020617;
  border: 2px solid #020617;
  color: #ffffff;
}
/* Ø¯Ø§Ø¦Ø±Ø© Ø§Ù„Ø£Ø³Ù‡Ù… Ù†ÙØ³ Ù„ÙˆÙ† Ù…Ø±Ø¨Ø¹ INFO (ØºØ§Ù…Ù‚) */
.ba-icon-upgrade {
  background: #020617;
  color: #facc15;
}

/* Ø§Ù„Ø³Ø¹Ø± ÙÙˆÙ‚ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© */
.ba-price {
  font-size: 12px;
  color: #facc15;
  font-weight: bold;
}

/* Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø²Ø± ØªØ­Øª */
.ba-label {
  font-size: 11px;
  font-weight: bold;
}
/* Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª */
.right-options {
  position: absolute;
  top: 50%;
  right: 60px;
  transform: translateY(-50%) translateX(20px);
  display: flex;
  flex-direction: column;
  gap: 10px;
  opacity: 0;
  pointer-events: none;
  transition: opacity 0.25s ease, transform 0.25s ease;
}

.right-options.open {
  opacity: 1;
  pointer-events: auto;
  transform: translateY(-50%) translateX(0);
}

/* Ø§Ù„Ø¯ÙˆØ§Ø¦Ø± */
.icon-circle {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  border: 1px solid #fff;
  background: rgba(0, 0, 0, 0.7);
  color: #fff;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
}

.icon-circle span {
  font-size: 18px;
}
.building-highlight {
  box-shadow: 0 0 0 3px #facc15;
  border-radius: 12px;
}
.building-upgrade-time {
  font-family: "Courier New", monospace;
  font-size: 11px;
  letter-spacing: 1px;
  color: #1e90ff; /* Ø£Ø²Ø±Ù‚ */
  text-shadow:
    0 0 4px rgba(30, 144, 255, 0.9),
    0 0 8px rgba(30, 144, 255, 0.7),
    0 0 12px rgba(30, 144, 255, 0.5);
  text-align: center;
  pointer-events: none;
}



      /* Top bar */
      #top-bar {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 80px;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        gap: 15px;
        padding: 0 15px;
        z-index: 100;
      }
      #player-avatar {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid gold;
      }
      #resources {
        display: flex;
        gap: 10px;
        font-size: 13px;
      }
      /* Bottom bar */
 #bottom-bar {
  position: absolute;
  bottom: 0;
  left: 0;
  width: 100%;
  height: 60px;
  background: linear-gradient(to top, rgba(15, 23, 42, 0.95), rgba(15, 23, 42, 0.6));
  backdrop-filter: blur(10px);
  display: flex;
  justify-content: space-around;
  align-items: center;
  z-index: 100;
  border-top: 1px solid rgba(148, 163, 184, 0.4);
}


 .bar-item {
  text-align: center;
  cursor: pointer;
  user-select: none;
  color: #e5e7eb;
  font-size: 11px;
  padding: 4px 10px;
  border-radius: 14px;
  transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
}

.bar-item-active {
  background: linear-gradient(135deg, #0ea5e9, #22c55e);
  color: #0b1120;
  box-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
}

.bar-item-active span {
  color: #0b1120;
}


.bar-item:hover {
  background: rgba(148, 163, 184, 0.15);
  transform: translateY(-2px);
}

.bar-item span {
  display: block;
  font-size: 20px;
  margin-bottom: 2px;
}
.tasks-tab-btn {
  flex: 1;
  padding: 6px 0;
  border-radius: 999px;
  border: none;
  background: rgba(15, 23, 42, 0.9);
  color: #e5e7eb;
  font-size: 12px;
  cursor: pointer;
}

.tasks-tab-active {
  background: #0ea5e9;
  color: #0b1120;
  font-weight: bold;
}

      /* Invite */
      #invite-btn {
        position: fixed;
        right: 12px;
        bottom: 90px;
        width: 55px;
        height: 55px;
        background: #c62828;
        border-radius: 14px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 26px;
        cursor: pointer;
        z-index: 150;
      }
      .full-page {
        position: fixed;
        inset: 0;
        background: #1b1b1b;
        display: flex;
        flex-direction: column;
        z-index: 200;
      }
      .hidden {
        display: none;
      }
      .page-header {
        height: 55px;
        background: #8e0000;
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0 15px;
      }
      .page-header span {
        font-weight: bold;
        font-size: 18px;
      }
      .page-header button {
        background: none;
        border: none;
        color: white;
        font-size: 22px;
        cursor: pointer;
      }
      .page-sub {
        background: #b71c1c;
        text-align: center;
        padding: 8px;
        font-weight: bold;
      }
      .page-content {
        flex: 1;
        padding: 15px;
        overflow-y: auto;
      }
      /* Profile */
      #stats-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.95);
        z-index: 300;
        justify-content: flex-start;
        align-items: center;
        overflow-y: auto;
        padding-top: 20px;
      }
      #stats-content {
        background: #fff;
        padding: 20px;
        border-radius: 15px;
        width: 90%;
        max-width: 400px;
        margin: auto;
        color: #000;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        text-align: center;
      }
      #stats-content .hero-img img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        cursor: pointer;
        border: 3px solid gold;
      }
      #stats-content .profile-name {
        font-size: 18px;
        font-weight: bold;
        margin: 10px 0;
      }
      #stats-content .profile-sub {
        font-size: 14px;
        color: #333;
        margin-bottom: 10px;
      }
      .army-card {
        border: 1px solid #ccc;
        border-radius: 10px;
        padding: 8px;
        margin: 8px 0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #f9f9f9;
      }
      .army-card span {
        margin: 0 5px;
        font-weight: bold;
      }
      #stats-content button {
        margin-top: 15px;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        background: #007bff;
        color: white;
        cursor: pointer;
      }
      #stats-content button:hover {
        background: #0056b3;
      }
      /* Castle */
      #castle-modal {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(255, 255, 255, 0.95);
        z-index: 350;
        overflow-y: auto;
        padding-top: 20px;
        justify-content: flex-start;
        align-items: center;
      }
      #castle-content {
        background: #fff;
        width: 90%;
        max-width: 500px;
        margin: auto;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.3);
        color: #000;
      }
      #castle-content h2 {
        text-align: center;
        margin-bottom: 15px;
      }
      #castle-content .castle-info {
        display: flex;
        gap: 15px;
        align-items: center;
        margin-bottom: 15px;
      }
      #castle-content .castle-info img {
        width: 100px;
        height: 100px;
        border-radius: 10px;
      }
      #castle-content .castle-text {
        flex: 1;
      }
      #castle-content button {
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        background: #007bff;
        color: white;
        cursor: pointer;
        margin-top: 10px;
      }
      #castle-content button:hover {
        background: #0056b3;
      }
      .progress-bar-container {
        width: 100%;
        height: 25px;
        background: #ccc;
        border-radius: 12px;
        overflow: hidden;
        margin-top: 10px;
      }
      .progress-bar-fill {
        height: 100%;
        width: 0%;
        background: #007bff;
        text-align: center;
        color: white;
        line-height: 25px;
        font-weight: bold;
      }
      /* Hero Selection */
      #hero-selection {
        position: fixed;
        inset: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        background: rgba(0, 0, 0, 0.8);
        z-index: 400;
      }
      #hero-selection > div {
        text-align: center;
        background: white;
        padding: 20px;
        border-radius: 15px;
        max-width: 350px;
        width: 90%;
      }
      #hero-selection img {
        cursor: pointer;
        border: 2px solid gold;
        border-radius: 50%;
      }
      #hero-selection.hidden {
        display: none;
      }
      #hero-selection h3 {
        margin: 0 0 10px 0;
      }
      #hero-selection button {
        margin-top: 15px;
        padding: 8px 15px;
        border: none;
        border-radius: 10px;
        background: #007bff;
        color: white;
        cursor: pointer;
      }
      /* Task Page */
      .task-item {
        background: rgba(255, 255, 255, 0.1);
        margin: 5px 0;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
      }
      .task-item.completed {
        text-decoration: line-through;
        color: #0f0;
      }

      /* ======================================================
         ORIGINAL CSS (UNCHANGED)
         ====================================================== */
      html,
      body {
        margin: 0;
        padding: 0;
        width: 100%;
        height: 100%;
        font-family: Arial, sans-serif;
        background: #0b1220;
        color: white;
        overflow: hidden;
      }

      /* ======================================================
         ADDED BY CHATGPT - UI VARIABLES
         ====================================================== */
      :root {
        --panel-bg: rgba(30, 41, 59, 0.85);
        --gold: #facc15;
        --accent: #38bdf8;
      }

      /* ======================================================
         ADDED BY CHATGPT - PROFILE WRAPPER
         ====================================================== */
      .profile-wrapper {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 6px 10px;
        border-radius: 14px;
        cursor: pointer;
        transition: 0.3s;
      }

      .profile-wrapper:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: scale(1.05);
      }

      .profile-wrapper:hover img {
        box-shadow: 0 0 15px rgba(250, 204, 21, 0.8);
        transform: scale(1.1);
      }

      /* ======================================================
         ADDED BY CHATGPT - RESOURCE BOX STYLE
         ====================================================== */
      #resources div {
        background: var(--panel-bg);
        padding: 6px 10px;
        border-radius: 12px;
        min-width: 55px;
        text-align: center;
        transition: 0.25s;
      }

      #resources div:hover {
        transform: translateY(-3px) scale(1.05);
        box-shadow: 0 0 10px rgba(56, 189, 248, 0.6);
      }

      /* ======================================================
         ADDED BY CHATGPT - MENU BUTTON & DROPDOWN
         ====================================================== */
     #menu-btn {
  font-size: 26px;
  cursor: pointer;
  margin-left: 10px;
  user-select: none;
  padding: 8px 12px;
  border-radius: 10px;
  position: relative;   /* Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ù‡Ù… */
  z-index: 10001;       /* Ø£Ø¹Ù„Ù‰ Ù…Ù† 9999 Ø¨ØªØ§Ø¹ Ø§Ù„Ø¨Ø§Ù†Ù„Ø§Øª */
}


      #menu-btn:active {
      background: rgba(255, 255, 255, 0.15);
      }

      #menu-dropdown {
        display: none;
        position: absolute;
        top: 85px;
        right: 15px;
        background: var(--panel-bg);
        border-radius: 14px;
        padding: 10px;
        width: 180px;
        z-index: 300;
      }

      .menu-item {
        padding: 8px;
        border-radius: 8px;
        cursor: pointer;
        transition: 0.2s;
      }

      .menu-item:hover {
        background: rgba(255, 255, 255, 0.1);
      }
          #settings-screen {
      position: fixed;
      inset: 0;
      background: #0b1220;
      z-index: 1000;
      display: none;
      flex-direction: column;
    }

    .settings-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 18px;
      font-size: 20px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .settings-header button {
      background: none;
      border: none;
      color: white;
      font-size: 22px;
    }

    .settings-content {
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .setting-item {
      background: rgba(255,255,255,0.08);
      padding: 14px;
      border-radius: 14px;
      font-size: 18px;
}

/* ===== Chat Panel between top and bottom bars ===== */
#chat-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 80%;
  max-width: 400px;
  height: 60%;
  background: #020617;
  border: 2px solid #facc15;
  border-radius: 16px;
  padding: 10px;
  z-index: 10000;
  display: none;
  flex-direction: column;
  box-shadow: 0 10px 30px rgba(0,0,0,0.7);
}

#chat-panel.chat-hidden {
  display: none;
}

#chat-panel.chat-visible {
  display: flex;
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± + Ø§Ù„Ø³Ù‡Ù… + Ø§Ù„ØªØ§Ø¨Ø§Øª */
.chat-header {
  display: flex;
  align-items: center;
  padding: 6px 10px;
  border-bottom: 1px solid rgba(148, 163, 184, 0.4);
  gap: 8px;
}

.chat-back-btn {
  background: none;
  border: none;
  color: #fff;
  font-size: 22px;
  cursor: pointer;
  padding: 4px 6px;
}

.chat-tabs {
  display: flex;
  flex: 1;
  gap: 6px;
}

.chat-tab {
  flex: 1;
  background: rgba(30, 41, 59, 0.9);
  border: none;
  border-radius: 999px;
  color: #e5e7eb;
  font-size: 12px;
  padding: 6px 4px;
  cursor: pointer;
  white-space: nowrap;
}

.chat-tab.active {
  background: #0ea5e9;
  color: #0b1120;
  font-weight: bold;
}

/* Ø¬Ø³Ù… Ø§Ù„Ø´Ø§Øª */
.chat-body {
  flex: 1;
  padding: 8px;
  overflow-y: auto;
}

.chat-messages {
  height: 100%;
  overflow-y: auto;
  font-size: 13px;
}

.chat-message {
  margin-bottom: 6px;
  line-height: 1.4;
}

.chat-message.me {
  text-align: right;
  color: #facc15;
}

.chat-message.system {
  text-align: center;
  color: #f97316;
}

/* Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ */
.chat-input-row {
  display: flex;
  padding: 8px;
  gap: 6px;
  border-top: 1px solid rgba(148, 163, 184, 0.4);
}

#chat-input {
  flex: 1;
  border-radius: 999px;
  border: 1px solid rgba(148, 163, 184, 0.6);
  background: rgba(15, 23, 42, 0.9);
  color: #fff;
  padding: 6px 10px;
  outline: none;
  font-size: 13px;
}

#chat-send-btn {
  border: none;
  border-radius: 999px;
  padding: 6px 10px;
  background: #0ea5e9;
  color: #0b1120;
  cursor: pointer;
  font-size: 13px;
}

/* Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ø³ØªØ®Ø¯Ø§Ù… class Ù…Ø®ÙÙŠ */
.chat-hidden {
  display: none;
}
.chat-message {
  margin-bottom: 6px;
  font-size: 13px;
}

/* ÙŠØ®Ù„ÙŠ Ø§Ù„ØµÙˆØ±Ø© + Ø§Ù„Ø§Ø³Ù… + Ø§Ù„ÙÙ‚Ø§Ø¹Ø© ÙÙŠ ØµÙ ÙˆØ§Ø­Ø¯ */
.chat-msg-row {
  display: flex;
  align-items: center;
  gap: 8px;
}

/* ØµÙˆØ±Ø© + Ø§Ø³Ù… ÙÙˆÙ‚ Ø¨Ø¹Ø¶Ù‡Ø§ */
.chat-user {
  display: flex;
  flex-direction: column; /* Ø§Ù„Ø§Ø³Ù… ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø© */
  align-items: center;
  cursor: pointer;
}

/* ØªÙƒØ¨ÙŠØ±/ØªØµØºÙŠØ± Ø§Ù„ØµÙˆØ±Ø© ÙˆØªØ¯ÙˆÙŠØ±Ù‡Ø§ */
.chat-avatar {
  width: 40px;
  height: 40px;
  border-radius: 50%;      /* Ù…Ø¯ÙˆÙ‘Ø±Ø© */
  border: 2px solid #facc15;
  object-fit: cover;       /* ØªÙ‚Øµ Ø§Ù„ØµÙˆØ±Ø© ØµØ­ */
}

/* Ø§Ù„Ø§Ø³Ù… ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø© */
.chat-name {
  font-size: 11px;
  color: #e5e7eb;
  margin-top: 2px;
  text-align: center;
}

/* Ø§Ù„ÙÙ‚Ø§Ø¹Ø© Ø§Ù„Ù„ÙŠ ÙÙŠÙ‡Ø§ Ø§Ù„ÙƒÙ„Ø§Ù… */
.chat-bubble {
  background: rgba(30, 64, 175, 0.9);
  border-radius: 10px;
  padding: 4px 8px;
  max-width: 75%;
}

.chat-text {
  font-size: 13px;
  color: #f9fafb;
}
#tutorial-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.7);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999;
}

#tutorial-box {
  background: #020617;
  border-radius: 16px;
  padding: 16px 20px;
  max-width: 320px;
  color: #f9fafb;
  text-align: center;
  border: 2px solid #facc15;
  box-shadow: 0 0 20px rgba(250, 204, 21, 0.3);
}

#tutorial-text {
  font-size: 14px;
  line-height: 1.6;
}

#tutorial-next {
  margin-top: 12px;
  padding: 8px 20px;
  border-radius: 999px;
  border: none;
  background: #facc15;
  color: #111827;
  font-weight: bold;
  cursor: pointer;
}

/* Castle Panel Ø¨ÙŠÙ† Ø§Ù„Ù€ top-bar ÙˆØ§Ù„Ù€ bottom-bar */
/* Castle Panel Ø¨ÙŠÙ† Ø§Ù„Ù€ top-bar ÙˆØ§Ù„Ù€ bottom-bar */
#castle-panel {
  position: absolute;
  left: 0;
  right: 0;
  top: 80px;   /* Ù†ÙØ³ Ø§Ø±ØªÙØ§Ø¹ game-page-panel */
  bottom: 70px;/* ÙÙˆÙ‚ Ø§Ù„Ù€ bottom bar */
  background: rgba(0, 0, 0, 0.7);
  z-index: 260; /* Ø£Ø¹Ù„Ù‰ Ø´ÙˆÙŠØ© Ù…Ù† ØµÙØ­Ø§Øª Ø§Ù„Ø¬ÙŠÙ… Ø§Ù„Ù„ÙŠ z-index=240 */
  color: #fff;
  padding: 10px;
  box-sizing: border-box;
}

#castle-panel.castle-hidden {
  display: none;
}

#castle-panel.castle-visible {
  display: block;
}
/* Ù‡ÙŠØ¯Ø± Castle Panel */
.castle-panel-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding-bottom: 6px;
  border-bottom: 1px solid rgba(148, 163, 184, 0.4);
}

.castle-back-btn {
  background: none;
  border: none;
  color: #fff;
  font-size: 22px;
  cursor: pointer;
  padding: 4px 6px;
}

.castle-title {
  font-size: 16px;
  font-weight: bold;
}

.castle-panel-body {
  margin-top: 6px;
  font-size: 14px;
}
/* ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¹Ø© */
.castle-tabs {
  display: flex;
  gap: 6px;
  margin-bottom: 8px;
}

.castle-tab-button {
  flex: 1;
  border: none;
  border-radius: 999px;
  background: rgba(30, 41, 59, 0.9);
  color: #e5e7eb;
  font-size: 13px;
  padding: 6px 4px;
  cursor: pointer;
}

.castle-tab-button.active {
  background: #0ea5e9;
  color: #0b1120;
  font-weight: bold;
}

/* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ */
.castle-tab-content {
  display: none;
}

.castle-tab-content.active {
  display: block;
}

/* ØµÙ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª/ØªÙƒÙ„ÙØ© */
.castle-info-row {
  display: flex;
  justify-content: space-between;
  padding: 6px 4px;
  margin-bottom: 4px;
  background: rgba(15, 23, 42, 0.9);
  border-radius: 8px;
  font-size: 13px;
}

/* Ø²Ø± Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ© */
.castle-upgrade-btn {
  width: 100%;
  margin-top: 8px;
  padding: 8px 0;
  border: none;
  border-radius: 10px;
  background: #0ea5e9;
  color: #0b1120;
  font-weight: bold;
  cursor: pointer;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… */
.castle-progress-wrapper {
  margin-top: 10px;
}

.castle-progress-bar {
  width: 100%;
  height: 10px;
  background: rgba(148, 163, 184, 0.4);
  border-radius: 999px;
  overflow: hidden;
}

.castle-progress-fill {
  width: 0%;
  height: 100%;
  background: #22c55e;
}

.castle-progress-time {
  margin-top: 4px;
  font-size: 12px;
  text-align: center;
}


  .hidden {
    display: none !important;
  }
  /* Resource Shop between top and bottom bars */
#resource-shop-panel {
  position: absolute;
  left: 0;
  right: 0;
  top: 80px;    /* Ù†ÙØ³ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù€ top-bar */
  bottom: 70px; /* Ù†ÙØ³ Ø§Ø±ØªÙØ§Ø¹ Ø§Ù„Ù€ bottom-bar */
  background: rgba(15, 23, 42, 0.97);
  z-index: 260;
  display: flex;
  flex-direction: column;
}

#resource-shop-panel.hidden {
  display: none;
}

#resource-shop-panel .page-header {
  height: 55px;
  background: #8e0000;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 15px;
}

#resource-shop-panel .page-sub {
  background: #b71c1c;
  text-align: center;
  padding: 8px;
  font-weight: bold;
}

#resource-shop-panel .page-content {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
}
/* === Unified game pages between top (80px) and bottom (70px) === */
.game-page-panel {
  position: absolute;
  left: 0;
  right: 0;
  top: 80px;   /* ØªØ­Øª Ø§Ù„Ù€ top-bar */
  bottom: 70px;/* ÙÙˆÙ‚ Ø§Ù„Ù€ bottom-bar */
  background: rgba(15, 23, 42, 0.97);
  z-index: 240;
  display: flex;
  flex-direction: column;
}

/* Ø§Ù„Ù„ÙŠ Ù…Ù‚ÙÙˆÙ„ */
.game-page-hidden {
  display: none !important;
}

/* Ù†Ø­Ø³Ù‘Ù† ØµÙØ­Ø§Øª Ø§Ù„Ù€ header/sub/content Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ */
.game-page-panel .page-header {
  height: 55px;
  background: #8e0000;
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 15px;
}

.game-page-panel .page-sub {
  background: #b71c1c;
  text-align: center;
  padding: 8px;
  font-weight: bold;
}

.game-page-panel .page-content {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
}
/* Profile card styling */
.profile-card {
  background: rgba(15, 23, 42, 0.95);
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 0 18px rgba(0, 0, 0, 0.6);
  border: 1px solid rgba(248, 250, 252, 0.06);
}

.profile-card-top {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 12px;
}

.profile-hero-wrapper {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 3px solid #facc15;
  overflow: hidden;
  box-shadow: 0 0 15px rgba(250, 204, 21, 0.7);
}

.profile-hero-wrapper img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  cursor: pointer;
}

.profile-main-info .profile-name {
  font-size: 18px;
  font-weight: bold;
}

.profile-main-info .profile-meta {
  font-size: 13px;
  color: #e5e7eb;
  margin-top: 2px;
}

.profile-main-info .profile-sub {
  font-size: 12px;
  color: #9ca3af;
  margin-top: 4px;
}

.profile-stats-grid {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  margin-top: 10px;
}

.profile-stat {
  background: rgba(15, 23, 42, 0.9);
  border-radius: 10px;
  padding: 6px 8px;
  text-align: center;
  border: 1px solid rgba(148, 163, 184, 0.4);
}

.profile-stat .label {
  font-size: 11px;
  color: #9ca3af;
}

.profile-stat .value {
  font-size: 15px;
  font-weight: bold;
  color: #f9fafb;
}
.profile-army {
  margin-top: 12px;
  background: rgba(15, 23, 42, 0.9);
  border-radius: 12px;
  padding: 10px 12px;
  border: 1px solid rgba(148, 163, 184, 0.4);
}

.profile-army-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 6px;
  font-size: 13px;
  font-weight: bold;
}

.profile-army-note {
  font-size: 11px;
  color: #9ca3af;
}
.army-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
  margin-top: 6px;
}

.army-slot {
  background: rgba(15, 23, 42, 0.95);
  border-radius: 10px;
  padding: 6px 4px;
  text-align: center;
  border: 1px solid rgba(55, 65, 81, 0.9);
}

.army-slot-icon {
  width: 34px;
  height: 34px;
  margin: 0 auto 4px auto;
  border-radius: 8px;
  background: rgba(31, 41, 55, 0.9);
  border: 1px dashed rgba(148, 163, 184, 0.8);
  background-size: cover;
  background-position: center;
}


.army-slot-count {
  font-size: 12px;
  color: #e5e7eb;
  font-weight: bold;
}

.profile-heroes {
  margin-top: 12px;
  background: rgba(15, 23, 42, 0.9);
  border-radius: 12px;
  padding: 10px 12px;
  border: 1px solid rgba(148, 163, 184, 0.4);
}

.profile-heroes-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
  font-size: 13px;
  font-weight: bold;
}

.profile-heroes-note {
  font-size: 11px;
  color: #9ca3af;
}

.heroes-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 8px;
}

.hero-slot {
  background: rgba(15, 23, 42, 0.95);
  border-radius: 10px;
  padding: 6px 4px;
  text-align: center;
  border: 1px solid rgba(55, 65, 81, 0.9);
}

.hero-slot-avatar {
  width: 40px;
  height: 40px;
  margin: 0 auto 4px auto;
  border-radius: 8px;
  background: rgba(31, 41, 55, 0.9);
  border: 1px dashed rgba(148, 163, 184, 0.8);
}

/* === Resource Shop Buttons Styling by type === */
.resource-pack-btn {
  width: 100%;
  margin: 6px 0;
  padding: 10px 12px;
  border-radius: 10px;
  border: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  cursor: pointer;
  font-weight: bold;
  font-size: 14px;
  transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.15s ease;
}

.resource-pack-btn > div {
  display: flex;
  flex-direction: column;
  text-align: left;
}

.resource-pack-btn .amount {
  font-size: 12px;
  opacity: 0.9;
}

.resource-pack-btn .price {
  font-size: 14px;
}

/* Ø°Ù‡Ø¨ */
.resource-pack-gold {
  background: linear-gradient(135deg, #a16207, #facc15);
  color: #111827;
  box-shadow: 0 0 10px rgba(250, 204, 21, 0.5);
}

/* Ø®Ø´Ø¨ */
.resource-pack-wood {
  background: linear-gradient(135deg, #14532d, #4ade80);
  color: #ecfdf5;
  box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
}

/* Ù„Ø­Ù… / Ø£ÙƒÙ„ */
.resource-pack-food {
  background: linear-gradient(135deg, #7f1d1d, #f97373);
  color: #fef2f2;
  box-shadow: 0 0 10px rgba(248, 113, 113, 0.5);
}

.resource-pack-btn:hover {
  transform: translateY(-2px) scale(1.02);
  box-shadow: 0 0 12px rgba(148, 163, 184, 0.7);
}

/* Ù†Ø¶Ù…Ù† Ø¥Ù† #resource-shop-panel ÙŠØ³ØªØ®Ø¯Ù… Ù†ÙØ³ Ù…Ø³Ø§Ø­Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© */
#resource-shop-panel {
  position: absolute;
  left: 0;
  right: 0;
  top: 80px;
  bottom: 70px;
  background: rgba(15, 23, 42, 0.97);
  z-index: 260;
  display: flex;
  flex-direction: column;
}

#resource-shop-panel.hidden {
  display: none;
}

    </style>
  </head>
  <body>
    <!-- Loading -->
    <div id="loading1" class="loading-container">
      <img src="background1.png" />
      <div class="loading-bar">
        <div class="loading-fill" id="loading-fill1">0%</div>
      </div>
    </div>

    <!-- Character Selection -->
<div id="character-screen">
  <h2>Choose Your Character</h2>
  <div class="characters">
    <div class="char" onclick="choose('elephant')">
      <img src="elephant.png" />
      <p>Elephant</p>
    </div>
    <div class="char" onclick="choose('tiger')">
      <img src="tiger.png" />
      <p>Tiger</p>
    </div>
    <div class="char" onclick="choose('kong')">
      <img src="kong.png" />
      <p>King Kong</p>
    </div>
  </div>
</div>
<!-- City -->
<div id="city-screen">
<div id="building-bottom-actions">
  <button id="bottom-info-btn" class="building-action-card">
    <div class="ba-icon ba-icon-info">i</div>
    <div class="ba-label">INFO</div>
  </button>

  <button id="bottom-upgrade-btn" class="building-action-card">
    <div class="ba-icon ba-icon-upgrade">
      â†‘â†‘â†‘
    </div>
    <div class="ba-label">UPGRADE</div>
  </button>
</div>


  <!-- Daily Login Banner -->
  <div id="daily-login-banner" class="hidden" style="
    position: absolute;
    top: 80px;
    left: 50%;
    transform: translateX(-50%);
    background: linear-gradient(135deg, #1e293b, #0f172a);
    border: 2px solid #facc15;
    border-radius: 12px;
    padding: 10px 14px;
    width: 90%;
    max-width: 320px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    z-index: 50;
    display: flex;
    align-items: center;
    justify-content: space-between;
  ">
    <div style="display:flex; align-items:center; gap:8px;">
      <span style="font-size:20px;">ğŸ</span>
      <div>
        <div style="font-size:13px; font-weight:bold; color:#facc15;">Daily Login Available!</div>
        <div style="font-size:11px; color:#9ca3af;">Claim your reward now</div>
      </div>
    </div>
    <button onclick="openDailyLoginPage()" style="
      padding: 6px 12px;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #0b1120;
      font-weight: bold;
      font-size: 12px;
      cursor: pointer;
    ">
      Go
    </button>
  </div>

  <!-- Ø¨Ø§Ù‚ÙŠ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© Ù‡Ù†Ø§ -->

  <!-- Chat Panel (Ø§Ù„Ø¬Ø¯ÙŠØ¯) -->
  <div id="chat-panel" class="chat-hidden">
   <div class="chat-header">
  <button class="chat-back-btn">â†</button>
  <div class="chat-tabs">
    <button class="chat-tab active" data-chat="global">Global</button>
    <button class="chat-tab" data-chat="clan">Clan</button>
    <button class="chat-tab" data-chat="friends">Friends</button>
    <button class="chat-tab" data-chat="system">System</button>
  </div>
</div>

<div class="chat-body">
  <div id="chat-global" class="chat-messages"></div>
  <div id="chat-clan" class="chat-messages chat-hidden"></div>
  <div id="chat-friends" class="chat-messages chat-hidden"></div>
  <div id="chat-system" class="chat-messages chat-hidden"></div>
</div>


    <div class="chat-input-row">
      <input id="chat-input" type="text" placeholder="Type a message..." />
      <button id="chat-send-btn">Send</button>
    </div>
  </div>
</div>


    <!-- ======================================================
         ORIGINAL BODY (UNCHANGED)
         ====================================================== -->

    <!-- MENU DROPDOWN -->
    <!-- === ADDED BY CHATGPT === -->
    <div id="menu-dropdown">
      <div class="menu-item">âš™ï¸ Settings</div>
      <div class="menu-item">ğŸ”Š Sound</div>
      <div class="menu-item">ğŸŒ Language</div>
    </div>
<div class="right-arrow-menu">
  <button id="right-arrow-btn" class="right-arrow-btn">
    â¯
  </button>

  <div id="right-options" class="right-options">
    <button class="icon-circle" id="pvp-icon">
      <span>âš”ï¸</span>
    </button>
    <button class="icon-circle" id="chat-icon">
      <span>ğŸ’¬</span>
    </button>
    <button class="icon-circle" id="pass-icon">
      <span>ğŸ«</span>
    </button>
  </div>
</div>

    <!-- Invite -->
    <div id="invite-btn">ğŸ</div>
<div id="invites-page" class="game-page-panel game-page-hidden">
      <div class="page-header">
        <span>Invite Friends</span>
        <button onclick="closeInvites()">â† Back</button>
      </div>
      <div class="page-sub">Invite friends and earn rewards!</div>
      <div class="page-content">
        <div
          id="invite-code-container"
          style="text-align: center; margin: 20px 0"
        >
          <p style="font-weight: bold">Share this link:</p>
          <input
            type="text"
            id="invite-link"
            readonly
            style="
              width: 80%;
              padding: 10px;
              font-size: 16px;
              border-radius: 8px;
              text-align: center;
            "
          />
          <br /><br />
          <button
            onclick="copyInviteLink()"
            style="
              padding: 10px 20px;
              border: none;
              border-radius: 8px;
              background: #007bff;
              color: white;
              cursor: pointer;
            "
          >
            Copy Link
          </button>
          <p
            id="invite-msg"
            style="margin-top: 10px; color: #0f0; font-weight: bold"
          ></p>
        </div>
        <div id="invited-friends-container" style="padding: 0 15px">
          <h4>Friends Joined:</h4>
          <ul
            id="invited-friends-list"
            style="
              list-style: none;
              padding-left: 0;
              max-height: 200px;
              overflow-y: auto;
            "
          ></ul>
        </div>
      </div>
    </div>

    <!-- Profile Page (Unified Panel) -->
<div id="stats-page" class="game-page-panel game-page-hidden">
  <div class="page-header">
    <span>Profile</span>
    <button onclick="closeStats()">Ã—</button>
  </div>

  <div class="page-sub">Your hero, power and progress</div>

  <div class="page-content">
    <div class="profile-card">
      <div class="profile-card-top">
        <div class="profile-hero-wrapper">
          <img
            id="profile-hero-img"
            src="elephant.png"
            alt="Hero"
            onclick="changeHero()"
          />
        </div>
        <div class="profile-main-info">
          <div class="profile-name" id="profile-name">Player</div>
          <div class="profile-meta" id="profile-meta">
            Castle Lv. 1 â€¢ Power 0
          </div>
          <div class="profile-sub" id="profile-sub">
            Joined: 0 days | Clan: None
          </div>
        </div>
      </div>

        <div class="profile-stats-grid">
        <div class="profile-stat">
          <div class="label">Castle</div>
          <div class="value" id="profile-castle-level">1</div>
        </div>
        <div class="profile-stat">
          <div class="label">Buildings</div>
          <div class="value" id="profile-buildings-level">0</div>
        </div>
        <div class="profile-stat">
          <div class="label">Power</div>
          <div class="value" id="profile-power">0</div>
        </div>
      </div>

      <!-- Army grid -->
<div class="profile-army-header">
  <span>Army</span>
  <span class="profile-army-note">
    ATK <span id="profile-attack">0</span>
    HP <span id="profile-hp">0</span>
  </span>
</div>



  <div class="army-grid">
    <!-- 12 Ø£Ù…Ø§ÙƒÙ† Ø¬Ù†ÙˆØ¯ -->
    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>
    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>
    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>
    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>

    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>
    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>
    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>
    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>

    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>
    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>
    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>
    <div class="army-slot"><div class="army-slot-icon"></div><div class="army-slot-count">0</div></div>
  </div>
</div>

      <!-- Heroes owned grid -->
<div class="profile-heroes">
  <div class="profile-heroes-header">
    <span>Heroes</span>
    <span class="profile-heroes-note">Tap a hero to view</span>
  </div>

  <div class="heroes-grid">
    <!-- 12 Ø£Ù…Ø§ÙƒÙ† Ø£Ø¨Ø·Ø§Ù„ (Ù†Ù…Ù„Ø£Ù‡Ù… Ø¨Ø¹Ø¯ÙŠÙ† Ù…Ù† Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª) -->
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
    <div class="hero-slot"><div class="hero-slot-avatar"></div></div>
  </div>
</div>
  <div id="army-container" style="display: none;"></div>
<button onclick="closeStats()" style="margin-top: 16px; width: 100%;">


  â† Back
</button>

  </div>
</div>



    <!-- Hero Selection Modal -->
    <div id="hero-selection" class="hidden">
      <div>
        <h3>Select Your Hero</h3>
        <div
          style="display: flex; justify-content: space-around; margin-top: 15px"
        >
          <img
            src="elephant.png"
            width="80"
            height="80"
            onclick="selectHero('elephant')"
          />
          <img
            src="tiger.png"
            width="80"
            height="80"
            onclick="selectHero('tiger')"
          />
          <img
            src="kong.png"
            width="80"
            height="80"
            onclick="selectHero('kong')"
          />
        </div>
        <button onclick="closeHeroSelection()">Cancel</button>
      </div>
    </div>
<!-- Resource Shop Panel Ø¨ÙŠÙ† Ø§Ù„Ù€ top-bar ÙˆØ§Ù„Ù€ bottom-bar -->
<div id="resource-shop-panel" class="game-page-panel game-page-hidden">
  <div class="page-header">
    <span id="resource-shop-title">Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯</span>
    <button onclick="closeResourceShop()">âœ–</button>
  </div>
  <div class="page-sub" id="resource-shop-sub">
    Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø© Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„ØªÙŠ ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡Ù‡Ø§ Ø¨Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±
  </div>
  <div class="page-content" id="resource-shop-content">
    <!-- Ø§Ù„Ø¨Ø§Ù‚Ø§Øª Ù‡ØªØªÙˆÙ„Ø¯ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ Ù…Ù† JavaScript -->
  </div>
</div>

<!-- Tasks Page -->
<div id="tasks-page" class="game-page-panel game-page-hidden">
  <div class="page-header" style="display:flex; align-items:center; justify-content:space-between;">
    <button class="back-btn" onclick="closeTasksPage()">â†</button>
    <span style="flex:1; text-align:center;">Daily Tasks</span>
    <button id="daily-login-icon-btn" onclick="openDailyLoginPage()" style="
      background: transparent;
      border: 2px solid #facc15;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      font-size: 18px;
      cursor: pointer;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    ">
      ğŸ
    </button>
  </div>
  <div class="page-sub">Complete tasks and earn rewards!</div>

  <div class="page-content">
    <!-- Tabs -->
    <div style="display:flex; gap:6px; margin-bottom:10px;">
      <button class="tasks-tab-btn tasks-tab-active" id="tasks-tab-main" data-tab="main" onclick="switchTasksTab('main')">Main</button>
      <button class="tasks-tab-btn" id="tasks-tab-daily" data-tab="daily" onclick="switchTasksTab('daily')">Daily</button>
      <button class="tasks-tab-btn" id="tasks-tab-weekly" data-tab="weekly" onclick="switchTasksTab('weekly')">Weekly</button>
      <button class="tasks-tab-btn" id="tasks-tab-social" data-tab="social" onclick="switchTasksTab('social')">Social</button>
    </div>

    <!-- Ù‡Ù†Ø§ Ù‡Ù†Ø±Ù†Ø¯Ø± Ø§Ù„Ù…Ù‡Ø§Ù… Ø­Ø³Ø¨ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ -->
    <div id="tasks-page-content">
      <!-- Ø§Ù„Ù…Ù‡Ø§Ù… Ø³ÙŠØªÙ… ÙˆØ¶Ø¹Ù‡Ø§ Ù‡Ù†Ø§ -->
    </div>
  </div>
</div>

<!-- Daily Login Page -->
<div id="daily-login-page" class="game-page-panel game-page-hidden">
  <div class="page-header">
    <button class="back-btn" onclick="closeDailyLoginPage()">â†</button>
    <span>Daily Login Rewards</span>
  </div>
  
  <div class="page-content" style="padding: 10px;">
    <div style="text-align:center; margin-bottom:12px;">
      <div style="font-size:14px; font-weight:bold; color:#facc15;">Login every day to claim rewards!</div>
      <div id="daily-login-streak" style="font-size:12px; color:#9ca3af; margin-top:4px;">
        Streak: 0 days
      </div>
    </div>

    <!-- Ø´Ø¨ÙƒØ© Ø§Ù„Ø£ÙŠØ§Ù… -->
    <div id="daily-login-calendar" style="
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 8px;
      margin-bottom: 60px;
    ">
      <!-- Ù‡Ù†Ø§ Ù‡Ù†ÙˆÙ„Ù‘Ø¯ Ø§Ù„Ù€30 ÙŠÙˆÙ… Ø¨Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
    </div>
  </div>
</div>

<!-- Chest Popup (Daily & Weekly) -->
<div id="chest-popup" class="full-page hidden" style="background: rgba(0,0,0,0.7); z-index: 400;">
  <div style="
    margin: auto;
    background: #020617;
    border-radius: 16px;
    padding: 14px 16px;
    width: 80%;
    max-width: 320px;
    border: 2px solid #facc15;
    color: #e5e7eb;
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
  ">
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div id="chest-title" style="font-weight:bold; font-size:15px;">Chest</div>
      <button onclick="closeChestPopup()" style="
        background: transparent;
        border: none;
        color: #e5e7eb;
        font-size: 18px;
        cursor: pointer;
      ">âœ•</button>
    </div>

    <div id="chest-status" style="font-size:12px; color:#9ca3af; margin-bottom:8px;">
      Reach X points to unlock.
    </div>

    <div style="background: rgba(15,23,42,0.9); border-radius:12px; padding:8px 10px; margin-bottom:10px;">
      <div style="font-size:12px; margin-bottom:4px;">Rewards:</div>
      <div id="chest-rewards" style="display:flex; gap:10px; flex-wrap:wrap; font-size:12px;">
        <!-- rewards icons + amounts -->
      </div>
    </div>

    <button id="chest-claim-btn" onclick="confirmChestClaim()" style="
      width: 100%;
      padding: 8px 0;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #0b1120;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
    ">
      Claim
    </button>
  </div>
</div>

<!-- Daily Login Claim Popup -->
<div id="daily-login-claim-popup" class="full-page hidden" style="background: rgba(0,0,0,0.7); z-index: 400;">
  <div style="
    margin: auto;
    background: #020617;
    border-radius: 16px;
    padding: 16px 18px;
    width: 80%;
    max-width: 320px;
    border: 2px solid #22c55e;
    color: #e5e7eb;
    box-shadow: 0 10px 30px rgba(0,0,0,0.8);
  ">
    <div style="text-align:center; margin-bottom:12px;">
      <div style="font-size:18px; font-weight:bold; color:#22c55e;">ğŸ‰ Day Claimed!</div>
      <div id="daily-login-claim-day" style="font-size:14px; margin-top:4px; color:#9ca3af;">Day X</div>
    </div>

    <div style="background: rgba(15,23,42,0.9); border-radius:12px; padding:10px 12px; margin-bottom:12px;">
      <div style="font-size:12px; margin-bottom:6px; color:#facc15;">You received:</div>
      <div id="daily-login-claim-rewards" style="display:flex; gap:10px; flex-wrap:wrap; font-size:12px;">
        <!-- rewards -->
      </div>
    </div>

    <button onclick="closeDailyLoginClaimPopup()" style="
      width: 100%;
      padding: 10px 0;
      border-radius: 999px;
      border: none;
      background: #22c55e;
      color: #0b1120;
      font-weight: bold;
      font-size: 14px;
      cursor: pointer;
    ">
      Awesome!
    </button>
  </div>
</div>

<!-- Clan Panel Ø¨ÙŠÙ† Ø§Ù„Ù€ top-bar ÙˆØ§Ù„Ù€ bottom-bar -->
<div id="clan-page" class="game-page-panel game-page-hidden">
  <div class="page-header">
    <span id="clan-header-title">Clans</span>
    <button onclick="closeClanPage()">âœ–</button>
  </div>

  <div class="page-sub" id="clan-header-sub">
    Join or create a clan to play with others
  </div>

  <div class="page-content">
    <!-- Ù„Ùˆ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù…Ø´ ÙÙŠ ÙƒÙ„Ø§Ù†: ÙˆØ§Ø¬Ù‡Ø© Guest -->
    <div id="clan-guest-view">
      <!-- Ø²Ø± Ø¥Ù†Ø´Ø§Ø¡ ÙƒÙ„Ø§Ù† ÙÙˆÙ‚ -->
      <div style="margin-bottom: 10px; text-align: right;">
        <button id="clan-create-top-btn"
                style="padding:8px 14px; border:none; border-radius:999px; background:#22c55e; color:#0b1120; font-weight:bold; cursor:pointer; font-size:13px;">
          + Create Clan
        </button>
      </div>

      <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© -->
      <div>
        <h4 style="margin: 0 0 6px 0;">Available Clans</h4>
        <div id="clan-list"
             style="max-height: 260px; overflow-y: auto; padding-right:4px;">
          <!-- Ù‡Ù†Ù…Ù„Ø£Ù‡ Ù…Ù† Ø§Ù„Ø¬Ø§ÙØ§Ø³ÙƒØ±Ø¨Øª -->
        </div>
      </div>
    </div>

    <div id="clan-member-view" style="display:none;">
      <!-- Ù‡ÙŠØ¯Ø± Ø§Ù„ÙƒÙ„Ø§Ù† -->
      <div id="clan-member-header"
           style="padding:10px; margin-bottom:10px; border-radius:10px; background:rgba(15,23,42,0.9); border:1px solid rgba(148,163,184,0.4); font-size:13px;">
        <div id="clan-member-name" style="font-weight:bold; font-size:14px;"></div>
        <div id="clan-member-role" style="color:#9ca3af; margin-top:2px;"></div>
        <div id="clan-member-count" style="color:#9ca3af; margin-top:2px;"></div>
      </div>

      <!-- Ø²Ø± Ø§Ù„Ø®Ø±ÙˆØ¬ Ù…Ù† Ø§Ù„ÙƒÙ„Ø§Ù† -->
      <button id="clan-leave-btn"
              style="padding:6px 12px; border:none; border-radius:999px; background:#ef4444; color:#0b1120; font-size:12px; font-weight:bold; cursor:pointer; margin-bottom:10px;">
        Leave Clan
      </button>

      <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
      <div id="clan-tabs-row"
           style="display:flex; border-bottom:1px solid #374151; margin-bottom:8px; font-size:12px;">
        <button class="clan-tab-btn" data-tab="overview"
                style="flex:1; padding:6px 0; border:none; background:transparent; color:#facc15; font-weight:bold; cursor:pointer;">
          Overview
        </button>
        <button class="clan-tab-btn" data-tab="members"
                style="flex:1; padding:6px 0; border:none; background:transparent; color:#9ca3af; font-weight:bold; cursor:pointer;">
          Members
        </button>
        <button class="clan-tab-btn" data-tab="chat"
                style="flex:1; padding:6px 0; border:none; background:transparent; color:#9ca3af; font-weight:bold; cursor:pointer;">
          Chat
        </button>
        <button class="clan-tab-btn" data-tab="wars"
                style="flex:1; padding:6px 0; border:none; background:transparent; color:#9ca3af; font-weight:bold; cursor:pointer;">
          Wars
        </button>
        <button class="clan-tab-btn" data-tab="settings"
                style="flex:1; padding:6px 0; border:none; background:transparent; color:#9ca3af; font-weight:bold; cursor:pointer;">
          Settings
        </button>
      </div>

      <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
      <div id="clan-tab-overview" class="clan-tab-panel" style="font-size:12px;">
        <div style="margin-bottom:6px; color:#9ca3af;">
          Basic clan stats and info will appear here.
        </div>
        <div id="clan-overview-extra"></div>
      </div>

      <div id="clan-tab-members" class="clan-tab-panel" style="display:none; font-size:12px;">
        Members list and roles will appear here.
      </div>

      <div id="clan-tab-chat" class="clan-tab-panel" style="display:none; font-size:12px;">
        Clan chat integration will appear here.
      </div>

      <div id="clan-tab-wars" class="clan-tab-panel" style="display:none; font-size:12px;">
        Clan wars/raids info will appear here.
      </div>

      <div id="clan-tab-settings" class="clan-tab-panel" style="display:none; font-size:12px;">
        Settings (leader only) will appear here.
      </div>
    </div> <!-- Ù†Ù‡Ø§ÙŠØ© clan-member-view -->
  </div> <!-- Ù†Ù‡Ø§ÙŠØ© page-content -->
</div> <!-- Ù†Ù‡Ø§ÙŠØ© clan-page -->

<!-- Castle Panel (Ø«Ø§Ø¨Øª Ø¨ÙŠÙ† Ø§Ù„Ù€ top-bar Ùˆ bottom-bar) -->
<div id="castle-panel" class="castle-hidden">
  <div class="castle-panel-header">
    <button id="castle-back-btn" class="castle-back-btn" onclick="closeCastlePanel()">â†</button>
    <div class="castle-title">Ø§Ù„Ù‚Ù„Ø¹Ø©</div>
  </div>

  <div class="castle-panel-body">
    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª -->
    <div class="castle-tabs">
      <button class="castle-tab-button active" data-tab="castle-info-tab">Ù…Ø¹Ù„ÙˆÙ…Ø§Øª</button>
      <button class="castle-tab-button" data-tab="castle-upgrade-tab">ØªØ±Ù‚ÙŠØ©</button>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
    <div id="castle-info-tab" class="castle-tab-content active">
      <div class="castle-info-row">
        <span>Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ù„Ø¹Ø©:</span>
        <span id="castle-info-level">1</span>
      </div>
      <div class="castle-info-row">
        <span>Ù‚ÙˆØ© Ø§Ù„Ù‚Ù„Ø¹Ø©:</span>
        <span id="castle-info-power">0</span>
      </div>
      <div class="castle-info-row">
        <span>Ø³Ø¹Ø© Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙƒÙ„ÙŠØ©:</span>
        <span id="castle-info-storage">0</span>
      </div>
    </div>

    <!-- Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØªØ¨ÙˆÙŠØ¨: ØªØ±Ù‚ÙŠØ© -->
    <div id="castle-upgrade-tab" class="castle-tab-content">
      <div class="castle-info-row">
        <span>Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</span>
        <span id="castle-upgrade-current-level">1</span>
      </div>
      <div class="castle-info-row">
        <span>Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</span>
        <span id="castle-upgrade-next-level">2</span>
      </div>

      <div class="castle-info-row">
        <span>ØªÙƒÙ„ÙØ© Ø°Ù‡Ø¨:</span>
        <span id="castle-upgrade-gold-cost">0</span>
      </div>
      <div class="castle-info-row">
        <span>ØªÙƒÙ„ÙØ© Ø®Ø´Ø¨:</span>
        <span id="castle-upgrade-wood-cost">0</span>
      </div>
      <div class="castle-info-row">
        <span>ØªÙƒÙ„ÙØ© Ù„Ø­Ù…:</span>
        <span id="castle-upgrade-food-cost">0</span>
      </div>
      <div class="castle-info-row">
        <span>ÙˆÙ‚Øª Ø§Ù„ØªØ±Ù‚ÙŠØ©:</span>
        <span id="castle-upgrade-time">0 Ø«Ø§Ù†ÙŠØ©</span>
      </div>

      <div id="castle-upgrade-required-buildings"></div>

      <button id="castle-start-upgrade-btn" class="castle-upgrade-btn">
        Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©
      </button>

      <div id="castle-upgrade-progress-wrapper" class="castle-progress-wrapper" style="display:none;">
        <div class="castle-progress-bar">
          <div id="castle-upgrade-progress-fill" class="castle-progress-fill"></div>
        </div>
        <div class="castle-progress-time">
          Ù…ØªØ¨Ù‚Ù: <span id="castle-upgrade-remaining-time">0</span> Ø«
        </div>
        <button id="castle-cancel-upgrade-btn" class="castle-cancel-btn">
          Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©
        </button>
      </div>
    </div> <!-- Ù†Ù‡Ø§ÙŠØ© ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ±Ù‚ÙŠØ© -->
  </div>   <!-- Ù†Ù‡Ø§ÙŠØ© castle-panel-body -->
</div>     <!-- Ù†Ù‡Ø§ÙŠØ© castle-panel -->

<div id="building-panel" class="hidden">
 <div id="building-panel-inner"
     style="
             position: fixed;
         top: 50%;
         left: 50%;
         transform: translate(-50%, -50%);
         width: 80%;
         max-width: 400px;
         background: #020617;
         border: 2px solid #facc15;
         border-radius: 16px;
         padding: 12px;
         z-index: 9999;
         color: #e5e7eb;
         box-shadow: 0 10px 30px rgba(0,0,0,0.7);
       ">

    <!-- Header -->
    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
      <div id="building-panel-title"
           style="font-weight:bold; font-size:18px; text-align:center; flex:1;">
      </div>
      <button id="building-panel-close-btn"
              style="background:transparent; border:none; color:#e5e7eb;
                     font-size:18px; cursor:pointer; margin-left:8px;">
        âœ–
      </button>
    </div>

   <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ§Ø¨Ø§Øª: Ù…Ø¹Ù„ÙˆÙ…Ø§Øª / ØªØ±Ù‚ÙŠØ© -->
<div style="display:flex; margin-bottom:8px; border-bottom:1px solid rgba(148,163,184,0.5);">
  <button id="building-tab-info-btn"
          style="flex:1; padding:6px 0; border:none; background:transparent;
                 color:#facc15; font-weight:bold; cursor:pointer; font-size:13px;">
    Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
  </button>
  <button id="building-tab-upgrade-btn"
          style="flex:1; padding:6px 0; border:none; background:transparent;
                 color:#9ca3af; font-weight:bold; cursor:pointer; font-size:13px;">
    Ø§Ù„ØªØ±Ù‚ÙŠØ©
  </button>
</div>

<!-- ØªØ§Ø¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª -->
<div id="building-tab-info">
  <div style="text-align:center; margin-bottom:8px;">
    <img id="building-panel-image"
         src=""
         alt=""
         style="width:180px;height:180px;border-radius:18px;
                object-fit:cover;border:1px solid rgba(148,163,184,0.8);" />
  </div>

  <div id="building-panel-desc"
       style="margin-bottom:8px; font-size:13px; color:#9ca3af; text-align:center;">
  </div>

  <div style="border-top:1px solid rgba(148,163,184,0.5); margin:8px 0;"></div>

  <div id="building-panel-extra-info"
       style="font-size:13px; text-align:center;"></div>
</div>

<!-- ØªØ§Ø¨ Ø§Ù„ØªØ±Ù‚ÙŠØ© -->
<div id="building-tab-upgrade" style="display:none; font-size:13px;">

  <!-- ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰ + Ø§Ù„Ù„ÙŠÙÙ„ Ø§Ù„Ø­Ø§Ù„ÙŠ/Ø§Ù„ØªØ§Ù„ÙŠ (Ù†ÙØ³ Ù…Ù‚Ø§Ø³ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª) -->
  <div style="text-align:center; margin-bottom:8px;">
    <img id="building-upgrade-image"
         src=""
         alt=""
         style="width:180px;height:180px;border-radius:18px;
                object-fit:cover;border:1px solid rgba(148,163,184,0.8);" />
    <div id="building-upgrade-levels" style="margin-top:4px;"></div>
  </div>

  <!-- ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø§Ù„Ø¥ÙŠÙ…ÙˆØ¬ÙŠ -->
  <div id="building-upgrade-cost" style="margin-bottom:8px;">
    <div class="cost-row" style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
      <span style="font-size:16px;">ğŸª™</span>
      <span>Gold:</span>
      <span id="building-upgrade-gold-cost">0</span>
    </div>

    <div class="cost-row" style="display:flex;align-items:center;gap:6px;margin-bottom:4px;">
      <span style="font-size:16px;">ğŸŒ²</span>
      <span>Wood:</span>
      <span id="building-upgrade-wood-cost">0</span>
    </div>

    <div class="cost-row" style="display:flex;align-items:center;gap:6px;">
      <span style="font-size:16px;">ğŸ–</span>
      <span>Meat:</span>
      <span id="building-upgrade-food-cost">0</span>
    </div>
  </div>

  <!-- ÙˆÙ‚Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© -->
  <div id="building-upgrade-time" style="margin-bottom:8px;"></div>

  <!-- Progress bar + Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ -->
  <div id="building-upgrade-progress-wrapper" style="margin-bottom:8px; display:none;">
    <div style="width:100%; height:8px; background:rgba(148,163,184,0.4); border-radius:999px; overflow:hidden;">
      <div id="building-upgrade-progress-fill" style="width:0%; height:100%; background:#0ea5e9;"></div>
    </div>
    <div style="margin-top:4px; font-size:12px; text-align:center; color:#e5e7eb;">
      <span id="building-upgrade-remaining-time">0</span>
    </div>
  </div>
<button id="building-panel-upgrade-btn"
        style="width:100%; padding:8px; border:none; border-radius:10px;
               background:#0ea5e9; color:#0b1120; font-weight:bold; cursor:pointer; margin-top:4px;">
  ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø¨Ù†Ù‰
</button>

<button id="building-panel-cancel-upgrade-btn"
        style="width:100%; padding:6px; border:none; border-radius:10px;
               background:#ef4444; color:#0b1120; font-weight:bold; cursor:pointer;
               margin-top:4px; display:none;">
  Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©
</button>
</div>


<script>


      // Telegram ready
      Telegram.WebApp.ready();
      Telegram.WebApp.expand();

      /* --- Variables Ø£Ø³Ø§Ø³ÙŠØ© --- */
      const heroes = {
        elephant: { attack: 50, hp: 100 },
        tiger: { attack: 120, hp: 50 },
        kong: { attack: 80, hp: 80 },
      };

      document.addEventListener("click", (e) => {
        const btn = document.getElementById("menu-btn");
        const menu = document.getElementById("menu-dropdown");
        if (!btn || !menu) return;

        if (btn.contains(e.target)) {
          menu.style.display =
            menu.style.display === "block" ? "none" : "block";
        } else if (!menu.contains(e.target)) {
          menu.style.display = "none";
        }
      });
          function openSettings() {
      document.getElementById("settings-screen").style.display = "flex";
    }

    function closeSettings() {
      document.getElementById("settings-screen").style.display = "none";
    }


let currentHero = "";
let resources = { gold: 100000, wood: 100000, food: 1000000, gem: 500 };

let army = [
  {
    name: "Soldier",
    attack: 50,
    defense: 30,
    capacity: 100,
    img: "soldier.png",
  },
];

// ===== Resource Shop (Ø´Ø±Ø§Ø¡ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø¨Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±) =====
const RESOURCE_PACKS = [
  { amount: 15000,   costGem: 35 },
  { amount: 50000,   costGem: 100 },
  { amount: 100000,  costGem: 190 },
  { amount: 200000,  costGem: 260 },
  { amount: 600000,  costGem: 650 },
  { amount: 1200000, costGem: 1100 },
  { amount: 5000000, costGem: 3500 },
  { amount: 15000000, costGem: 10000 },
];



function closeResourceShop() {
  const panel = document.getElementById("resource-shop-panel");
  if (panel) panel.classList.add("hidden");
}

function buyResourcePack(resourceType, amount, gemCost) {
  if (resources.gem < gemCost) {
    alert("Ø§Ù„Ø¬ÙˆØ§Ù‡Ø± ØºÙŠØ± ÙƒØ§ÙÙŠØ©!");
    return;
  }

  // Ø®ØµÙ… Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±
  resources.gem -= gemCost;

  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ÙˆØ±Ø¯ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨
  resources[resourceType] += amount;

  // Ø­ÙØ¸
  saveGameState();

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙÙŠ Ø§Ù„Ù€ top bar
  if (typeof updateTopBar === "function") {
    updateTopBar();
  }

  alert(`ØªÙ… Ø´Ø±Ø§Ø¡ ${amount.toLocaleString()} ${resourceType} Ø¨Ù†Ø¬Ø§Ø­!`);
}

// ---------------- Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ----------------

// Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ (Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ ÙƒÙ„Ù‡ 1)
let goldMineLevel = 1; // Ù…Ø³ØªÙˆÙ‰ Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨
let buildingLevels = {
  goldMine: goldMineLevel,
  woodMine: 1,
  meatFarm: 1,
  school: 1,
  attackTower: 1,
  defenseTower: 1,
  heroesHall: 1,
  market: 1,
  booster: 1,
  hospital: 1
};
// Ø­Ø§Ù„Ø© ØªØ±Ù‚ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ (Ù„ÙƒÙ„ Ù…Ø¨Ù†Ù‰ Ø¹Ù„Ù‰ Ø­Ø¯Ø©)
let buildingUpgrades = {}; // buildingKey => { inProgress, finishAt, totalTime, remainingTime }
let buildingUpgradeInterval = null;

const MINING_BUILDINGS_INFO = {
  goldMine: {
    name: 'Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨',
    image: 'goldmine.png',
    desc: 'Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨ ÙŠØ²ÙŠØ¯ Ø¥Ù†ØªØ§Ø¬ Ø§Ù„Ø°Ù‡Ø¨ ÙÙŠ Ù…Ø¯ÙŠÙ†ØªÙƒ.'
  },
  woodMine: {
    name: 'Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨',
    image: 'woodmine.png',
    desc: 'Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨ ÙŠÙˆÙØ± Ø§Ù„Ø®Ø´Ø¨ Ø§Ù„Ù„Ø§Ø²Ù… Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ÙˆØ¨Ù†Ø§Ø¡ Ø§Ù„Ø¬ÙŠØ´.'
  },
  meatFarm: {
    name: 'Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù…',
    image: 'meatfarm.png',
    desc: 'Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù… ØªÙˆÙØ± Ø§Ù„Ø·Ø¹Ø§Ù… Ø§Ù„Ù„Ø§Ø²Ù… Ù„ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¬Ù†ÙˆØ¯.'
  }
};
// Mining buildings unified config Gold/Wood/Meat
const MININGBUILDINGSCONFIG = {
  goldMine: {
    key: 'goldMine',
    displayName: 'Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨',
    baseCostGold: 100,
    baseCostWood: 50,
    baseCostFood: 0,
    costFactor: 1.4,
    baseTime: 60,
    timeFactor: 1.25,
    baseProduction: 100,
    productionFactor: 1.5,
  },
  woodMine: {
    key: 'woodMine',
    displayName: 'Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨',
    baseCostGold: 80,
    baseCostWood: 0,
    baseCostFood: 40,
    costFactor: 1.4,
    baseTime: 60,
    timeFactor: 1.25,
    baseProduction: 90,
    productionFactor: 1.5,
  },
  meatFarm: {
    key: 'meatFarm',
    displayName: 'Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù…',
    baseCostGold: 70,
    baseCostWood: 40,
    baseCostFood: 0,
    costFactor: 1.4,
    baseTime: 60,
    timeFactor: 1.25,
    baseProduction: 80,
    productionFactor: 1.5,
  },
};

// Helpers for mining buildings (gold/wood/meat)
function calcMiningUpgradeCost(buildingKey, level) {
  const config = MININGBUILDINGSCONFIG[buildingKey];
  if (!config) return { gold: 0, wood: 0, food: 0 };

  const factor = Math.pow(config.costFactor, level - 1);
  return {
    gold: Math.round(config.baseCostGold * factor),
    wood: Math.round(config.baseCostWood * factor),
    food: Math.round(config.baseCostFood * factor),
  };
}

function calcMiningUpgradeTime(buildingKey, level) {
  const config = MININGBUILDINGSCONFIG[buildingKey];
  if (!config) return 0;

  return Math.round(config.baseTime * Math.pow(config.timeFactor, level - 1));
}

function calcMiningProductionPerHour(buildingKey, level) {
  const config = MININGBUILDINGSCONFIG[buildingKey];
  if (!config) return 0;

  return Math.round(config.baseProduction * Math.pow(config.productionFactor, level - 1));
}


// Ø´Ø±ÙˆØ· ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© (Ù…Ø¨Ø¯Ø¦ÙŠÙ‹Ø§ Ù…Ù† 1 -> 10 Ø¨Ø³)
const CASTLE_LEVEL_REQUIREMENTS = {
  2: {
    requiredBuildings: {
      goldMine: 1,
      woodMine: 1,
      meatFarm: 1
    }
  },
  3: {
    requiredBuildings: {
      goldMine: 2,
      woodMine: 2,
      meatFarm: 2,
      school: 1
    }
  },
  4: {
    requiredBuildings: {
      goldMine: 3,
      woodMine: 3,
      meatFarm: 3
    }
  },
  5: {
    requiredBuildings: {
      goldMine: 4,
      woodMine: 4,
      meatFarm: 4,
      school: 2
    }
  },
  6: {
    requiredBuildings: {
      goldMine: 5,
      woodMine: 5,
      meatFarm: 5,
      heroesHall: 1
    }
  },
  7: {
    requiredBuildings: {
      goldMine: 6,
      woodMine: 6,
      meatFarm: 6
    }
  },
  8: {
    requiredBuildings: {
      goldMine: 7,
      woodMine: 7,
      meatFarm: 7,
      school: 3,
      heroesHall: 2
    }
  },
  9: {
    requiredBuildings: {
      goldMine: 8,
      woodMine: 8,
      meatFarm: 8,
      hospital: 1
    }
  },
  10: {
    requiredBuildings: {
      goldMine: 9,
      woodMine: 9,
      meatFarm: 9
    }
  }
};

function canUpgradeCastleTo(nextLevel) {
  const req = CASTLE_LEVEL_REQUIREMENTS[nextLevel];
  if (!req) return true;

  for (const [key, neededLevel] of Object.entries(req.requiredBuildings)) {
    const currentLevel = buildingLevels[key] || 0;
    if (currentLevel < neededLevel) {
      console.log("Ù†Ù‚Øµ Ù…Ø¨Ù†Ù‰:", key, "Ø§Ù„Ù…Ø·Ù„ÙˆØ¨:", neededLevel, "Ø§Ù„Ø­Ø§Ù„ÙŠ:", currentLevel);
      return false;
    }
  }
  return true;
}

// ---------------- Ø§Ù„Ù‚Ù„Ø¹Ø© ----------------


// Ø§Ù„Ù‚Ù„Ø¹Ø© + Ø§Ù„ØªØ·ÙˆÙŠØ± + Ø§Ù„Ù…Ù‡Ø§Ù… + Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨
let castleLevel = 1;
let castleMaxLevel = 50;

const castleBaseUpgradeTime = 300; // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
const castleBaseGoldCost = 100;    // ØªÙƒÙ„ÙØ© ØªØ·ÙˆÙŠØ± Ù…Ù† 1 Ù„Ù€ 2
let totalPower = 0;

// Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡
let maxBuilders = 1;
let busyBuilders = 0;


// Helpers for mining buildings (gold/wood/meat)

// Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
function calcMiningUpgradeCost(buildingKey, level) {
  const config = MININGBUILDINGSCONFIG[buildingKey];
  if (!config) return { gold: 0, wood: 0, food: 0 };

  const factor = Math.pow(config.costFactor, level - 1);
  return {
    gold: Math.round(config.baseCostGold * factor),
    wood: Math.round(config.baseCostWood * factor),
    food: Math.round(config.baseCostFood * factor),
  };
}

// Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
function calcMiningUpgradeTime(buildingKey, level) {
  const config = MININGBUILDINGSCONFIG[buildingKey];
  if (!config) return 0;

  return Math.round(config.baseTime * Math.pow(config.timeFactor, level - 1));
}

// Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ù†ØªØ§Ø¬ ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø©
function calcMiningProductionPerHour(buildingKey, level) {
  const config = MININGBUILDINGSCONFIG[buildingKey];
  if (!config) return 0;

  return Math.round(config.baseProduction * Math.pow(config.productionFactor, level - 1));
}

// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªÙƒÙ„ÙØ© ÙˆÙˆÙ‚Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù„Ù…Ø¨Ø§Ù†ÙŠ ØºÙŠØ± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
const GENERIC_BUILDING_CONFIG = {
  school: {
    baseGold: 2000,
    baseWood: 1500,
    baseFood: 1000,
    costFactor: 1.5,
    baseTime: 120,    // Ø«ÙˆØ§Ù†ÙŠ
    timeFactor: 1.3,
  },
  attackTower: {
    baseGold: 4000,
    baseWood: 3000,
    baseFood: 2000,
    costFactor: 1.6,
    baseTime: 180,
    timeFactor: 1.35,
  },
  defenseTower: {
    baseGold: 4500,
    baseWood: 3200,
    baseFood: 2200,
    costFactor: 1.6,
    baseTime: 200,
    timeFactor: 1.35,
  },
  heroesHall: {
    baseGold: 5000,
    baseWood: 3500,
    baseFood: 2500,
    costFactor: 1.7,
    baseTime: 240,
    timeFactor: 1.4,
  },
  market: {
    baseGold: 2500,
    baseWood: 2000,
    baseFood: 1500,
    costFactor: 1.4,
    baseTime: 120,
    timeFactor: 1.25,
  },
  booster: {
    baseGold: 6000,
    baseWood: 4500,
    baseFood: 3000,
    costFactor: 1.7,
    baseTime: 300,
    timeFactor: 1.4,
  },
  hospital: {
    baseGold: 5500,
    baseWood: 4000,
    baseFood: 2800,
    costFactor: 1.7,
    baseTime: 260,
    timeFactor: 1.4,
  },
};

function calcGenericUpgradeCost(buildingKey, level) {
  const cfg = GENERIC_BUILDING_CONFIG[buildingKey];
  if (!cfg) return { gold: 0, wood: 0, food: 0 };

  const factor = Math.pow(cfg.costFactor, level - 1);
  return {
    gold: Math.round(cfg.baseGold * factor),
    wood: Math.round(cfg.baseWood * factor),
    food: Math.round(cfg.baseFood * factor),
  };
}

function calcGenericUpgradeTime(buildingKey, level) {
  const cfg = GENERIC_BUILDING_CONFIG[buildingKey];
  if (!cfg) return 0;
  return Math.round(cfg.baseTime * Math.pow(cfg.timeFactor, level - 1));
}

const MININGBUILDINGSINFO = {
  goldMine:    { name: "Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨",   image: "goldmine.png",   desc: "" },
  woodMine:    { name: "Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨",   image: "woodmine.png",   desc: "" },
  meatFarm:    { name: "Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù…",  image: "meatfarm.png",   desc: "" },
  school:      { name: "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©",      image: "school.png",     desc: "" },
  attackTower: { name: "Ø¨Ø±Ø¬ Ø§Ù„Ù‡Ø¬ÙˆÙ…",   image: "attack_tower.png", desc: "" },
  defenseTower:{ name: "Ø¨Ø±Ø¬ Ø§Ù„Ø¯ÙØ§Ø¹",   image: "defense_tower.png", desc: "" },
  heroesHall:  { name: "Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„", image: "heroes_hall.png",  desc: "" },
  market:      { name: "Ø§Ù„Ø³ÙˆÙ‚",        image: "market.png",     desc: "" },
  booster:     { name: "Ø¨Ø±Ø¬ Ø§Ù„Ø¨ÙˆØ³Øª",   image: "booster_tower.png", desc: "" },
  hospital:    { name: "Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰",     image: "hospital.png",   desc: "" }
};
function getBuildingImageByKey(key) {
  if (key === 'goldMine')    return 'goldmine.png';
  if (key === 'woodMine')    return 'woodmine.png';
  if (key === 'meatFarm')    return 'meatfarm.png';
  if (key === 'school')      return 'school.png';
  if (key === 'attackTower') return 'attacktower.png';
  if (key === 'defenseTower')return 'defensetower.png';
  if (key === 'heroesHall')  return 'heroeshall.png';
  if (key === 'market')      return 'market.png';
  if (key === 'booster')     return 'boostertower.png';
  if (key === 'hospital')    return 'hospital.png';
  return '';
}
function fillGenericUpgradeTab(buildingKey) {
  const imgEl    = document.getElementById('building-upgrade-image');
  const levelsEl = document.getElementById('building-upgrade-levels');
  const goldEl   = document.getElementById('building-upgrade-gold-cost');
  const woodEl   = document.getElementById('building-upgrade-wood-cost');
  const foodEl   = document.getElementById('building-upgrade-food-cost');
  const timeEl   = document.getElementById('building-upgrade-time');

  const currentLevel = buildingLevels[buildingKey] || 1;
  const nextLevel    = currentLevel + 1;

  // ØµÙˆØ±Ø© Ø§Ù„Ù…Ø¨Ù†Ù‰ ÙÙŠ ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ±Ù‚ÙŠØ©
  if (imgEl) {
    imgEl.src = getBuildingImageByKey(buildingKey);
    imgEl.alt = buildingKey;
  }

  // Ù…Ù† Ù„ÙŠÙÙ„ ÙƒØ§Ù… Ù„Ù„ÙŠÙÙ„ ÙƒØ§Ù…
  if (levelsEl) {
    levelsEl.textContent = `Level ${currentLevel} â†’ ${nextLevel}`;
  }

  // Ù†Ø­Ø³Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„ÙˆÙ‚Øª
  let cost   = { gold: 0, wood: 0, food: 0 };
  let timeSec = 0;

   // Ù„Ùˆ Ù…Ø¨Ù†Ù‰ Ù…ÙˆØ§Ø±Ø¯ (Ø°Ù‡Ø¨ / Ø®Ø´Ø¨ / Ù„Ø­Ù…) Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆÙ†ÙÙŠØ¬ Ø§Ù„Ø¬Ø§Ù‡Ø²
  if (buildingKey === 'goldMine' || buildingKey === 'woodMine' || buildingKey === 'meatFarm') {
    cost    = calcMiningUpgradeCost(buildingKey, nextLevel);
    timeSec = calcMiningUpgradeTime(buildingKey, nextLevel);
  } else {
    // Ø¨Ø§Ù‚ÙŠ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ ØªØ³ØªØ®Ø¯Ù… Ø§Ù„ÙƒÙˆÙ†ÙÙŠØ¬ Ø§Ù„Ø«Ù‚ÙŠÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    cost    = calcGenericUpgradeCost(buildingKey, nextLevel);
    timeSec = calcGenericUpgradeTime(buildingKey, nextLevel);
  }


  if (goldEl) goldEl.textContent = cost.gold.toLocaleString();
  if (woodEl) woodEl.textContent = cost.wood.toLocaleString();
  if (foodEl) foodEl.textContent = cost.food.toLocaleString();
  if (timeEl) timeEl.textContent = formatDuration(timeSec);
}
// Ø¨Ø¯Ø¡ ØªØ±Ù‚ÙŠØ© Ø£ÙŠ Ù…Ø¨Ù†Ù‰ (ÙˆÙ‚Øª + Ø®ØµÙ… Ù…ÙˆØ§Ø±Ø¯)
function startGenericBuildingUpgrade(buildingKey) {
  console.log("startGenericBuildingUpgrade CALLED with", buildingKey);

  // Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠ ÙˆØ§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ø§Ø¯Ù…
  const currentLevel = buildingLevels[buildingKey] || 1;
  const nextLevel = currentLevel + 1;

  // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© ÙˆØ§Ù„Ø²Ù…Ù†
  let cost, timeSec;
  if (buildingKey === "goldMine" || buildingKey === "woodMine" || buildingKey === "meatFarm") {
    cost = calcMiningUpgradeCost(buildingKey, nextLevel);
    timeSec = calcMiningUpgradeTime(buildingKey, nextLevel);
  } else {
    cost = calcGenericUpgradeCost(buildingKey, nextLevel);
    timeSec = calcGenericUpgradeTime(buildingKey, nextLevel);
  }

  console.log("Upgrade cost/time", buildingKey, { currentLevel, nextLevel, cost, timeSec });

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
  if (resources.gold < cost.gold || resources.wood < cost.wood || resources.food < cost.food) {
    alert("Not enough resources!");
    return;
  }

  // ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¨Ù†Ù‘Ø§Ø¦ÙŠÙ†
  if (busyBuilders >= maxBuilders) {
    alert("No free builders available!");
    return;
  }

  // Ø®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
  resources.gold -= cost.gold;
  resources.wood -= cost.wood;
  resources.food -= cost.food;
  busyBuilders++;

  // Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡
  const finishAt = Date.now() + timeSec * 1000;

  // Ø­ÙØ¸ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù„Ù…Ø¨Ù†Ù‰ Ø¯Ù‡ + ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ±Ù‚ÙŠØ©
  buildingUpgrades[buildingKey] = {
    inProgress: true,
    finishAt,
    totalTime: timeSec,
    remainingTime: timeSec,
    cost: {
      gold: cost.gold || 0,
      wood: cost.wood || 0,
      food: cost.food || 0,
    },
  };

  startBuildingUpgradeTimer();
  saveGameState();
}
function cancelBuildingUpgrade(buildingKey) {
  const upgrade = buildingUpgrades[buildingKey];
  if (!upgrade || !upgrade.inProgress) {
    console.log("No upgrade in progress for", buildingKey);
    return;
  }

  // Ø±Ø¬Ù‘Ø¹ 50% Ù…Ù† ØªÙƒÙ„ÙØ© Ø§Ù„ØªØ±Ù‚ÙŠØ©
  if (upgrade.cost && typeof resources !== "undefined") {
    const refundGold = Math.floor((upgrade.cost.gold || 0) * 0.5);
    const refundWood = Math.floor((upgrade.cost.wood || 0) * 0.5);
    const refundFood = Math.floor((upgrade.cost.food || 0) * 0.5);

    resources.gold += refundGold;
    resources.wood += refundWood;
    resources.food += refundFood;

    console.log(
      "Refund on cancel:",
      { gold: refundGold, wood: refundWood, food: refundFood },
      "for",
      buildingKey
    );

    if (typeof updateTopBar === "function") {
      updateTopBar();
    }
  }

  // ÙˆÙ‚Ù Ø§Ù„ØªØ±Ù‚ÙŠØ©
  upgrade.inProgress = false;
  upgrade.remainingTime = 0;

  // Ù†Ø¸Ù‘Ù Ø§Ù„Ø¨Ø§Ø± ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
  updateCityBuildingUpgradeBar(buildingKey, upgrade);

  // Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ù€ builder
  if (typeof busyBuilders !== "undefined") {
    busyBuilders = Math.max(0, busyBuilders - 1);
  }

  // Ù„Ùˆ Ù…ÙÙŠØ´ Ø£ÙŠ ØªØ±Ù‚ÙŠØ© ØªØ§Ù†ÙŠØ©ØŒ ÙˆÙ‚Ù Ø§Ù„ØªØ§ÙŠÙ…Ø±
  let anyInProgress = false;
  for (const key in buildingUpgrades) {
    if (buildingUpgrades[key] && buildingUpgrades[key].inProgress) {
      anyInProgress = true;
      break;
    }
  }
  if (!anyInProgress && buildingUpgradeInterval) {
    clearInterval(buildingUpgradeInterval);
    buildingUpgradeInterval = null;
  }

  if (typeof saveGameState === "function") {
    saveGameState();
  }

  console.log("Upgrade canceled for", buildingKey);
}

function startBuildingUpgradeTimer() {
  // Ù„Ùˆ Ø§Ù„ØªØ§ÙŠÙ…Ø± Ø´ØºØ§Ù„ Ø¨Ø§Ù„ÙØ¹Ù„ØŒ Ù…Ø§ Ù†Ø¹Ù…Ù„Ø´ ÙˆØ§Ø­Ø¯ Ø¬Ø¯ÙŠØ¯
  if (buildingUpgradeInterval) return;

  buildingUpgradeInterval = setInterval(function () {
    const now = Date.now();
    let anyInProgress = false;

    for (const key in buildingUpgrades) {
      const upgrade = buildingUpgrades[key];

      // Ù„Ùˆ Ù…ÙÙŠØ´ ØªØ±Ù‚ÙŠØ© Ù†Ø´Ø·Ø© Ù„Ù„Ù…Ø¨Ù†Ù‰ Ø¯Ù‡ØŒ Ø§Ø®ÙÙŠ Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ ÙˆÙƒÙ…Ù‘Ù„
      if (!upgrade || !upgrade.inProgress) {
        updateCityBuildingUpgradeBar(key, null);
        continue;
      }

      anyInProgress = true;

      // Ø­Ø³Ø§Ø¨ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
      const remaining = Math.max(0, Math.floor((upgrade.finishAt - now) / 1000));
      upgrade.remainingTime = remaining;

      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ø± Ø§Ù„Ø³ÙÙ„ÙŠ ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
      updateCityBuildingUpgradeBar(key, upgrade);

      // Ù„Ùˆ Ø§Ù„Ø¨Ø§Ù†Ù„ Ø§Ù„Ù…ÙØªÙˆØ­ Ø­Ø§Ù„ÙŠØ§Ù‹ Ù„Ù†ÙØ³ Ø§Ù„Ù…Ø¨Ù†Ù‰ØŒ Ø­Ø¯Ù‘Ø« Ø§Ù„Ù€ UI
      if (typeof currentBuildingKey !== "undefined" && currentBuildingKey === key) {
        updateBuildingUpgradePanelForTimer(key);
      }

      // Ù„Ùˆ Ø®Ù„Øµ Ø§Ù„ÙˆÙ‚Øª
      if (remaining <= 0) {
        upgrade.inProgress = false;
        upgrade.remainingTime = 0;

        // Ø¢Ø®Ø± ØªØ­Ø¯ÙŠØ« Ù„Ù„Ø¨Ø§Ø± (ÙŠÙˆØµÙ„ 100% ÙˆØ¨Ø¹Ø¯ÙŠÙ† ÙŠØ®ØªÙÙŠ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø¬Ø§ÙŠØ©)
        updateCityBuildingUpgradeBar(key, upgrade);

        // Ø±ÙØ¹ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù†Ù‰
        const currentLevel = buildingLevels[key] || 1;
        const nextLevel = currentLevel + 1;
        buildingLevels[key] = nextLevel;

        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù†Øµ ÙÙŠ Ø§Ù„Ø¨Ø§Ù†Ù„ Ù„Ùˆ Ù…ÙØªÙˆØ­
        if (typeof buildingPanelExtra !== "undefined" && currentBuildingKey === key) {
          if (key === "goldMine" || key === "woodMine" || key === "meatFarm") {
            const newProd = calcMiningProductionPerHour(key, nextLevel);
            buildingPanelExtra.textContent =
              "Level " + nextLevel + " - " + newProd.toLocaleString() + "/hour";
          } else {
            buildingPanelExtra.textContent = "Level " + nextLevel;
          }
        }

        // ØªØ­Ø¯ÙŠØ« status box Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ (Ø²ÙŠ Ø§Ù„Ù…Ù†Ø§Ø¬Ù…)
        const statusIdMap = {
          goldMine: "gold-mine-status-box",
          woodMine: "wood-mine-status-box",
          meatFarm: "meat-farm-status-box",
        };
        const statusId = statusIdMap[key];
        if (statusId) {
          const statusBox = document.getElementById(statusId);
          if (statusBox) statusBox.textContent = "Lv. " + nextLevel;
        }

        // ØªØ­Ø±ÙŠØ± Ø¨Ù†Ù‘Ø§Ø¡
        if (typeof busyBuilders !== "undefined") {
          busyBuilders = Math.max(0, busyBuilders - 1);
        }
      }
    }

    // Ù„Ùˆ Ù…ÙÙŠØ´ Ø£ÙŠ ØªØ±Ù‚ÙŠØ© Ø´ØºØ§Ù„Ø©ØŒ ÙˆÙ‚Ù Ø§Ù„ØªØ§ÙŠÙ…Ø±
    if (!anyInProgress) {
      clearInterval(buildingUpgradeInterval);
      buildingUpgradeInterval = null;
    }

    if (typeof saveGameState === "function") {
      saveGameState();
    }
  }, 1000);
}

function updateBuildingUpgradePanelForTimer(buildingKey) {
  const upgrade = buildingUpgrades[buildingKey];

  const panelTimeEl = document.getElementById("building-upgrade-remaining-time");
  const progressWrapper = document.getElementById("building-upgrade-progress-wrapper");
  const progressFill = document.getElementById("building-upgrade-progress-fill");

  if (!upgrade || !upgrade.inProgress) {
    if (progressWrapper) progressWrapper.style.display = "none";
    if (panelTimeEl) panelTimeEl.textContent = "";
    // ÙƒÙ…Ø§Ù† Ù†Ø¸Ù‘Ù Ø§Ù„Ù„ÙŠ ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
    updateCityBuildingUpgradeBar(buildingKey, upgrade);
    return;
  }

  if (progressWrapper) progressWrapper.style.display = "block";

  if (panelTimeEl) {
    panelTimeEl.textContent = formatDuration(upgrade.remainingTime);
  }

  if (progressFill) {
    const ratio = upgrade.totalTime > 0
      ? (upgrade.totalTime - upgrade.remainingTime) / upgrade.totalTime
      : 0;
    const percent = Math.max(0, Math.min(100, ratio * 100));
    progressFill.style.width = percent + "%";
  }

  // Ù‡Ù†Ø§ Ø£Ù‡Ù… Ø³Ø·Ø±: Ø®Ù„Ù‘ÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© ØªØªØ­Ø¯Ø« ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙˆÙ‚Øª
  updateCityBuildingUpgradeBar(buildingKey, upgrade);
}


function openMiningBuildingPanel(buildingKey) {
  console.log("openMiningBuildingPanel CALLED with", buildingKey);

  currentMiningBuildingKey = buildingKey;
  const config = MININGBUILDINGSCONFIG[buildingKey];
  const info   = MININGBUILDINGSINFO[buildingKey];

  if (!info) {
    console.warn("missing info for", buildingKey, info);
    return;
  }
  const currentLevel = buildingLevels[buildingKey] || 1;
  let currentProd = 0;

  // Ø§Ù„Ù…Ù†Ø§Ø¬Ù… ÙÙ‚Ø· (goldMine / woodMine / meatFarm)
  if (buildingKey === "goldMine" || buildingKey === "woodMine" || buildingKey === "meatFarm") {
    currentProd = calcMiningProductionPerHour(buildingKey, currentLevel);
  } else {
    currentProd = 0;
  }


  buildingPanelTitle.textContent = info.name;
  buildingPanelImage.src = info.image;
  buildingPanelImage.alt = info.name;
  buildingPanelDesc.textContent = info.desc;
  buildingPanelExtra.textContent =
    "Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " + currentLevel + " - Ø¥Ù†ØªØ§Ø¬ " + currentProd.toLocaleString() + " ÙÙŠ Ø§Ù„Ø³Ø§Ø¹Ø©";

  fillGenericUpgradeTab(buildingKey);
  switchBuildingPanelTab("info");
  buildingPanel.classList.remove("hidden");
}

function fillMiningUpgradeTab(buildingKey) {
  const currentLevel = buildingLevels[buildingKey] || 1;
  const nextLevel    = currentLevel + 1;

  const cost = calcMiningUpgradeCost(buildingKey, nextLevel);
  const timeSec = calcMiningUpgradeTime(buildingKey, nextLevel);

  const levelsEl = document.getElementById("building-upgrade-levels");
  const costEl   = document.getElementById("building-upgrade-cost");
  const timeEl   = document.getElementById("building-upgrade-time");

  if (levelsEl) {
    levelsEl.textContent = `Ù…Ù† Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${currentLevel} Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ${nextLevel}`;
  }

  if (costEl) {
    const parts = [];
    if (cost.gold > 0) parts.push(`Ø°Ù‡Ø¨: ${cost.gold.toLocaleString()}`);
    if (cost.wood > 0) parts.push(`Ø®Ø´Ø¨: ${cost.wood.toLocaleString()}`);
    if (cost.food > 0) parts.push(`Ø·Ø¹Ø§Ù…: ${cost.food.toLocaleString()}`);
    costEl.textContent = parts.join(" | ");
  }

  if (timeEl) {
    timeEl.textContent = `ÙˆÙ‚Øª Ø§Ù„ØªØ±Ù‚ÙŠØ©: ${formatDuration(timeSec)}`;
  }
}
function startMiningBuildingUpgrade(buildingKey) {
  const currentLevel = buildingLevels[buildingKey] || 1;
  const nextLevel = currentLevel + 1;
  const cost = calcMiningUpgradeCost(buildingKey, nextLevel);
  const timeSec = calcMiningUpgradeTime(buildingKey, nextLevel);

  // Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙƒÙØ§ÙŠØ©ØŸ
  if (resources.gold < cost.gold || resources.wood < cost.wood || resources.food < cost.food) {
    alert("Not enough resources!");
    return;
  }

  // ÙÙŠÙ‡ Ø¹Ø§Ù…Ù„ ÙØ§Ø¶ÙŠØŸ
  if (busyBuilders >= maxBuilders) {
    alert("No free builders available!");
    return;
  }

  // Ø®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
  resources.gold -= cost.gold;
  resources.wood -= cost.wood;
  resources.food -= cost.food;

  // Ø­Ø¬Ø² Ø¹Ø§Ù…Ù„
  busyBuilders++;

  // Ù†Ø­Ø¯Ø¯ ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„ÙƒÙ„ Ù…Ø¨Ù†Ù‰ Ø¹Ù„Ù‰ Ø­Ø¯Ø©
  const finishAtKey = buildingKey + "UpgradeFinishAt";
  const inProgressKey = buildingKey + "UpgradeInProgress";
  const remainingKey = buildingKey + "UpgradeRemainingTime";
  const intervalKey = buildingKey + "UpgradeInterval";

  window[inProgressKey] = true;
  window[remainingKey] = timeSec;
  window[finishAtKey] = Date.now() + timeSec * 1000;

  // TODO: Ù‡Ù†Ø§ ØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙ UI Ù…Ø®ØªÙ„Ù Ù„ÙƒÙ„ Ù…Ø¨Ù†Ù‰ Ù„Ùˆ Ø­Ø¨ÙŠØª (Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù…... Ø¥Ù„Ø®)

  saveGameState();

  // Ù…Ø¤Ù‚Øª Ø¨Ø³ÙŠØ· Ù„Ù„ØªØ±Ù‚ÙŠØ©
  if (window[intervalKey]) clearInterval(window[intervalKey]);

  const totalTime = timeSec;
  window[intervalKey] = setInterval(() => {
    window[remainingKey] -= 1;
    if (window[remainingKey] < 0) window[remainingKey] = 0;

    // Ù„Ù…Ø§ ÙŠØ®Ù„Øµ Ø§Ù„ÙˆÙ‚Øª
    if (window[remainingKey] <= 0) {
      clearInterval(window[intervalKey]);
      window[intervalKey] = null;
      finishMiningBuildingUpgrade(buildingKey);
    }
  }, 1000);
}
function finishMiningBuildingUpgrade(buildingKey) {
  const currentLevel = buildingLevels[buildingKey] || 1;
  const nextLevel = currentLevel + 1;

  // Ø²ÙˆØ¯ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù†Ù‰
  buildingLevels[buildingKey] = nextLevel;

  // ÙÙƒ Ø¹Ø§Ù…Ù„ ÙˆØ§Ø­Ø¯
  busyBuilders--;
  if (busyBuilders < 0) busyBuilders = 0;

  const newProd = calcMiningProductionPerHour(buildingKey, nextLevel);
  if (buildingPanelExtra) {
    buildingPanelExtra.textContent = `Level ${nextLevel} â€“ ${newProd.toLocaleString()} / hour`;
  }

  fillMiningUpgradeTab(buildingKey);

  const statusIdMap = {
    goldMine: "gold-mine-status-box",
    woodMine: "wood-mine-status-box",
    meatFarm: "meat-farm-status-box",
  };
  const statusId = statusIdMap[buildingKey];
  if (statusId) {
    const statusBox = document.getElementById(statusId);
    if (statusBox) statusBox.textContent = `Lv. ${nextLevel}`;
  }

  saveGameState();
}




// === Daily Tasks Track ===
let dailyPoints = 0;
const DAILY_CHESTS = [
  {
    id: "daily-chest-1",
    requiredPoints: 30,
    claimed: false,
    rewards: { gold: 20000, wood: 20000, food: 20000, gem: 10 }
  },
  {
    id: "daily-chest-2",
    requiredPoints: 60,
    claimed: false,
    rewards: { gold: 50000, wood: 50000, food: 50000, gem: 20 }
  },
  {
    id: "daily-chest-3",
    requiredPoints: 100,
    claimed: false,
    rewards: { gold: 100000, wood: 100000, food: 100000, gem: 40 }
  }
];
// === Weekly Tasks Track ===
let weeklyPoints = 0;
const WEEKLY_CHESTS = [
  {
    id: "weekly-chest-1",
    requiredPoints: 100,
    claimed: false,
    rewards: { gold: 200000, wood: 200000, food: 200000, gem: 50 }
  },
  {
    id: "weekly-chest-2",
    requiredPoints: 300,
    claimed: false,
    rewards: { gold: 400000, wood: 400000, food: 400000, gem: 100 }
  },
  {
    id: "weekly-chest-3",
    requiredPoints: 500,
    claimed: false,
    rewards: { gold: 700000, wood: 700000, food: 700000, gem: 150 }
  },
  {
    id: "weekly-chest-4",
    requiredPoints: 800,
    claimed: false,
    rewards: { gold: 1000000, wood: 1000000, food: 1000000, gem: 220 }
  },
  {
    id: "weekly-chest-5",
    requiredPoints: 1000,
    claimed: false,
    rewards: { gold: 1500000, wood: 1500000, food: 1500000, gem: 300 }
  }
];

// === Tasks Config ===
const MAIN_TASKS = [
  {
    id: "reach-castle-5",
    title: "Reach Castle Lv. 5",
    desc: "Ø·ÙˆÙ‘Ø± Ù‚Ù„Ø¹ØªÙƒ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ 5.",
    type: "castle_level",
    target: 5,
    reward: { gem: 20 }
  },
  {
    id: "buildings-10",
    title: "Upgrade 10 building levels",
    desc: "Ø§Ø¬Ù…Ø¹ Ø¥Ø¬Ù…Ø§Ù„ÙŠ 10 Ù…Ø³ØªÙˆÙŠØ§Øª Ù…Ø¨Ø§Ù†ÙŠ.",
    type: "building_levels_sum",
    target: 10,
    reward: { gold: 20000, wood: 20000 }
  }
];

const DAILY_TASKS = [
  {
    id: "collect-gold",
    title: "Ø§Ø¬Ù…Ø¹ 10k Ø°Ù‡Ø¨",
    desc: "Ø§Ø¬Ù…Ø¹ 10,000 Gold Ù…Ù† Ø§Ù„Ù…Ù†Ø§Ø¬Ù… Ø£Ùˆ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø².",
    type: "collect_gold",
    target: 10000,
    points: 10,
    reward: { gem: 0 }
  },
  {
    id: "upgrade-building",
    title: "Ø·ÙˆÙ‘Ø± Ø£ÙŠ Ù…Ø¨Ù†Ù‰",
    desc: "Ø§Ø±ÙØ¹ Ù…Ø³ØªÙˆÙ‰ Ø£ÙŠ Ù…Ø¨Ù†Ù‰ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© Ø§Ù„ÙŠÙˆÙ….",
    type: "upgrade_building",
    target: 1,
    points: 15,
    reward: { gold: 0, wood: 0 }
  },
  {
    id: "train-army",
    title: "Ø¯Ø±Ù‘Ø¨ 50 Ø¬Ù†Ø¯ÙŠ",
    desc: "Ø¯Ø±Ù‘Ø¨ Ù…Ø§ Ù…Ø¬Ù…ÙˆØ¹Ù‡ 50 Ø¬Ù†Ø¯ÙŠ Ù…Ù† Ø£ÙŠ Ù†ÙˆØ¹.",
    type: "train_units",
    target: 50,
    points: 15,
    reward: { food: 0 }
  },
  {
    id: "buy-pack",
    title: "Ø§Ø´ØªØ±ÙŠ Ø£ÙŠ Resource Pack",
    desc: "Ù‚Ù… Ø¨Ø´Ø±Ø§Ø¡ Ø£ÙŠ Ø­Ø²Ù…Ø© Ù…ÙˆØ§Ø±Ø¯ Ù…Ù† Ø§Ù„Ù…ØªØ¬Ø±.",
    type: "buy_resource_pack",
    target: 1,
    points: 10,
    reward: { gem: 0 }
  },
  {
    id: "invite-friend-daily",
    title: "Ù‚Ù… Ø¨Ø¯Ø¹ÙˆØ© ØµØ¯ÙŠÙ‚",
    desc: "Ø§Ø³ØªØ®Ø¯Ù… Ø±Ø§Ø¨Ø· Ø§Ù„Ø¯Ø¹ÙˆØ© Ù„Ø¯Ø¹ÙˆØ© ØµØ¯ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯ Ø§Ù„ÙŠÙˆÙ….",
    type: "invite_friend_daily",
    target: 1,
    points: 30,
    reward: { gem: 50 }
  }
];



const WEEKLY_TASKS = [
  {
    id: "castle-10",
    title: "Reach Castle Lv. 10",
    desc: "Ø§ØµØ¹Ø¯ Ø¨Ù‚Ù„Ø¹ØªÙƒ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ 10 Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.",
    type: "castle_level",
    target: 10,
    points: 250,
    reward: { gem: 50 }
  },
  {
    id: "train-500",
    title: "Train 500 units",
    desc: "Ø¯Ø±Ù‘Ø¨ 500 ÙˆØ­Ø¯Ø© Ø¬ÙŠØ´ Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.",
    type: "train_units",
    target: 500,
    points: 200,
    reward: { food: 100000 }
  },
  {
    id: "invite-10-weekly",
    title: "Invite 10 friends",
    desc: "Ù‚Ù… Ø¨Ø¯Ø¹ÙˆØ© 10 Ø£ØµØ¯Ù‚Ø§Ø¡ Ø®Ù„Ø§Ù„ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹.",
    type: "invite_friends_weekly",
    target: 10,
    points: 200,          // â† Ø²ÙŠ Ù…Ø§ Ø·Ù„Ø¨Øª
    reward: { gem: 500 }  // â† 500 Ø¬ÙˆØ§Ù‡Ø±
  }
];



const SOCIAL_TASKS = [
  {
    id: "join-channel",
    title: "Join Telegram Channel",
    desc: "Ø§Ù†Ø¶Ù… Ø¥Ù„Ù‰ Ù‚Ù†Ø§Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù….",
    type: "social_join_channel",
    target: 1,
    reward: { gem: 15 }
  },
  {
    id: "follow-twitter",
    title: "Follow on X (Twitter)",
    desc: "ØªØ§Ø¨Ø¹ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¹Ù„Ù‰ X.",
    type: "social_follow_x",
    target: 1,
    reward: { gem: 15 }
  }
];

let mainTasksState = {};
let dailyTasksState = {};
let weeklyTasksState = {};
let socialTasksState = {};

let currentTasksTab = "main";
let hasTasksNotification = false;
// === Daily Login System ===
const DAILY_LOGIN_REWARDS = [
  { day: 1, gold: 5000, wood: 0, food: 0, gem: 0 },
  { day: 2, gold: 7000, wood: 0, food: 0, gem: 0 },
  { day: 3, gold: 10000, wood: 5000, food: 0, gem: 5 },
  { day: 4, gold: 12000, wood: 0, food: 0, gem: 0 },
  { day: 5, gold: 15000, wood: 8000, food: 0, gem: 10 },
  { day: 6, gold: 18000, wood: 0, food: 0, gem: 0 },
  { day: 7, gold: 25000, wood: 15000, food: 10000, gem: 20 },
  { day: 8, gold: 30000, wood: 0, food: 0, gem: 0 },
  { day: 9, gold: 35000, wood: 20000, food: 0, gem: 15 },
  { day: 10, gold: 40000, wood: 0, food: 0, gem: 25 },
  { day: 11, gold: 45000, wood: 25000, food: 15000, gem: 0 },
  { day: 12, gold: 50000, wood: 0, food: 0, gem: 30 },
  { day: 13, gold: 55000, wood: 30000, food: 0, gem: 0 },
  { day: 14, gold: 70000, wood: 40000, food: 25000, gem: 40 },
  { day: 15, gold: 80000, wood: 0, food: 0, gem: 50 },
  { day: 16, gold: 90000, wood: 50000, food: 0, gem: 0 },
  { day: 17, gold: 100000, wood: 0, food: 0, gem: 60 },
  { day: 18, gold: 110000, wood: 60000, food: 35000, gem: 0 },
  { day: 19, gold: 120000, wood: 0, food: 0, gem: 70 },
  { day: 20, gold: 140000, wood: 70000, food: 0, gem: 80 },
  { day: 21, gold: 160000, wood: 80000, food: 50000, gem: 100 },
  { day: 22, gold: 180000, wood: 0, food: 0, gem: 0 },
  { day: 23, gold: 200000, wood: 100000, food: 0, gem: 110 },
  { day: 24, gold: 220000, wood: 0, food: 0, gem: 120 },
  { day: 25, gold: 250000, wood: 120000, food: 70000, gem: 0 },
  { day: 26, gold: 280000, wood: 0, food: 0, gem: 140 },
  { day: 27, gold: 310000, wood: 150000, food: 0, gem: 150 },
  { day: 28, gold: 350000, wood: 180000, food: 100000, gem: 180 },
  { day: 29, gold: 400000, wood: 200000, food: 0, gem: 200 },
  { day: 30, gold: 500000, wood: 250000, food: 150000, gem: 300 }
];

let dailyLoginState = {
  lastLoginDate: null,        // Ø¢Ø®Ø± ØªØ§Ø±ÙŠØ® Ø¯Ø®ÙˆÙ„
  claimedDays: [],            // Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù„ÙŠ Ø§Ø³ØªÙ„Ù… Ø¬ÙˆØ§Ø¦Ø²Ù‡Ø§ [1,2,3,...]
  currentDay: 0               // Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Ø§Ù„Ø³Ù„Ø³Ù„Ø© (0-30)
};
function updateDailyLoginBanner() {
  const banner = document.getElementById("daily-login-banner");
  if (!banner) return;

  const todayStr = new Date().toDateString();
  const canClaimToday = dailyLoginState.lastLoginDate !== todayStr;

  if (canClaimToday) {
    banner.classList.remove("hidden");
    banner.style.display = "flex";  // â† Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
  } else {
    banner.classList.add("hidden");
    banner.style.display = "none";  // â† Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
  }
}


function updateDailyLoginIcon() {
  const btn = document.getElementById("daily-login-icon-btn");
  if (!btn) return;

  const oldDot = btn.querySelector(".daily-login-notif-dot");
  if (oldDot) oldDot.remove();

  const todayStr = new Date().toDateString();
  const canClaimToday = dailyLoginState.lastLoginDate !== todayStr;

  if (!canClaimToday) return;

  const dot = document.createElement("div");
  dot.className = "daily-login-notif-dot";
  dot.style.position = "absolute";
  dot.style.top = "-2px";
  dot.style.right = "-2px";
  dot.style.width = "10px";
  dot.style.height = "10px";
  dot.style.borderRadius = "50%";
  dot.style.background = "#ef4444";
  dot.style.boxShadow = "0 0 8px rgba(239, 68, 68, 0.9)";

  btn.appendChild(dot);
}

function saveGameState() {
  try {
    const state = {
      castleLevel,
      resources,
      upgradeInProgress,
      upgradeFinishAt,
      attackTrainingInProgress,
      attackTrainingFinishAt,
      attackTrainingRemainingTime,
      attackTrainingTotalTime,
      currentTrainingHeroKey,
      currentTrainingUnitKey,
      currentTrainingAmount,
      healthTrainingInProgress,
      healthTrainingFinishAt,
      healthTrainingRemainingTime,
      healthTrainingTotalTime,
      currentHealthTrainingHeroKey,
      currentHealthTrainingUnitKey,
      currentHealthTrainingAmount,
      buildingLevels,
      buildingUpgrades, // â† Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯
    };
    localStorage.setItem("raidex_gamestate_v3", JSON.stringify(state));
  } catch (e) {
    console.error("Error saving game state", e);
  }
}



// Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ: Ø´Ø±ÙˆØ· Ø§Ù„ÙØªØ­ ÙˆÙ†ÙˆØ¹ Ø§Ù„Ù…Ø¨Ù†Ù‰
const BUILDINGS_CONFIG = {
  1: { id: "building-1", key: "goldMine",   name: "Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨",   unlockLevel: 2 },  // Ù…ÙØªÙˆØ­ Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
  2: { id: "building-2", key: "woodMine",   name: "Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨",   unlockLevel: 2 },
  3: { id: "building-3", key: "school",     name: "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©",      unlockLevel: 3 },
  4: { id: "building-4", key: "attackTower",name: "Ø¨Ø±Ø¬ Ø§Ù„Ù‡Ø¬ÙˆÙ…",   unlockLevel: 5 },
  5: { id: "building-5", key: "defenseTower",name:"Ø¨Ø±Ø¬ Ø§Ù„Ø¯ÙØ§Ø¹",   unlockLevel: 7 },
  6: { id: "building-6", key: "meatFarm",   name: "Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù…",  unlockLevel: 2 },
  7: { id: "building-7", key: "heroesHall", name: "Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„", unlockLevel: 4 },
  8: { id: "building-8", key: "market",     name: "Ø§Ù„Ø³ÙˆÙ‚",        unlockLevel: 6 },
  9: { id: "building-9", key: "booster",    name: "Ø¨Ø±Ø¬ Ø§Ù„Ø¨ÙˆØ³Øª",   unlockLevel: 8 },
  10:{ id: "building-10",key: "hospital",   name: "Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰",     unlockLevel: 10 }
};
// Ø­Ø§Ù„Ø© ÙØªØ­ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ (true/false Ù„ÙƒÙ„ building key)
let unlockedBuildings = {};
function getBuildingNameByKey(key) {
  for (const cfg of Object.values(BUILDINGS_CONFIG)) {
    if (cfg.key === key) {
      return cfg.name;
    }
  }
  return key;
}
let currentBuildingKey = null;
// Ø¥Ø¨Ø±Ø§Ø² Ù…Ø¨Ù†Ù‰ ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø© + Ø¹Ø±Ø¶ Ø¨Ø§Ù„ÙˆÙ†Ø© info/upgrade ÙÙˆÙ‚Ù‡
function showBuildingPopup(buildingKey) {
  console.log("showBuildingPopup CALLED with", buildingKey);
 currentBuildingKey = buildingKey;
  const old = document.getElementById("building-popup");
  if (old) old.parentNode.removeChild(old);

  let buildingId = null;
  for (const cfg of Object.values(BUILDINGS_CONFIG)) {
    if (cfg.key === buildingKey) {
      buildingId = cfg.id;
      break;
    }
  }
  if (!buildingId) return;

  const el = document.getElementById(buildingId);
  if (!el) return;

  const oldHighlight = document.querySelector(".building-highlight");
  if (oldHighlight) oldHighlight.classList.remove("building-highlight");
  el.classList.add("building-highlight");

  const popup = document.createElement("div");
  popup.id = "building-popup";
  popup.style.position = "absolute";
  popup.style.left = "50%";
  popup.style.top = "0";
  popup.style.transform = "translate(-50%, -110%)";
   popup.style.background = "rgba(15,23,42,0.98)";
   popup.style.border = "2px solid #0ea5e9";
 popup.style.borderRadius = "16px";
  popup.style.padding = "8px 10px";
 popup.style.minWidth = "180px";
  popup.style.color = "#e5e7eb";
  popup.style.fontSize = "12px";
  popup.style.zIndex = "300";
    popup.style.boxShadow = "0 14px 30px rgba(0,0,0,0.85)";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.alignItems = "center";
  header.style.gap = "6px";

   const img = document.createElement("img");
  img.style.width = "40px";
  img.style.height = "40px";
  img.style.borderRadius = "8px";
  img.style.objectFit = "cover";
  img.style.border = "1px solid rgba(148,163,184,0.8)";
  img.src = getBuildingImageByKey(buildingKey);


  const titleBox = document.createElement("div");
  titleBox.style.display = "flex";
  titleBox.style.flexDirection = "column";

  const nameEl = document.createElement("div");
  nameEl.style.fontWeight = "bold";
  nameEl.style.fontSize = "14px";
  nameEl.style.letterSpacing = "0.5px";
  nameEl.textContent = getBuildingNameByKey(buildingKey);

  const levelEl = document.createElement("div");
  levelEl.style.fontSize = "12px";
  levelEl.style.color = "#22c55e";
  levelEl.style.marginTop = "2px";
  const lvl = buildingLevels[buildingKey] || 1;
  levelEl.textContent = "LEVEL " + lvl;


  titleBox.appendChild(nameEl);
  titleBox.appendChild(levelEl);
  header.appendChild(img);
  header.appendChild(titleBox);

  popup.appendChild(header);
  el.appendChild(popup);
  // Ø¥Ø¸Ù‡Ø§Ø± Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³ÙÙ„ Ø£ÙˆÙ„ Ù…Ø§ Ù†Ø®ØªØ§Ø± Ù…Ø¨Ù†Ù‰
const actions = document.getElementById("building-bottom-actions");
if (actions) actions.style.display = "flex";
}

function getBuildingImageByKey(key) {
  if (key === "goldMine")     return "goldmine.png";
  if (key === "woodMine")     return "woodmine.png";
  if (key === "meatFarm")     return "meatfarm.png";
  if (key === "school")       return "school.png";

  if (key === "attackTower")  return "attack_tower.png";
  if (key === "defenseTower") return "defense_tower.png";
  if (key === "heroesHall")   return "heroes_hall.png";
  if (key === "booster")      return "booster_tower.png";

  if (key === "market")       return "market.png";
  if (key === "hospital")     return "hospital.png";
  return "";
}

function openBuildingPanel(buildingKey) {
  console.log("Open building panel for:", buildingKey);
  currentBuildingKey = buildingKey;

  const cfg = Object.values(BUILDINGS_CONFIG).find(c => c.key === buildingKey);
  if (!cfg) return;

  if (buildingPanelTitle) {
    buildingPanelTitle.textContent = cfg.name;
  }

  if (buildingPanelImage) {
    buildingPanelImage.src = getBuildingImageByKey(buildingKey);
    buildingPanelImage.alt = cfg.name;
  }

  if (buildingPanelDesc) {
    buildingPanelDesc.textContent = "";
  }

  const lvl = buildingLevels[buildingKey] || 1;
  if (buildingPanelExtra) {
    buildingPanelExtra.textContent = "Level " + lvl;
  }

  // ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ±Ù‚ÙŠØ© + Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§ÙŠÙ…Ø± Ø¥Ù† ÙˆØ¬Ø¯
  fillGenericUpgradeTab(buildingKey);
  updateBuildingUpgradePanelForTimer(buildingKey);
  // Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©
  const cancelBtn = document.getElementById("building-panel-cancel-upgrade-btn");
  if (cancelBtn) {
    const up = buildingUpgrades[buildingKey];
    if (up && up.inProgress) {
      cancelBtn.style.display = "block";
      cancelBtn.onclick = function () {
        cancelBuildingUpgrade(buildingKey);
        cancelBtn.style.display = "none";
        updateBuildingUpgradePanelForTimer(buildingKey);
      };
    } else {
      cancelBtn.style.display = "none";
      cancelBtn.onclick = null;
    }
  }

  switchBuildingPanelTab('info');
  buildingPanel.classList.remove('hidden');
}
function updateCityBuildingUpgradeBar(buildingKey, upgrade) {
    console.log("BAR DEBUG:", buildingKey, upgrade);
  const idMap = {
    goldMine:   { bar: "gold-mine-upgrade-bar",       fill: "gold-mine-upgrade-bar-fill",       time: "gold-mine-upgrade-remaining-time" },
    woodMine:   { bar: "wood-mine-upgrade-bar",       fill: "wood-mine-upgrade-bar-fill",       time: "wood-mine-upgrade-bar-time" },
    meatFarm:   { bar: "meat-farm-upgrade-bar",       fill: "meat-farm-upgrade-bar-fill",       time: "meat-farm-upgrade-bar-time" },
    school:     { bar: "school-upgrade-bar",          fill: "school-upgrade-bar-fill",          time: "school-upgrade-bar-time" },
    attackTower:{ bar: "attack-tower-upgrade-bar",    fill: "attack-tower-upgrade-bar-fill",    time: "attack-tower-upgrade-bar-time" },
    defenseTower:{bar: "defense-tower-upgrade-bar",   fill: "defense-tower-upgrade-bar-fill",   time: "defense-tower-upgrade-bar-time" },
    market:     { bar: "market-upgrade-bar",          fill: "market-upgrade-bar-fill",          time: "market-upgrade-bar-time" },
    heroesHall: { bar: "heroes-hall-upgrade-bar",     fill: "heroes-hall-upgrade-bar-fill",     time: "heroes-hall-upgrade-bar-time" },
    booster:    { bar: "booster-tower-upgrade-bar",   fill: "booster-tower-upgrade-bar-fill",   time: "booster-tower-upgrade-bar-time" },
    hospital:   { bar: "hospital-upgrade-bar",        fill: "hospital-upgrade-bar-fill",        time: "hospital-upgrade-bar-time" },
  };

  const ids = idMap[buildingKey];
  if (!ids) return;

  const barEl  = document.getElementById(ids.bar);
  const fillEl = document.getElementById(ids.fill);

  // time Ù…Ù…ÙƒÙ† ÙŠÙƒÙˆÙ† Ø¬ÙˆÙ‡ Ø§Ù„Ø¨Ø§Ø± Ø£Ùˆ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù†Ù‰
  let timeEl = document.getElementById(ids.time);
  if (!timeEl && barEl) {
    timeEl = barEl.querySelector("#" + ids.time);
  }

  if (!barEl || !fillEl || !timeEl) return;

  if (!upgrade || !upgrade.inProgress || !upgrade.totalTime) {
    barEl.style.display = "none";
    fillEl.style.width = "0%";
    timeEl.textContent = "";
    return;
  }

  barEl.style.display = "block";

  const total = upgrade.totalTime;
  const remaining = Math.max(0, upgrade.remainingTime || 0);
  const ratio = Math.max(0, Math.min(1, (total - remaining) / total));
  const percent = Math.round(ratio * 100);

  fillEl.style.width = percent + "%";

  const m = Math.floor(remaining / 60);
  const s = remaining % 60;
  const mm = m.toString().padStart(2, "0");
  const ss = s.toString().padStart(2, "0");
  timeEl.textContent = `${mm}:${ss}`;
}







function loadBuildingsState() {
  try {
    const raw = localStorage.getItem("raidex_buildings_state");
    if (raw) {
      unlockedBuildings = JSON.parse(raw);
    }
  } catch (e) {
    console.error("Error loading buildings state", e);
  }
}

function saveBuildingsState() {
  try {
    localStorage.setItem("raidex_buildings_state", JSON.stringify(unlockedBuildings));
  } catch (e) {
    console.error("Error saving buildings state", e);
  }
}

// ØªØ­Ø¯ÙŠØ« ÙØªØ­ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø­Ø³Ø¨ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ù„Ø¹Ø©
function recalcBuildingsUnlockByCastleLevel() {
  Object.values(BUILDINGS_CONFIG).forEach((cfg) => {
    const isUnlocked = castleLevel >= cfg.unlockLevel;
    unlockedBuildings[cfg.key] = !!isUnlocked;
  });
  saveBuildingsState();
}
function loadDailyLoginState() {
  try {
    const raw = localStorage.getItem("raidex_daily_login_v1");
    if (!raw) {
      dailyLoginState = {
        lastLoginDate: null,
        claimedDays: [],
        currentDay: 0
      };
      return;
    }

    const state = JSON.parse(raw);
    dailyLoginState = state;

    // ØªØ­Ù‚Ù‚: Ù„Ùˆ Ø§Ù„ÙŠÙˆÙ… Ø§ØªØºÙŠØ±ØŒ Ù†Ø¹Ù„Ù‘Ù… Ø¥Ù† Ø§Ù„ÙŠÙˆÙ… Ø¯Ù‡ Ù…ØªØ§Ø­ Ù„Ù„Ù€Claim
    const todayStr = new Date().toDateString();
    if (state.lastLoginDate !== todayStr) {
      // Ø§Ù„ÙŠÙˆÙ… Ø¬Ø¯ÙŠØ¯ØŒ Ø§Ù„Ù„Ø§Ø¹Ø¨ Ù„Ø³Ù‡ Ù…Ø§ Ø³Ø¬Ù„Ø´
      // Ù…Ø´ Ù‡Ù†Ø¹Ù…Ù„ Ø­Ø§Ø¬Ø© Ù‡Ù†Ø§ØŒ Ø¨Ø³ ÙÙŠ Ø§Ù„Ù€UI Ù‡Ù†Ø¸Ù‡Ø± Ø¨Ø§Ù†Ø±
    }

    // Ù„Ùˆ Ø¹Ø¯Ù‰ Ø£ÙƒØªØ± Ù…Ù† ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ØŒ Ù†ØµÙÙ‘Ø± Ø§Ù„Ø³Ù„Ø³Ù„Ø© (optional - Ø­Ø³Ø¨ Ù„Ùˆ Ø¹Ø§ÙŠØ² streak ØµØ§Ø±Ù…)
    // Ø¯Ù„ÙˆÙ‚ØªÙŠ Ù‡Ù†Ø³ÙŠØ¨Ù‡Ø§: Ø§Ù„Ù„Ø§Ø¹Ø¨ ÙŠÙ‚Ø¯Ø± ÙŠØ³ØªÙ„Ù… Ø£ÙŠ ÙŠÙˆÙ… Ø­ØªÙ‰ Ù„Ùˆ ÙØ§Øª ÙŠÙˆÙ…

  } catch (e) {
    console.error("Error loading daily login state", e);
    dailyLoginState = {
      lastLoginDate: null,
      claimedDays: [],
      currentDay: 0
    };
  }
}
function saveDailyLoginState() {
  try {
    localStorage.setItem("raidex_daily_login_v1", JSON.stringify(dailyLoginState));
  } catch (e) {
    console.error("Error saving daily login state", e);
  }
}

function loadTasksState() {
  try {
    const raw = localStorage.getItem("raidex_tasks_state_v1");
    if (!raw) {
      // Ø£ÙˆÙ„ Ù…Ø±Ø©
      mainTasksState = {};
      dailyTasksState = {};
      weeklyTasksState = {};
      socialTasksState = {};
      dailyPoints = 0;
      weeklyPoints = 0;
      DAILY_CHESTS.forEach(c => (c.claimed = false));
      WEEKLY_CHESTS.forEach(c => (c.claimed = false));
      return;
    }

    const state = JSON.parse(raw);

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø®Ø²Ù†Ø©
    mainTasksState = state.mainTasksState || {};
    dailyTasksState = state.dailyTasksState || {};
    weeklyTasksState = state.weeklyTasksState || {};
    socialTasksState = state.socialTasksState || {};

    dailyPoints = state.dailyPoints || 0;
    weeklyPoints = state.weeklyPoints || 0;

    if (state.dailyChests) {
      DAILY_CHESTS.forEach(chest => {
        const saved = state.dailyChests[chest.id];
        if (saved && typeof saved.claimed === "boolean") {
          chest.claimed = saved.claimed;
        }
      });
    }

    if (state.weeklyChests) {
      WEEKLY_CHESTS.forEach(chest => {
        const saved = state.weeklyChests[chest.id];
        if (saved && typeof saved.claimed === "boolean") {
          chest.claimed = saved.claimed;
        }
      });
    }

    // --- Daily reset ---
    const todayStr = new Date().toDateString();
    if (state.lastDailyDate !== todayStr) {
      dailyPoints = 0;
      dailyTasksState = {};
      DAILY_CHESTS.forEach(c => (c.claimed = false));
    }

    // --- Weekly reset ---
    const nowTs = Date.now();
    const lastWeeklyTs = state.lastWeeklyTimestamp || 0;
    const sevenDaysMs = 7 * 24 * 60 * 60 * 1000;
    if (!lastWeeklyTs || nowTs - lastWeeklyTs >= sevenDaysMs) {
      weeklyPoints = 0;
      weeklyTasksState = {};
      WEEKLY_CHESTS.forEach(c => (c.claimed = false));
    }
        recalcTasksNotification();

  } catch (e) {
    console.error("Error loading tasks state", e);
    mainTasksState = {};
    dailyTasksState = {};
    weeklyTasksState = {};
    socialTasksState = {};
    dailyPoints = 0;
    weeklyPoints = 0;
    DAILY_CHESTS.forEach(c => (c.claimed = false));
    WEEKLY_CHESTS.forEach(c => (c.claimed = false));
  }
}

function saveTasksState() {
  try {
    const dailyChestsState = {};
    DAILY_CHESTS.forEach(chest => {
      dailyChestsState[chest.id] = { claimed: !!chest.claimed };
    });

    const weeklyChestsState = {};
    WEEKLY_CHESTS.forEach(chest => {
      weeklyChestsState[chest.id] = { claimed: !!chest.claimed };
    });

 const now = new Date();

const state = {
  mainTasksState,
  dailyTasksState,
  weeklyTasksState,
  socialTasksState,
  dailyPoints,
  weeklyPoints,
  dailyChests: dailyChestsState,
  weeklyChests: weeklyChestsState,
  lastDailyDate: now.toDateString(),
  lastWeeklyTimestamp: now.getTime()
};


    localStorage.setItem("raidex_tasks_state_v1", JSON.stringify(state));
    recalcTasksNotification();
  } catch (e) {
    console.error("Error saving tasks state", e);
  }
}


function loadGameState() {
  loadTasksState();
  loadDailyLoginState();
  updateDailyLoginBanner();
  updateDailyLoginIcon();

  try {
    const raw = localStorage.getItem("raidex_game_state_v3");
    if (!raw) return;

    const state = JSON.parse(raw);

    // Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ù„Ø¹Ø©
    if (state.castleLevel != null) {
      castleLevel = state.castleLevel;
    }

    // Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
    if (state.resources) {
      resources = {
        ...resources,
        ...state.resources,
      };
    }

    // Ø¯Ø¹Ù… Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ… Ù„Ùˆ Ù„Ø³Ù‡ Ù…ØªØ®Ø²Ù†
    if (state.goldMineLevel != null) {
      goldMineLevel = state.goldMineLevel;
      buildingLevels.goldMine = goldMineLevel;
    }

    // ØªØ­Ù…ÙŠÙ„ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© (Ø§Ù„Ø°Ù‡Ø¨/Ø§Ù„Ø®Ø´Ø¨/Ø§Ù„Ù…Ø²Ø±Ø¹Ø©... Ø¥Ù„Ø®)
    if (state.buildingLevels) {
      buildingLevels = {
        ...buildingLevels,        // Ø§Ù„Ø¯ÙŠÙÙˆÙ„Øª (Ù„Ùˆ ÙÙŠ Ù…ÙØ§ØªÙŠØ­ Ø¬Ø¯ÙŠØ¯Ø©)
        ...state.buildingLevels,  // Ø§Ù„Ù„ÙŠ Ù…ØªØ®Ø²Ù† ÙÙŠ Ø§Ù„Ù€ localStorage
      };
    }

    // ØªØ­Ù…ÙŠÙ„ ØªØ±Ù‚ÙŠØ§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ø¬Ø§Ø±ÙŠØ©
    if (state.buildingUpgrades) {
      buildingUpgrades = {
        ...buildingUpgrades,
        ...state.buildingUpgrades,
      };

      const now = Date.now();
      let hasAnyInProgress = false;

      for (const key in buildingUpgrades) {
        const up = buildingUpgrades[key];
        if (!up || !up.inProgress || !up.finishAt) continue;

        const diffMs = up.finishAt - now;
        if (diffMs <= 0) {
          // Ø§Ù„ÙˆÙ‚Øª Ø®Ù„Øµ ÙˆØ§Ù„Ù„Ø¹Ø¨Ø© ÙƒØ§Ù†Øª Ù…Ù‚ÙÙˆÙ„Ø© â†’ Ù†Ø®Ù„ÙŠÙ‡Ø§ ØªØ®Ù„Øµ ÙÙŠ Ø£ÙˆÙ„ Ø¯ÙˆØ±Ø© Ù„Ù„ØªØ§ÙŠÙ…Ø±
          up.remainingTime = 0;
        } else {
          up.remainingTime = Math.floor(diffMs / 1000);
          hasAnyInProgress = true;
        }
      }

      if (hasAnyInProgress) {
        startBuildingUpgradeTimer();
      }
    }

    // Ø­Ø§Ù„Ø© ØªØ±Ù‚ÙŠØ© Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨ (Ù„Ùˆ Ù„Ø³Ù‡ Ù…Ø³ØªØ®Ø¯Ù…Ø©)
    goldMineUpgradeInProgress = !!state.goldMineUpgradeInProgress;
    goldMineUpgradeFinishAt = state.goldMineUpgradeFinishAt || null;

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù„Ù‚Ù„Ø¹Ø©
    upgradeInProgress = !!state.upgradeInProgress;
    upgradeFinishAt = state.upgradeFinishAt || null;

    // Ø­Ø§Ù„Ø© ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ø¬ÙŠØ´ Ø§Ù„Ù‡Ø¬ÙˆÙ…ÙŠ
    attackTrainingInProgress = !!state.attackTrainingInProgress;
    attackTrainingFinishAt = state.attackTrainingFinishAt || null;
    attackTrainingRemainingTime = state.attackTrainingRemainingTime || 0;
    attackTrainingTotalTime = state.attackTrainingTotalTime || 0;
    currentTrainingHeroKey = state.currentTrainingHeroKey || null;
    currentTrainingUnitKey = state.currentTrainingUnitKey || null;
    currentTrainingAmount = state.currentTrainingAmount || 0;

    // Ø­Ø§Ù„Ø© ØªØ¯Ø±ÙŠØ¨ Ø¬ÙŠØ´ Ø§Ù„ØµØ­Ø©
    healthTrainingInProgress = !!state.healthTrainingInProgress;
    healthTrainingFinishAt = state.healthTrainingFinishAt || null;
    healthTrainingRemainingTime = state.healthTrainingRemainingTime || 0;
    healthTrainingTotalTime = state.healthTrainingTotalTime || 0;
    currentHealthTrainingHeroKey = state.currentHealthTrainingHeroKey || null;
    currentHealthTrainingUnitKey = state.currentHealthTrainingUnitKey || null;
    currentHealthTrainingAmount = state.currentHealthTrainingAmount || 0;

    if (healthTrainingInProgress && healthTrainingFinishAt) {
      const now = Date.now();
      const diffMs = healthTrainingFinishAt - now;
      if (diffMs <= 0) {
        healthTrainingRemainingTime = 0;
        finishHealthTraining();
      } else {
        healthTrainingRemainingTime = Math.floor(diffMs / 1000);
        startHealthTrainingTimer();
      }
    }

    // Ù„Ùˆ ÙÙŠ ØªØ¯Ø±ÙŠØ¨ Ù‡Ø¬ÙˆÙ…ÙŠ Ø¬Ø§Ø±ÙŠØŒ Ù†Ø±Ø¬Ù‘Ø¹ Ø§Ù„ØªØ§ÙŠÙ…Ø±
    if (attackTrainingInProgress && attackTrainingFinishAt) {
      const now = Date.now();
      const diffMs = attackTrainingFinishAt - now;
      if (diffMs <= 0) {
        attackTrainingRemainingTime = 0;
        // finishAttackTraining Ù‡ØªÙƒÙ…Ù„ Ø¨Ø¹Ø¯ÙŠÙ†
      } else {
        attackTrainingRemainingTime = Math.floor(diffMs / 1000);
        startAttackTrainingTimer();
      }
    }

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ Ø¹Ø¯Ø§Ø¯ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø©
    if (upgradeInProgress && upgradeFinishAt) {
      const now = Date.now();
      const diffMs = upgradeFinishAt - now;

      if (diffMs <= 0) {
        // Ø§Ù„ÙˆÙ‚Øª Ø®Ù„Øµ ÙˆØ§Ù„Ù„Ø¹Ø¨Ø© ÙƒØ§Ù†Øª Ù…Ù‚ÙÙˆÙ„Ø© â†’ Ù†ÙƒÙ…Ù‘Ù„ Ø§Ù„ØªØ±Ù‚ÙŠØ© ÙÙˆØ±Ù‹Ø§
        finishCastlePanelUpgrade();
      } else {
        // Ù„Ø³Ù‡ Ø¨Ø§Ù‚ÙŠ ÙˆÙ‚Øª â†’ Ù†Ø±Ø¬Ù‘Ø¹ Ø§Ù„Ø¹Ø¯Ù‘Ø§Ø¯ ÙˆØ´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
        const remainingSec = Math.floor(diffMs / 1000);
        const totalTime = remainingSec;

        upgradeRemainingTime = remainingSec;

        const progressWrapper = document.getElementById("castle-upgrade-progress-wrapper");
        const progressFill = document.getElementById("castle-upgrade-progress-fill");
        const remainingTimeEl = document.getElementById("castle-upgrade-remaining-time");

        if (progressWrapper) progressWrapper.style.display = "block";
        if (remainingTimeEl) remainingTimeEl.textContent = formatDuration(upgradeRemainingTime);

        if (upgradeInterval) clearInterval(upgradeInterval);

        upgradeInterval = setInterval(() => {
          upgradeRemainingTime -= 1;
          if (upgradeRemainingTime < 0) upgradeRemainingTime = 0;

          if (remainingTimeEl) {
            remainingTimeEl.textContent = formatDuration(upgradeRemainingTime);
          }

          const ratio = totalTime > 0 ? upgradeRemainingTime / totalTime : 0;
          if (progressFill) {
            const percent = Math.max(0, Math.min(100, ratio * 100));
            progressFill.style.width = percent + "%";
          }

          if (upgradeRemainingTime <= 0) {
            clearInterval(upgradeInterval);
            upgradeInterval = null;
            finishCastlePanelUpgrade();
          }
        }, 1000);
      }
    }

    recalculatePower();
  } catch (e) {
    console.error("Error loading game state", e);
  }
}



// Ø³Ø¹Ø© ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù‚Ù„Ø¹Ø©
function getCastleStorageCapacity(level) {
  const baseStorage = 50000;      // Ø³Ø¹Ø© Ù…Ø¨Ø¯Ø¦ÙŠØ©
  const perLevel = 5000;          // Ø²ÙŠØ§Ø¯Ø© Ø«Ø§Ø¨ØªØ© Ù„ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰
  const growth = 1.03;            // Ù†Ù…Ùˆ Ø¨Ø³ÙŠØ·
  const linearPart = baseStorage + perLevel * (level - 1);
  return Math.floor(linearPart * Math.pow(growth, level - 1));
}
function formatDuration(totalSeconds) {
  totalSeconds = Math.max(0, Math.floor(totalSeconds));

  const days = Math.floor(totalSeconds / 86400);
  const hours = Math.floor((totalSeconds % 86400) / 3600);
  const minutes = Math.floor((totalSeconds % 3600) / 60);
  const seconds = totalSeconds % 60;

  // Ù„Ùˆ ÙÙŠ Ø£ÙŠØ§Ù…: Ù†Ø­ÙˆÙ„Ù‡Ø§ Ù„ØµÙŠØºØ© day.hour
  if (days > 0) {
    const hInDay = hours.toString().padStart(2, "0");
    return days + "." + hInDay + "D";
  }

  // Ù„Ùˆ ÙÙŠ Ø³Ø§Ø¹Ø§Øª: hh.mm h (Ø§Ù„Ø¯Ù‚Ø§ÙŠÙ‚ 2 digits)
  if (hours > 0) {
    const mStr = minutes.toString().padStart(2, "0");
    return hours + "." + mStr + "h";
  }

  // Ù„Ùˆ Ù…ÙÙŠØ´ Ø³Ø§Ø¹Ø§Øª: mm.ss m (Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ 2 digits)
  const sStr = seconds.toString().padStart(2, "0");
  return minutes + "." + sStr + "m";
}



function getCastlePowerForLevel(level) {
  // Ù‚ÙˆØ© Ø£Ø³Ø§Ø³ÙŠØ© Ø¨ØªÙƒØ¨Ø± Ø¨Ù†Ø³Ø¨Ø© 15% ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰
  const base = 100;
  const growth = 1.15;
  let power = Math.floor(base * Math.pow(growth, level - 1));

  let bonus = 0;

  // Ù…Ù† 1 Ø¥Ù„Ù‰ 25: ÙƒÙ„ 5 Ù…Ø³ØªÙˆÙŠØ§Øª +10,000
  if (level >= 5) {
    const stepsUpTo25 = Math.min(level, 25);
    const fullSteps = Math.floor(stepsUpTo25 / 5); // 5,10,15,20,25
    bonus += fullSteps * 10000;
  }

  // Ø¨Ø¹Ø¯ 25: Ø§Ù„Ø¨ÙˆÙ†Øµ Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ Ø§Ù„Ù„ÙŠ Ø§ØªÙÙ‚Ù†Ø§ Ø¹Ù„ÙŠÙ‡
  if (level >= 30) bonus += 20000; // Ù…Ø³ØªÙˆÙ‰ 30
  if (level >= 35) bonus += 25000; // Ù…Ø³ØªÙˆÙ‰ 35
  if (level >= 40) bonus += 30000; // Ù…Ø³ØªÙˆÙ‰ 40
  if (level >= 45) bonus += 35000; // Ù…Ø³ØªÙˆÙ‰ 45
  if (level >= 50) bonus += 50000; // Ù…Ø³ØªÙˆÙ‰ 50

  power += bonus;

  return power;
}

function recalculatePower() {
  // Ù‚ÙˆØ© Ø§Ù„Ù‚Ù„Ø¹Ø©
  const castlePower = getCastlePowerForLevel(castleLevel);

  // Ù‚ÙˆØ© Ù…Ù† Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… buildingLevels Ø§Ù„Ù„ÙŠ Ø¹Ù†Ø¯Ùƒ)
  const buildingsPower =
    (buildingLevels.goldMine || 1) * 20 +
    (buildingLevels.woodMine || 1) * 15 +
    (buildingLevels.meatFarm || 1) * 10 +
    (buildingLevels.school || 1) * 25 +
    (buildingLevels.hospital || 1) * 30;

  totalPower = castlePower + buildingsPower;
  updatePowerUI();
}



function updatePowerUI() {
  // Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§ÙˆØ± ÙÙŠ Ø´Ø§Ø´Ø© Ø§Ù„Ù‚Ù„Ø¹Ø© (Ø§Ù„Ø¹Ù†ØµØ± Ø§Ù„Ù‚Ø¯ÙŠÙ…)
  const powerValue = document.getElementById("power-value");
  if (powerValue) {
    powerValue.textContent = totalPower.toString(); // Ø³ÙŠØ¨Ù‡ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ
  }

  // Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§ÙˆØ± ØªØ­Øª ØµÙˆØ±Ø© Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„ ÙÙŠ Ø§Ù„Ù…Ø¯ÙŠÙ†Ø©
  const topbarPower = document.getElementById("topbar-power");
  if (topbarPower) {
    topbarPower.textContent = "Power: " + formatShortNumber(totalPower);
  }

  // Ø±Ù‚Ù… Ø§Ù„Ø¨Ø§ÙˆØ± Ø¯Ø§Ø®Ù„ ÙƒØ§Ø±Øª Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
  const profilePower = document.getElementById("profile-power");
  if (profilePower) {
    profilePower.textContent = formatShortNumber(totalPower);
  }
}

function formatShortNumber(value) {
  if (value >= 1_000_000_000) {
    return (value / 1_000_000_000).toFixed(1).replace(/\.0$/, "") + "B";
  }
  if (value >= 1_000_000) {
    return (value / 1_000_000).toFixed(1).replace(/\.0$/, "") + "M";
  }
  if (value >= 1_000) {
    return (value / 1_000).toFixed(1).replace(/\.0$/, "") + "k";
  }
  return value.toString();
}

// Ù„Ùˆ ÙƒØ§Ù† Ø¹Ù†Ø¯Ùƒ Ù‚Ø¨Ù„ ÙƒØ¯Ù‡ let upgradeTime = 30; Ø³ÙŠØ¨Ù‡Ø§ Ø²ÙŠ Ù…Ø§ Ù‡ÙŠ Ù„Ùˆ ÙÙŠ ÙƒÙˆØ¯ ØªØ§Ù†ÙŠ Ø¨ÙŠØ³ØªØ®Ø¯Ù…Ù‡Ø§
let upgradeInProgress = false;
let upgradeInterval;
let upgradeRemainingTime = 0;
let currentUpgradeType = null; // "castle" Ø¯Ù„ÙˆÙ‚ØªÙŠ

let upgradeFinishAt = null; // ÙˆÙ‚Øª Ø§Ù†ØªÙ‡Ø§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¨Ø§Ù„Ù€ ms
// --- Attack Army Training State ---
let attackTrainingInProgress = false;
let attackTrainingFinishAt = null;       // ØªÙˆÙ‚ÙŠØª Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ (ms)
let attackTrainingRemainingTime = 0;     // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
let attackTrainingTotalTime = 0;         // Ø¥Ø¬Ù…Ø§Ù„ÙŠ ÙˆÙ‚Øª Ø§Ù„Ø¯ÙØ¹Ø© (Ø«ÙˆØ§Ù†ÙŠ)
let attackTrainingInterval = null;       // setInterval Ù„Ù„ØªØ§ÙŠÙ…Ø±

let currentTrainingHeroKey = null;       // Ø§Ù„Ù‡ÙŠØ±Ùˆ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØªØ¯Ø±Ù‘Ø¨ Ù„Ù‡ Ø§Ù„Ø¬ÙŠØ´
let currentTrainingUnitKey = null;       // Ù†ÙˆØ¹ Ø§Ù„Ø¬Ù†Ø¯ÙŠ
let currentTrainingAmount = 0;           // Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù†ÙˆØ¯ ÙÙŠ Ø§Ù„Ø¯ÙØ¹Ø©

// --- Health Army Training State ---
let healthTrainingInProgress = false;
let healthTrainingFinishAt = null; // ms
let healthTrainingRemainingTime = 0;
let healthTrainingTotalTime = 0;
let healthTrainingInterval = null; // setInterval
let currentHealthTrainingHeroKey = null;
let currentHealthTrainingUnitKey = null;
let currentHealthTrainingAmount = 0;

// Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨ - ØªØ±Ù‚ÙŠØ© Ù…Ø³ØªÙ‚Ù„Ø©
let goldMineUpgradeInProgress = false;
let goldMineUpgradeFinishAt = null;
let goldMineUpgradeRemainingTime = 0;
let goldMineUpgradeInterval = null;

// Ø¢Ø®Ø± ØªÙƒÙ„ÙØ© ØªØ±Ù‚ÙŠØ© Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨ (Ù„Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù„Ø§Ø­Ù‚Ù‹Ø§ Ù„Ùˆ Ø­Ø¨ÙŠÙ†Ø§ Ù†Ø¹Ù…Ù„ Ø¥Ù„ØºØ§Ø¡)
let lastGoldMineGoldCost = 0;
let lastGoldMineWoodCost = 0;
let lastGoldMineFoodCost = 0;


// Ø¢Ø®Ø± ØªÙƒÙ„ÙØ© ØªØ±Ù‚ÙŠØ© (Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡)
let lastUpgradeGoldCost = 0;
let lastUpgradeWoodCost = 0;
let lastUpgradeFoodCost = 0;

let tasks = []; // Ø®Ù„ÙŠÙ‡ Ø²ÙŠ Ù…Ø§ ÙƒØ§Ù†


// Ø¯ÙˆØ§Ù„ Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© ÙˆÙˆÙ‚Øª ØªØ·ÙˆÙŠØ± Ø§Ù„Ù‚Ù„Ø¹Ø©
function getCastleUpgradeCost(level) {
  // level = Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù„ÙŠ Ù‡ØªØ·ÙˆÙ‘Ø± Ù…Ù†Ù‡
  return Math.floor(castleBaseGoldCost * Math.pow(1.5, level - 1));
}

function getCastleUpgradeTime(level) {
  const growth = 1.3; // ÙƒÙ„ Ù…Ø³ØªÙˆÙ‰ ÙŠØ²ÙŠØ¯ 30% Ø¹Ù† Ø§Ù„Ù„ÙŠ Ù‚Ø¨Ù„Ù‡
  return Math.floor(castleBaseUpgradeTime * Math.pow(growth, level - 1));
}

function getCastleGoldCost(level) {
  const base = 100;
  const growth = 1.2;
  return Math.floor(base * Math.pow(growth, level - 1));
}

function getCastleWoodCost(level) {
  const base = 80;
  const growth = 1.18;
  return Math.floor(base * Math.pow(growth, level - 1));
}

function getCastleFoodCost(level) {
  const base = 60;
  const growth = 1.18;
  return Math.floor(base * Math.pow(growth, level - 1));
}

// Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨
let goldFromMinePerClick = 10;

function collectGoldFromMine() {
  resources.gold += goldFromMinePerClick;
}

// ---- Tutorial flags ----
const TUTORIAL_DONE_KEY = "tutorial_done";
let tutorialStep = 0;

function markTutorialDone() {
  localStorage.setItem(TUTORIAL_DONE_KEY, "1");
}

function showTutorialStep() {
  const overlay = document.getElementById("tutorial-overlay");
  const textEl = document.getElementById("tutorial-text");
  const nextBtn = document.getElementById("tutorial-next");
  if (!overlay || !textEl || !nextBtn) return;

  overlay.style.display = "flex";

  if (tutorialStep === 0) {
    textEl.textContent = "Ù…Ø±Ø­Ø¨Ù‹Ø§ Ø¨Ùƒ ÙÙŠ Ù…Ø¯ÙŠÙ†ØªÙƒ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©!";
    nextBtn.textContent = "Ø§Ù„ØªØ§Ù„ÙŠ";
    nextBtn.onclick = () => {
      tutorialStep = 1;
      showTutorialStep();
    };
  } else if (tutorialStep === 1) {
    textEl.textContent =
      "Ø£Ù†Øª Ø¹Ù„Ù‰ ÙˆØ´Ùƒ Ø¨Ø¯Ø¡ Ø¨Ù†Ø§Ø¡ Ø¥Ù…Ø¨Ø±Ø§Ø·ÙˆØ±ÙŠØªÙƒ Ø§Ù„Ø®Ø§ØµØ©ØŒ ÙˆÙ‡Ø²ÙŠÙ…Ø© Ø¬Ù…ÙŠØ¹ Ø£Ø¹Ø¯Ø§Ø¦ÙƒØŒ ÙˆØªØµØ¨Ø­ Ù…Ù† Ø£Ù‚ÙˆÙ‰ Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ†ØŒ ÙˆÙ…Ø¹Ùƒ ÙØ±ØµØ© Ù„Ø±Ø¨Ø­ Ø¬ÙˆØ§Ø¦Ø² ÙƒØ¨ÙŠØ±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„Ù„Ø¹Ø¨Ø©.";
    nextBtn.textContent = "Ø§Ø¨Ø¯Ø£ Ø§Ù„Ø¢Ù†";
    nextBtn.onclick = () => {
      tutorialStep = 2;
      overlay.style.display = "none";
      markTutorialDone();    // Ù…Ù‡Ù… Ø¹Ø´Ø§Ù† Ù…Ø§ ÙŠØ´ØªØºÙ„Ø´ ØªØ§Ù†ÙŠ
      openCastleModal();     // ÙŠÙØªØ­ Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¨Ø¹Ø¯ Ø§Ù„Ø±Ø³Ø§Ù„Ø©
    };
  }
}
      /* --- DOM Elements --- */
      const loadingFill1 = document.getElementById("loading-fill1");
      const characterScreen = document.getElementById("character-screen");
      const cityScreen = document.getElementById("city-screen");
      const statsModal = document.getElementById("stats-modal");
      const profileName = document.getElementById("profile-name");
      const profileSub = document.getElementById("profile-sub");
      const profileHeroImg = document.getElementById("profile-hero-img");
      const armyContainer = document.getElementById("army-container");
      const castleModal = document.getElementById("castle-modal");
      const castleProgress = document.getElementById("castle-progress");
      const cancelUpgradeBtn = document.getElementById("cancel-upgrade");
      const startUpgradeBtn = document.getElementById("start-upgrade");
      const castleLevelText = document.getElementById("castle-level");
      const nextLevelText = document.getElementById("next-level");
      const inviteBtn = document.getElementById("invite-btn");
      const invitesPage = document.getElementById("invites-page");
      const inviteLinkInput = document.getElementById("invite-link");
      const castleCancelPopup = document.getElementById("castle-cancel-popup");
      const castleCancelConfirmBtn = document.getElementById("castle-cancel-confirm");
      const castleCancelDismissBtn = document.getElementById("castle-cancel-dismiss");
      const invitedFriendsList = document.getElementById(
        "invited-friends-list"
      );
      const tasksPage = document.getElementById("tasks-page");
      const tasksPageContent = document.getElementById("tasks-page-content");
      const chatPanel = document.getElementById("chat-panel");
const chatInput = document.getElementById("chat-input");
const chatSendBtn = document.getElementById("chat-send-btn");
const chatTabs = document.querySelectorAll(".chat-tab");
const chatAreas = {
  global: document.getElementById("chat-global"),
  clan: document.getElementById("chat-clan"),
  friends: document.getElementById("chat-friends"),
  system: document.getElementById("chat-system"),
};
if (cityScreen) {
  cityScreen.addEventListener("click", (e) => {
    const popup = document.getElementById("building-popup");

    // Ù„Ùˆ Ø§Ù„Ø¶ØºØ· ÙƒØ§Ù† Ø¹Ù„Ù‰ Ø§Ù„Ø¨Ø§Ù„ÙˆÙ†Ø© Ù†ÙØ³Ù‡Ø§ Ù…Ø§ Ù†Ø¹Ù…Ù„Ø´ Ø­Ø§Ø¬Ø©
    if (popup && popup.contains(e.target)) return;

    // Ù„Ùˆ Ø§Ù„Ø¶ØºØ· ÙƒØ§Ù† Ø¹Ù„Ù‰ Ù…Ø¨Ù†Ù‰ (Ø§Ù„Ø¹Ù†ØµØ± Ø¹Ù„ÙŠÙ‡ id Ø²ÙŠ building-1)
    // Ù†Ø®Ù„ÙŠÙ‡ ÙŠØ¹Ø¯Ù‘ÙŠ Ù„Ù„Ù€ onclick Ø¨ØªØ§Ø¹ Ø§Ù„Ù…Ø¨Ù†Ù‰
    const buildingEl = e.target.closest("[id^='building-']");
    if (buildingEl) return;

    // ØºÙŠØ± ÙƒØ¯Ù‡: ÙØ¶ÙŠ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
    const oldHighlight = document.querySelector(".building-highlight");
    if (oldHighlight) oldHighlight.classList.remove("building-highlight");

    if (popup && popup.parentNode) {
      popup.parentNode.removeChild(popup);
    }

    const actions = document.getElementById("building-bottom-actions");
    if (actions) actions.style.display = "none";

    currentBuildingKey = null;
  });
}


// ---------------- Building Panel Elements ----------------
const buildingPanel = document.getElementById("building-panel");
const buildingPanelTitle = document.getElementById("building-panel-title");
const buildingPanelImage = document.getElementById("building-panel-image");
const buildingPanelDesc  = document.getElementById("building-panel-desc");
const buildingPanelExtra = document.getElementById("building-panel-extra-info");

const buildingTabInfoBtn    = document.getElementById("building-tab-info-btn");
const buildingTabUpgradeBtn = document.getElementById("building-tab-upgrade-btn");
const buildingTabInfo       = document.getElementById("building-tab-info");
const buildingTabUpgrade    = document.getElementById("building-tab-upgrade");

const buildingPanelUpgradeBtn = document.getElementById("building-panel-upgrade-btn");
const buildingPanelCloseBtn   = document.getElementById("building-panel-close-btn");

// Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­ (goldMine / woodMine / meatFarm)
let currentMiningBuildingKey = null;

function switchBuildingPanelTab(tab) {
  if (tab === 'info') {
    if (buildingTabInfo)    buildingTabInfo.style.display = 'block';
    if (buildingTabUpgrade) buildingTabUpgrade.style.display = 'none';

    if (buildingTabInfoBtn)    buildingTabInfoBtn.style.display = 'inline-block';
    if (buildingTabUpgradeBtn) buildingTabUpgradeBtn.style.display = 'none';
  } else {
    if (buildingTabInfo)    buildingTabInfo.style.display = 'none';
    if (buildingTabUpgrade) buildingTabUpgrade.style.display = 'block';

    if (buildingTabInfoBtn)    buildingTabInfoBtn.style.display = 'none';
    if (buildingTabUpgradeBtn) buildingTabUpgradeBtn.style.display = 'inline-block';
  }
}

if (buildingTabInfoBtn) {
  buildingTabInfoBtn.onclick = function () {
    switchBuildingPanelTab('info');
  };
}

if (buildingTabUpgradeBtn) {
  buildingTabUpgradeBtn.onclick = function () {
    switchBuildingPanelTab('upgrade');
  };
}

buildingPanelCloseBtn.onclick = function () {
  buildingPanel.classList.add('hidden');
};


      /* --- Loading --- */
      function fillLoadingBar(callback) {
        let width = 0;
        const interval = setInterval(() => {
          width++;
          loadingFill1.style.width = width + "%";
          loadingFill1.textContent = width + "%";
          if (width >= 100) {
            clearInterval(interval);
            document.getElementById("loading1").style.display = "none";
            if (callback) callback();
          }
        }, 30);
      }

      /* --- Character Selection --- */
      function choose(hero) {
        currentHero = hero;
        localStorage.setItem("hero", hero);
        characterScreen.style.display = "none";
        enterCity();
      }
/* --- City --- */
function enterCity() {
  cityScreen.style.display = "block";

  if (!document.getElementById("city-bg")) {
    const cityMap = document.createElement("img");
    cityMap.id = "city-bg";
    cityMap.src = "city-bg.png";
    cityMap.style.width = "100%";
    cityMap.style.height = "100%";
    cityMap.style.position = "absolute";
    cityMap.style.top = "0";
    cityMap.style.left = "0";
    cityScreen.appendChild(cityMap);

   // Ø§Ù„Ù‚Ù„Ø¹Ø© ÙÙŠ Ø§Ù„Ù†Øµ
const castleWrapper = document.createElement("div");
castleWrapper.id = "castle-building";
castleWrapper.style.position = "absolute";
castleWrapper.style.width = "170px";
castleWrapper.style.left = "50%";
castleWrapper.style.top = "45%";
castleWrapper.style.transform = "translate(-50%, -50%)";
castleWrapper.style.zIndex = 100;

const castle = document.createElement("img");
castle.src = currentHero + "_castle.png";
castle.style.width = "100%";
castle.style.height = "100%";
castle.style.objectFit = "contain";
castle.style.pointerEvents = "none";
castleWrapper.appendChild(castle);

// ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ù„Ø¹Ø© ØªØ­Øª Ø§Ù„Ù…Ø¨Ù†Ù‰
const castleStatusBox = document.createElement("div");
castleStatusBox.id = "castle-status-box";
castleStatusBox.style.position = "absolute";
castleStatusBox.style.bottom = "-20px";
castleStatusBox.style.left = "50%";
castleStatusBox.style.transform = "translateX(-50%)";
castleStatusBox.style.background = "rgba(0,0,0,0.7)";
castleStatusBox.style.padding = "3px 8px";
castleStatusBox.style.borderRadius = "8px";
castleStatusBox.style.fontSize = "11px";
castleStatusBox.style.minWidth = "80px";
castleStatusBox.style.textAlign = "center";

castleStatusBox.textContent = "Castle Lv." + castleLevel;
castleWrapper.appendChild(castleStatusBox);

castleWrapper.addEventListener("click", openCastlePanel);

cityScreen.appendChild(castleWrapper);

    // 10 Ù…Ø¨Ø§Ù†ÙŠ Ø­ÙˆØ§Ù„ÙŠÙ† Ø§Ù„Ù‚Ù„Ø¹Ø© (placeholder)
    const buildingPositions = [
      { left: "50%", top: "20%" }, // 1
      { left: "74%", top: "26%" }, // 2
      { left: "82%", top: "50%" }, // 3
      { left: "74%", top: "74%" }, // 4
      { left: "50%", top: "82%" }, // 5
      { left: "26%", top: "74%" }, // 6
      { left: "18%", top: "50%" }, // 7
      { left: "26%", top: "26%" }, // 8
      { left: "64%", top: "36%" }, // 9
      { left: "36%", top: "64%" }  // 10
    ];

// Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© 1..10
buildingPositions.forEach((pos, index) => {
  const id = "building-" + (index + 1);
  let b = document.getElementById(id);
  if (!b) {
    b = document.createElement("div");
    b.id = id;
    b.className = "city-building";
    cityScreen.appendChild(b);
  }

  b.style.position = "absolute";
  b.style.width = "60px";
  b.style.height = "60px";
  b.style.left = pos.left;
  b.style.top = pos.top;
  b.style.transform = "translate(-50%, -50%)";
  b.style.borderRadius = "12px";
  b.style.background = "rgba(0,0,0,0.6)";
  b.style.border = "2px solid #facc15";
  b.style.display = "flex";
  b.style.alignItems = "center";
  b.style.justifyContent = "center";
  b.style.color = "#fff";
  b.style.fontWeight = "bold";
  b.style.fontSize = "16px";
  b.style.zIndex = 90;
  b.textContent = index + 1;

  // Ø´Ø±ÙŠØ· Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø³ÙÙ„ÙŠ Ù„ÙƒÙ„ Ù…Ø¨Ù†Ù‰ (Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠÙ‹Ø§)
  let upgradeBar = b.querySelector(".building-upgrade-bar");
  if (!upgradeBar) {
    console.log("Creating upgrade bar for", id);

    upgradeBar = document.createElement("div");
    upgradeBar.className = "building-upgrade-bar";
    upgradeBar.style.position = "absolute";
    upgradeBar.style.left = "10%";
    upgradeBar.style.right = "10%";
    upgradeBar.style.bottom = "4px";
    upgradeBar.style.height = "4px";
    upgradeBar.style.background = "rgba(15,23,42,0.8)";
    upgradeBar.style.borderRadius = "999px";
    upgradeBar.style.overflow = "hidden";
    upgradeBar.style.display = "none";

    const fill = document.createElement("div");
    fill.className = "building-upgrade-bar-fill";
    fill.style.width = "0%";
    fill.style.height = "100%";
    fill.style.background = "#0ea5e9";

    upgradeBar.appendChild(fill);
    b.appendChild(upgradeBar);
  } else {
    console.log("Upgrade bar already exists for", id);
  }
});


// 1: Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨ (building-1)
const goldMine = document.getElementById("building-1");
if (goldMine) {
  goldMine.style.border = "none";
goldMine.style.background = "transparent";
  goldMine.style.width = "120px";
  goldMine.style.height = "140px";
  goldMine.style.position = "absolute";
  goldMine.style.left = buildingPositions[0].left;
  goldMine.style.top = buildingPositions[0].top;
  goldMine.style.transform = "translate(-50%, -50%)";
  goldMine.style.zIndex = 95;
  goldMine.innerHTML = "";

  const goldImg = document.createElement("img");
  goldImg.src = "goldmine.png";
  goldImg.style.width = "100%";
  goldImg.style.height = "100%";
  goldImg.style.objectFit = "contain";
  goldImg.style.pointerEvents = "none";
  goldMine.appendChild(goldImg);

  // ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨ ØªØ­Øª Ø§Ù„Ù…Ø¨Ù†Ù‰
  const goldStatusBox = document.createElement("div");
  goldStatusBox.id = "gold-mine-status-box";
  goldStatusBox.style.position = "absolute";
  goldStatusBox.style.bottom = "-18px";
  goldStatusBox.style.left = "50%";
  goldStatusBox.style.transform = "translateX(-50%)";
  goldStatusBox.style.background = "rgba(0,0,0,0.7)";
  goldStatusBox.style.padding = "2px 6px";
  goldStatusBox.style.borderRadius = "8px";
  goldStatusBox.style.fontSize = "10px";
  goldStatusBox.style.minWidth = "70px";
  goldStatusBox.style.textAlign = "center";
  goldStatusBox.textContent = "Lv." + (buildingLevels.goldMine || 1);
  goldMine.appendChild(goldStatusBox);

  // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… ØªØ±Ù‚ÙŠØ© Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨ ØªØ­Øª Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
  let goldBar = document.getElementById("gold-mine-upgrade-bar");
  if (!goldBar) {
    goldBar = document.createElement("div");
    goldBar.id = "gold-mine-upgrade-bar";
    goldBar.style.position = "absolute";
    goldBar.style.bottom = "-32px";
    goldBar.style.left = "50%";
    goldBar.style.transform = "translateX(-50%)";
    goldBar.style.width = "100px";
    goldBar.style.height = "10px";
    goldBar.style.background = "rgba(15,23,42,0.9)";
    goldBar.style.borderRadius = "999px";
    goldBar.style.overflow = "hidden";
    goldBar.style.display = "none";

    const goldFill = document.createElement("div");
    goldFill.id = "gold-mine-upgrade-bar-fill";
    goldFill.style.width = "0%";
    goldFill.style.height = "100%";
    goldFill.style.background = "#facc15";

    goldBar.appendChild(goldFill);
    goldMine.appendChild(goldBar);

 // Ù†Øµ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªØ­Øª Ø§Ù„Ø´Ø±ÙŠØ·
let goldTime = document.getElementById("gold-mine-upgrade-remaining-time");
if (!goldTime) {
  goldTime = document.createElement("div");
  goldTime.id = "gold-mine-upgrade-remaining-time";
  goldTime.className = "building-upgrade-time";
  goldTime.style.position = "absolute";
  goldTime.style.bottom = "-44px";
  goldTime.style.left = "50%";
  goldTime.style.transform = "translateX(-50%)";
  goldTime.textContent = "";
  goldMine.appendChild(goldTime);
}
  }

  // Ù‡Ù†Ø§ Ù‡Ù†Ø³ØªØ®Ø¯Ù… Ø±Ù‚Ù… Ø«Ø§Ø¨Øª: Ù„Ø­Ø¯ Ù…Ø§ Ù†ÙˆØµÙ„ Ù„ÙŠÙÙŠÙ„ 2 Ø§Ù„Ù…Ù†Ø¬Ù… Ù…Ù‚ÙÙˆÙ„
  if (castleLevel < 2) {
    goldMine.style.filter = "grayscale(1)";
    goldMine.style.opacity = "0.5";

    const lock = document.createElement("div");
    lock.textContent = "ğŸ”’ Lv.2";
    lock.style.position = "absolute";
    lock.style.bottom = "4px";
    lock.style.left = "50%";
    lock.style.transform = "translateX(-50%)";
    lock.style.background = "rgba(0,0,0,0.7)";
    lock.style.padding = "2px 6px";
    lock.style.borderRadius = "8px";
    lock.style.fontSize = "10px";
    goldMine.appendChild(lock);

    goldMine.onclick = function () {
      alert("Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨ Ù…Ù‚ÙÙˆÙ„.\nÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ 2 Ø£ÙˆÙ„Ø§Ù‹.");
    };
  } else {
    goldMine.style.filter = "none";
    goldMine.style.opacity = "1";
    goldMine.onclick = function () {
      showBuildingPopup("goldMine");
    };
  }
}


// 2: Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨ (building-2)
const woodMine = document.getElementById("building-2");
if (woodMine) {
  const requiredLevel = 2; // ÙŠÙØªØ­ Ø¹Ù†Ø¯ Ù…Ø³ØªÙˆÙ‰ 2

  woodMine.style.border = "none";
  woodMine.style.background = "transparent";
  woodMine.style.width = "120px";
  woodMine.style.height = "140px";
  woodMine.style.position = "absolute";
  woodMine.style.left = buildingPositions[1].left;
  woodMine.style.top = buildingPositions[1].top;
  woodMine.style.transform = "translate(-50%, -50%)";
  woodMine.style.zIndex = 95;
  woodMine.innerHTML = "";

  const img = document.createElement("img");
  img.src = "woodmine.png";
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";
  img.style.pointerEvents = "none";
  woodMine.appendChild(img);

  // ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨
  const woodStatusBox = document.createElement("div");
  woodStatusBox.id = "wood-mine-status-box";
  woodStatusBox.style.position = "absolute";
  woodStatusBox.style.bottom = "-18px";
  woodStatusBox.style.left = "50%";
  woodStatusBox.style.transform = "translateX(-50%)";
  woodStatusBox.style.background = "rgba(0,0,0,0.7)";
  woodStatusBox.style.padding = "2px 6px";
  woodStatusBox.style.borderRadius = "8px";
  woodStatusBox.style.fontSize = "10px";
  woodStatusBox.style.minWidth = "70px";
  woodStatusBox.style.textAlign = "center";

  // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ© (Ù†ÙØ³ Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨)
  let woodBar = document.getElementById("wood-mine-upgrade-bar");
  if (!woodBar) {
    woodBar = document.createElement("div");
    woodBar.id = "wood-mine-upgrade-bar";
    woodBar.style.position = "absolute";
    woodBar.style.bottom = "-30px"; // ØªØ­Øª Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù€ Lv
    woodBar.style.left = "50%";
    woodBar.style.transform = "translateX(-50%)";
    woodBar.style.width = "80px";
    woodBar.style.height = "6px";
    woodBar.style.background = "rgba(15,23,42,0.9)";
    woodBar.style.borderRadius = "999px";
    woodBar.style.overflow = "hidden";
    woodBar.style.display = "none"; // ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©

    const woodFill = document.createElement("div");
    woodFill.id = "wood-mine-upgrade-bar-fill";
    woodFill.style.width = "0%";
    woodFill.style.height = "100%";
    woodFill.style.background = "#facc15";

    woodBar.appendChild(woodFill);
    woodMine.appendChild(woodBar);
  }

// Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ØŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ø§Ù„Ù…Ø¨Ù†Ù‰
let woodTime = document.getElementById("wood-mine-upgrade-bar-time");
if (!woodTime) {
  woodTime = document.createElement("div");
  woodTime.id = "wood-mine-upgrade-bar-time";
  woodTime.className = "building-upgrade-time";
  woodTime.style.position = "absolute";
  woodTime.style.bottom = "-44px"; // ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±
  woodTime.style.left = "50%";
  woodTime.style.transform = "translateX(-50%)";
  woodTime.textContent = "";
  woodMine.appendChild(woodTime);
}


  if (castleLevel < requiredLevel) {
    woodMine.style.filter = "grayscale(1)";
    woodMine.style.opacity = "0.5";

    const lock = document.createElement("div");
    lock.textContent = "ğŸ”’ Lv." + requiredLevel;
    lock.style.position = "absolute";
    lock.style.bottom = "4px";
    lock.style.left = "50%";
    lock.style.transform = "translateX(-50%)";
    lock.style.background = "rgba(0,0,0,0.7)";
    lock.style.padding = "2px 6px";
    lock.style.borderRadius = "8px";
    lock.style.fontSize = "10px";
    woodMine.appendChild(lock);

    woodMine.onclick = function () {
      alert(
        "Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨ Ù…Ù‚ÙÙˆÙ„.\nÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " +
          requiredLevel +
          " Ø£ÙˆÙ„Ø§Ù‹."
      );
    };
  } else {
    woodMine.style.filter = "none";
    woodMine.style.opacity = "1";

    woodMine.onclick = function () {
      showBuildingPopup("woodMine");
    };

    woodStatusBox.textContent = "Lv." + (buildingLevels.woodMine || 1);
    woodMine.appendChild(woodStatusBox);
  }
}





// 3: Ø§Ù„Ù…Ø¯Ø±Ø³Ø© (building-3)
const school = document.getElementById("building-3");
if (school) {
  const requiredLevel = 3; // ØªÙØªØ­ Ø¹Ù†Ø¯ Ù…Ø³ØªÙˆÙ‰ 3

  school.style.border = "none";
  school.style.background = "transparent";
  school.style.width = "100px";
  school.style.height = "160px";
  school.style.position = "absolute";
  school.style.left = buildingPositions[2].left;
  school.style.top = buildingPositions[2].top;
  school.style.transform = "translate(-50%, -50%)";
  school.style.zIndex = 95;
  school.innerHTML = "";

  const img = document.createElement("img");
  img.src = "school.png";
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";
  img.style.pointerEvents = "none";
  school.appendChild(img);

  // ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
  const schoolStatusBox = document.createElement("div");
  schoolStatusBox.id = "school-status-box";
  schoolStatusBox.style.position = "absolute";
  schoolStatusBox.style.bottom = "-18px";
  schoolStatusBox.style.left = "50%";
  schoolStatusBox.style.transform = "translateX(-50%)";
  schoolStatusBox.style.background = "rgba(0,0,0,0.7)";
  schoolStatusBox.style.padding = "2px 6px";
  schoolStatusBox.style.borderRadius = "8px";
  schoolStatusBox.style.fontSize = "10px";
  schoolStatusBox.style.minWidth = "70px";
  schoolStatusBox.style.textAlign = "center";

  // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
  let schoolBar = document.getElementById("school-upgrade-bar");
  if (!schoolBar) {
    schoolBar = document.createElement("div");
    schoolBar.id = "school-upgrade-bar";
    schoolBar.style.position = "absolute";
    schoolBar.style.bottom = "-30px"; // ØªØ­Øª Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù€ Lv
    schoolBar.style.left = "50%";
    schoolBar.style.transform = "translateX(-50%)";
    schoolBar.style.width = "80px";
    schoolBar.style.height = "6px";
    schoolBar.style.background = "rgba(15,23,42,0.9)";
    schoolBar.style.borderRadius = "999px";
    schoolBar.style.overflow = "hidden";
    schoolBar.style.display = "none";

    const fill = document.createElement("div");
    fill.id = "school-upgrade-bar-fill";
    fill.style.width = "0%";
    fill.style.height = "100%";
    fill.style.background = "#facc15";

    schoolBar.appendChild(fill);
    school.appendChild(schoolBar);
  }

 // Ø§Ù„ÙˆÙ‚Øª ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ØŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ø§Ù„Ù…Ø¨Ù†Ù‰ Ù†ÙØ³Ù‡
let schoolTime = document.getElementById("school-upgrade-bar-time");
if (!schoolTime) {
  schoolTime = document.createElement("div");
  schoolTime.id = "school-upgrade-bar-time";
  schoolTime.className = "building-upgrade-time";
  schoolTime.style.position = "absolute";
  schoolTime.style.bottom = "-44px";
  schoolTime.style.left = "50%";
  schoolTime.style.transform = "translateX(-50%)";
  schoolTime.textContent = "";
  school.appendChild(schoolTime);
}

  if (castleLevel < requiredLevel) {
    school.style.filter = "grayscale(1)";
    school.style.opacity = "0.5";

    const lock = document.createElement("div");
    lock.textContent = "ğŸ”’ Lv." + requiredLevel;
    lock.style.position = "absolute";
    lock.style.bottom = "4px";
    lock.style.left = "50%";
    lock.style.transform = "translateX(-50%)";
    lock.style.background = "rgba(0,0,0,0.7)";
    lock.style.padding = "2px 6px";
    lock.style.borderRadius = "8px";
    lock.style.fontSize = "10px";
    school.appendChild(lock);

    school.onclick = function () {
      alert(
        "Ø§Ù„Ù…Ø¯Ø±Ø³Ø© Ù…Ù‚ÙÙˆÙ„Ø©.\nÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " +
          requiredLevel +
          " Ø£ÙˆÙ„Ø§Ù‹."
      );
    };
  } else {
    school.style.filter = "none";
    school.style.opacity = "1";

    // Ø§Ù„Ù…Ø¯Ø±Ø³Ø©
    school.onclick = function () {
      showBuildingPopup("school");
    };

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ØªØ­Øª Ø§Ù„Ù…Ø¨Ù†Ù‰
    schoolStatusBox.textContent = "Lv." + (buildingLevels.school || 1);
    school.appendChild(schoolStatusBox);
  }
}

// 4: Ø¨Ø±Ø¬ Ø§Ù„Ù‡Ø¬ÙˆÙ… (building-4)
const attackTower = document.getElementById("building-4");
if (attackTower) {
  const requiredLevel = 5; // ÙŠÙØªØ­ Ø¹Ù†Ø¯ Ù…Ø³ØªÙˆÙ‰ 5

  attackTower.style.border = "none";
  attackTower.style.background = "transparent";
  attackTower.style.width = "200px";
  attackTower.style.height = "180px";
  attackTower.style.position = "absolute";
  attackTower.style.left = buildingPositions[3].left;
  attackTower.style.top = buildingPositions[3].top;
  attackTower.style.transform = "translate(-50%, -50%)";
  attackTower.style.zIndex = 95;
  attackTower.innerHTML = "";

  const img = document.createElement("img");
  img.src = "attack_tower.png";
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";
  img.style.pointerEvents = "none";
  attackTower.appendChild(img);

  // ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ø¨Ø±Ø¬ Ø§Ù„Ù‡Ø¬ÙˆÙ…
  const attackStatusBox = document.createElement("div");
  attackStatusBox.id = "attack-tower-status-box";
  attackStatusBox.style.position = "absolute";
  attackStatusBox.style.bottom = "-18px";
  attackStatusBox.style.left = "50%";
  attackStatusBox.style.transform = "translateX(-50%)";
  attackStatusBox.style.background = "rgba(0,0,0,0.7)";
  attackStatusBox.style.padding = "2px 6px";
  attackStatusBox.style.borderRadius = "8px";
  attackStatusBox.style.fontSize = "10px";
  attackStatusBox.style.minWidth = "70px";
  attackStatusBox.style.textAlign = "center";

  // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… ØªØ±Ù‚ÙŠØ© Ø¨Ø±Ø¬ Ø§Ù„Ù‡Ø¬ÙˆÙ… (Ù†ÙØ³ Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨)
  let attackBar = document.getElementById("attack-tower-upgrade-bar");
  if (!attackBar) {
    attackBar = document.createElement("div");
    attackBar.id = "attack-tower-upgrade-bar";
    attackBar.style.position = "absolute";
    attackBar.style.bottom = "-30px";
    attackBar.style.left = "50%";
    attackBar.style.transform = "translateX(-50%)";
    attackBar.style.width = "100px";
    attackBar.style.height = "6px";
    attackBar.style.background = "rgba(15,23,42,0.9)";
    attackBar.style.borderRadius = "999px";
    attackBar.style.overflow = "hidden";
    attackBar.style.display = "none";

    const fill = document.createElement("div");
    fill.id = "attack-tower-upgrade-bar-fill";
    fill.style.width = "0%";
    fill.style.height = "100%";
    fill.style.background = "#facc15";

    attackBar.appendChild(fill);
    attackTower.appendChild(attackBar);
  }

// Ø§Ù„ÙˆÙ‚Øª ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ØŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ø§Ù„Ù…Ø¨Ù†Ù‰ Ù†ÙØ³Ù‡ (Ø²ÙŠ gold-mine-upgrade-remaining-time)
let attackTime = document.getElementById("attack-tower-upgrade-bar-time");
if (!attackTime) {
  attackTime = document.createElement("div");
  attackTime.id = "attack-tower-upgrade-bar-time";
  attackTime.className = "building-upgrade-time";
  attackTime.style.position = "absolute";
  attackTime.style.bottom = "-44px";
  attackTime.style.left = "50%";
  attackTime.style.transform = "translateX(-50%)";
  attackTime.textContent = "";
  attackTower.appendChild(attackTime);
}



  if (castleLevel < requiredLevel) {
    attackTower.style.filter = "grayscale(1)";
    attackTower.style.opacity = "0.5";

    const lock = document.createElement("div");
    lock.textContent = "ğŸ”’ Lv." + requiredLevel;
    lock.style.position = "absolute";
    lock.style.bottom = "4px";
    lock.style.left = "50%";
    lock.style.transform = "translateX(-50%)";
    lock.style.background = "rgba(0,0,0,0.7)";
    lock.style.padding = "2px 6px";
    lock.style.borderRadius = "8px";
    lock.style.fontSize = "10px";
    attackTower.appendChild(lock);

    attackTower.onclick = function () {
      alert(
        "Ø¨Ø±Ø¬ Ø§Ù„Ù‡Ø¬ÙˆÙ… Ù…Ù‚ÙÙˆÙ„.\nÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " +
          requiredLevel +
          " Ø£ÙˆÙ„Ø§Ù‹."
      );
    };
  } else {
    attackTower.style.filter = "none";
    attackTower.style.opacity = "1";

    attackTower.onclick = function () {
      showBuildingPopup("attackTower");
    };

    attackStatusBox.textContent =
      "Lv." + (buildingLevels.attackTower || 1);
    attackTower.appendChild(attackStatusBox);
  }
}





// 5: Ø¨Ø±Ø¬ Ø§Ù„Ø¯ÙØ§Ø¹ (building-5)
const defenseTower = document.getElementById("building-5");
if (defenseTower) {
  const requiredLevel = 7; // ÙŠÙØªØ­ Ø¹Ù†Ø¯ Ù…Ø³ØªÙˆÙ‰ 7

  defenseTower.style.border = "none";
  defenseTower.style.background = "transparent";
  defenseTower.style.width = "200px";
  defenseTower.style.height = "180px";
  defenseTower.style.position = "absolute";
  defenseTower.style.left = buildingPositions[4].left;
  defenseTower.style.top = buildingPositions[4].top;
  defenseTower.style.transform = "translate(-50%, -50%)";
  defenseTower.style.zIndex = 95;
  defenseTower.innerHTML = "";

  const img = document.createElement("img");
  img.src = "defense_tower.png";
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";
  img.style.pointerEvents = "none";
  defenseTower.appendChild(img);

  const defenseStatusBox = document.createElement("div");
  defenseStatusBox.id = "defense-tower-status-box";
  defenseStatusBox.style.position = "absolute";
  defenseStatusBox.style.bottom = "-18px";
  defenseStatusBox.style.left = "50%";
  defenseStatusBox.style.transform = "translateX(-50%)";
  defenseStatusBox.style.background = "rgba(0,0,0,0.7)";
  defenseStatusBox.style.padding = "2px 6px";
  defenseStatusBox.style.borderRadius = "8px";
  defenseStatusBox.style.fontSize = "10px";
  defenseStatusBox.style.minWidth = "70px";
  defenseStatusBox.style.textAlign = "center";

  let defenseBar = document.getElementById("defense-tower-upgrade-bar");
  if (!defenseBar) {
    defenseBar = document.createElement("div");
    defenseBar.id = "defense-tower-upgrade-bar";
    defenseBar.style.position = "absolute";
    defenseBar.style.bottom = "-30px";
    defenseBar.style.left = "50%";
    defenseBar.style.transform = "translateX(-50%)";
    defenseBar.style.width = "100px";
    defenseBar.style.height = "6px";
    defenseBar.style.background = "rgba(15,23,42,0.9)";
    defenseBar.style.borderRadius = "999px";
    defenseBar.style.overflow = "hidden";
    defenseBar.style.display = "none";

    const fill = document.createElement("div");
    fill.id = "defense-tower-upgrade-bar-fill";
    fill.style.width = "0%";
    fill.style.height = "100%";
    fill.style.background = "#facc15";
    defenseBar.appendChild(fill);

    defenseTower.appendChild(defenseBar);
  }

// Ø§Ù„ÙˆÙ‚Øª ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ØŒ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø²ÙŠ Ø§Ù„Ø®Ø´Ø¨)
let defenseTime = document.getElementById("defense-tower-upgrade-bar-time");
if (!defenseTime) {
  defenseTime = document.createElement("div");
  defenseTime.id = "defense-tower-upgrade-bar-time";
  defenseTime.className = "building-upgrade-time";
  defenseTime.style.position = "absolute";
  defenseTime.style.bottom = "-44px";
  defenseTime.style.left = "50%";
  defenseTime.style.transform = "translateX(-50%)";
  defenseTime.textContent = "";
  defenseTower.appendChild(defenseTime);
}



  if (castleLevel < requiredLevel) {
    defenseTower.style.filter = "grayscale(1)";
    defenseTower.style.opacity = "0.5";

    const lock = document.createElement("div");
    lock.textContent = "ğŸ”’ Lv." + requiredLevel;
    lock.style.position = "absolute";
    lock.style.bottom = "4px";
    lock.style.left = "50%";
    lock.style.transform = "translateX(-50%)";
    lock.style.background = "rgba(0,0,0,0.7)";
    lock.style.padding = "2px 6px";
    lock.style.borderRadius = "8px";
    lock.style.fontSize = "10px";
    defenseTower.appendChild(lock);

    defenseTower.onclick = function () {
      alert(
        "Ø¨Ø±Ø¬ Ø§Ù„Ø¯ÙØ§Ø¹ Ù…Ù‚ÙÙˆÙ„.\nÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " +
          requiredLevel +
          " Ø£ÙˆÙ„Ø§Ù‹."
      );
    };
  } else {
    defenseTower.style.filter = "none";
    defenseTower.style.opacity = "1";

    defenseTower.onclick = function () {
      showBuildingPopup("defenseTower");
    };

    defenseStatusBox.textContent =
      "Lv." + (buildingLevels.defenseTower || 1);
    defenseTower.appendChild(defenseStatusBox);
  }
}

 // 6: Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù… (building-6)
const meatFarm = document.getElementById("building-6");
if (meatFarm) {
  const requiredLevel = 2; // ØªÙØªØ­ Ø¹Ù†Ø¯ Ù…Ø³ØªÙˆÙ‰ 2

  meatFarm.style.border = "none";
  meatFarm.style.background = "transparent";
  meatFarm.style.width = "170px";
  meatFarm.style.height = "170px";
  meatFarm.style.position = "absolute";
  meatFarm.style.left = buildingPositions[5].left;
  meatFarm.style.top = buildingPositions[5].top;
  meatFarm.style.transform = "translate(-50%, -50%)";
  meatFarm.style.zIndex = 95;
  meatFarm.innerHTML = "";

  const img = document.createElement("img");
  img.src = "meatfarm.png";
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";
  img.style.pointerEvents = "none";
  meatFarm.appendChild(img);

  // ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù… (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ù…ÙØªÙˆØ­)
  const meatStatusBox = document.createElement("div");
  meatStatusBox.id = "meat-farm-status-box";
  meatStatusBox.style.position = "absolute";
  meatStatusBox.style.bottom = "-18px";
  meatStatusBox.style.left = "50%";
  meatStatusBox.style.transform = "translateX(-50%)";
  meatStatusBox.style.background = "rgba(0,0,0,0.7)";
  meatStatusBox.style.padding = "2px 6px";
  meatStatusBox.style.borderRadius = "8px";
  meatStatusBox.style.fontSize = "10px";
  meatStatusBox.style.minWidth = "70px";
  meatStatusBox.style.textAlign = "center";

   // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… ØªØ±Ù‚ÙŠØ© Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù… ØªØ­Øª Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù…Ø³ØªÙˆÙ‰
  let meatBar = document.getElementById("meat-farm-upgrade-bar");
  if (!meatBar) {
    meatBar = document.createElement("div");
    meatBar.id = "meat-farm-upgrade-bar";
    meatBar.style.position = "absolute";
    meatBar.style.bottom = "-30px"; // ØªØ­Øª Ù…Ø±Ø¨Ø¹ Ø§Ù„Ù€ Lv
    meatBar.style.left = "50%";
    meatBar.style.transform = "translateX(-50%)";
    meatBar.style.width = "100px"; // Ø´ÙˆÙŠØ© Ø£ÙˆØ³Ø¹ Ø¹Ø´Ø§Ù† Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø£Ø¹Ø±Ø¶
    meatBar.style.height = "6px";
    meatBar.style.background = "rgba(15,23,42,0.9)";
    meatBar.style.borderRadius = "999px";
    meatBar.style.overflow = "hidden";
    meatBar.style.display = "none"; // ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©

    const meatFill = document.createElement("div");
    meatFill.id = "meat-farm-upgrade-bar-fill";
    meatFill.style.width = "0%";
    meatFill.style.height = "100%";
    meatFill.style.background = "#facc15";

    meatBar.appendChild(meatFill);
    meatFarm.appendChild(meatBar);
  }

// Ø§Ù„ÙˆÙ‚Øª ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ØŒ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù†Ù‰
let meatTime = document.getElementById("meat-farm-upgrade-bar-time");
if (!meatTime) {
  meatTime = document.createElement("div");
  meatTime.id = "meat-farm-upgrade-bar-time";
  meatTime.className = "building-upgrade-time";
  meatTime.style.position = "absolute";
  meatTime.style.bottom = "-44px";
  meatTime.style.left = "50%";
  meatTime.style.transform = "translateX(-50%)";
  meatTime.textContent = "";
  meatFarm.appendChild(meatTime);
}

  if (castleLevel < requiredLevel) {
    meatFarm.style.filter = "grayscale(1)";
    meatFarm.style.opacity = "0.5";

    const lock = document.createElement("div");
    lock.textContent = "ğŸ”’ Lv." + requiredLevel;
    lock.style.position = "absolute";
    lock.style.bottom = "4px";
    lock.style.left = "50%";
    lock.style.transform = "translateX(-50%)";
    lock.style.background = "rgba(0,0,0,0.7)";
    lock.style.padding = "2px 6px";
    lock.style.borderRadius = "8px";
    lock.style.fontSize = "10px";
    meatFarm.appendChild(lock);

    meatFarm.onclick = function () {
      alert(
        "Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù… Ù…Ù‚ÙÙˆÙ„Ø©.\nÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " +
          requiredLevel +
          " Ø£ÙˆÙ„Ø§Ù‹."
      );
    };
  } else {
    meatFarm.style.filter = "none";
    meatFarm.style.opacity = "1";
   // Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù…
meatFarm.onclick = function () {
  showBuildingPopup("meatFarm");
};

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ØªØ­Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙÙ‚Ø·)
    meatStatusBox.textContent = "Lv." + (buildingLevels.meatFarm || 1);
    meatFarm.appendChild(meatStatusBox);
  }
}


// 7: Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (building-7)
const heroesHall = document.getElementById("building-7");
if (heroesHall) {
  const requiredLevel = 4; // ØªÙØªØ­ Ø¹Ù†Ø¯ Ù…Ø³ØªÙˆÙ‰ 4

  heroesHall.style.border = "none";
  heroesHall.style.background = "transparent";
  heroesHall.style.width = "140px";
  heroesHall.style.height = "160px";
  heroesHall.style.position = "absolute";
  heroesHall.style.left = buildingPositions[6].left;
  heroesHall.style.top = buildingPositions[6].top;
  heroesHall.style.transform = "translate(-50%, -50%)";
  heroesHall.style.zIndex = 95;
  heroesHall.innerHTML = "";

  const img = document.createElement("img");
  img.src = "heroes_hall.png";
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";
  img.style.pointerEvents = "none";
  heroesHall.appendChild(img);

  // ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ù…ÙØªÙˆØ­)
  const heroesHallStatusBox = document.createElement("div");
  heroesHallStatusBox.id = "heroes-hall-status-box";
  heroesHallStatusBox.style.position = "absolute";
  heroesHallStatusBox.style.bottom = "-18px";
  heroesHallStatusBox.style.left = "50%";
  heroesHallStatusBox.style.transform = "translateX(-50%)";
  heroesHallStatusBox.style.background = "rgba(0,0,0,0.7)";
  heroesHallStatusBox.style.padding = "2px 6px";
  heroesHallStatusBox.style.borderRadius = "8px";
  heroesHallStatusBox.style.fontSize = "10px";
  heroesHallStatusBox.style.minWidth = "70px";
  heroesHallStatusBox.style.textAlign = "center";

  // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… ØªØ±Ù‚ÙŠØ© Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
  let heroesBar = document.getElementById("heroes-hall-upgrade-bar");
  if (!heroesBar) {
    heroesBar = document.createElement("div");
    heroesBar.id = "heroes-hall-upgrade-bar";
    heroesBar.style.position = "absolute";
    heroesBar.style.bottom = "-30px";
    heroesBar.style.left = "50%";
    heroesBar.style.transform = "translateX(-50%)";
    heroesBar.style.width = "90px";
    heroesBar.style.height = "6px";
    heroesBar.style.background = "rgba(15,23,42,0.9)";
    heroesBar.style.borderRadius = "999px";
    heroesBar.style.overflow = "hidden";
    heroesBar.style.display = "none";

    const fill = document.createElement("div");
    fill.id = "heroes-hall-upgrade-bar-fill";
    fill.style.width = "0%";
    fill.style.height = "100%";
    fill.style.background = "#facc15";
    heroesBar.appendChild(fill);

    // Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ØŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù…Ø¨Ù†Ù‰ Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„
    let heroesTime = document.getElementById("heroes-hall-upgrade-bar-time");
    if (!heroesTime) {
      heroesTime = document.createElement("div");
      heroesTime.id = "heroes-hall-upgrade-bar-time";
      heroesTime.className = "building-upgrade-time";
      heroesTime.style.position = "absolute";
      heroesTime.style.bottom = "-44px"; // Ø²ÙŠ Ø§Ù„Ù…Ø¯Ø±Ø³Ø©/Ø§Ù„Ø®Ø´Ø¨
      heroesTime.style.left = "50%";
      heroesTime.style.transform = "translateX(-50%)";
      heroesTime.textContent = "";
      heroesHall.appendChild(heroesTime); // Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¨Ø§Ø±ØŒ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù†Ù‰
    }

    heroesHall.appendChild(heroesBar);
  }

  if (castleLevel < requiredLevel) {
    heroesHall.style.filter = "grayscale(1)";
    heroesHall.style.opacity = "0.5";

    const lock = document.createElement("div");
    lock.textContent = "ğŸ”’ Lv." + requiredLevel;
    lock.style.position = "absolute";
    lock.style.bottom = "4px";
    lock.style.left = "50%";
    lock.style.transform = "translateX(-50%)";
    lock.style.background = "rgba(0,0,0,0.7)";
    lock.style.padding = "2px 6px";
    lock.style.borderRadius = "8px";
    lock.style.fontSize = "10px";
    heroesHall.appendChild(lock);

    heroesHall.onclick = function () {
      alert(
        "Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ Ù…Ù‚ÙÙˆÙ„Ø©.\nÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " +
          requiredLevel +
          " Ø£ÙˆÙ„Ø§Ù‹."
      );
    };
  } else {
    heroesHall.style.filter = "none";
    heroesHall.style.opacity = "1";

    // ÙØªØ­ Ù†Ø§ÙØ°Ø© Ù…Ø¹Ù„ÙˆÙ…Ø§Øª/ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø¨Ù†Ù‰
    heroesHall.onclick = function () {
      showBuildingPopup("heroesHall");
    };

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ØªØ­Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙÙ‚Ø·)
    heroesHallStatusBox.textContent =
      "Lv." + (buildingLevels.heroesHall || 1);
    heroesHall.appendChild(heroesHallStatusBox);
  }
}



// 8: Ø§Ù„Ø³ÙˆÙ‚ (building-8)
const market = document.getElementById("building-8");
if (market) {
  const requiredLevel = 6; // ÙŠÙØªØ­ Ø¹Ù†Ø¯ Ù…Ø³ØªÙˆÙ‰ 6

  market.style.border = "none";
  market.style.background = "transparent";
  market.style.width = "120px";
  market.style.height = "140px";
  market.style.position = "absolute";
  market.style.left = buildingPositions[7].left;
  market.style.top = buildingPositions[7].top;
  market.style.transform = "translate(-50%, -50%)";
  market.style.zIndex = 95;
  market.innerHTML = "";

  const img = document.createElement("img");
  img.src = "market.png";
  img.style.width = "100%";
  img.style.height = "100%";
  img.style.objectFit = "contain";
  img.style.pointerEvents = "none";
  market.appendChild(img);

  // ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ø³ÙˆÙ‚ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ù…ÙØªÙˆØ­)
  const marketStatusBox = document.createElement("div");
  marketStatusBox.id = "market-status-box";
  marketStatusBox.style.position = "absolute";
  marketStatusBox.style.bottom = "-18px";
  marketStatusBox.style.left = "50%";
  marketStatusBox.style.transform = "translateX(-50%)";
  marketStatusBox.style.background = "rgba(0,0,0,0.7)";
  marketStatusBox.style.padding = "2px 6px";
  marketStatusBox.style.borderRadius = "8px";
  marketStatusBox.style.fontSize = "10px";
  marketStatusBox.style.minWidth = "70px";
  marketStatusBox.style.textAlign = "center";

    // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… ØªØ±Ù‚ÙŠØ© Ø§Ù„Ø³ÙˆÙ‚
  let marketBar = document.getElementById("market-upgrade-bar");
  if (!marketBar) {
    marketBar = document.createElement("div");
    marketBar.id = "market-upgrade-bar";
    marketBar.style.position = "absolute";
    marketBar.style.bottom = "-30px";
    marketBar.style.left = "50%";
    marketBar.style.transform = "translateX(-50%)";
    marketBar.style.width = "80px";
    marketBar.style.height = "6px";
    marketBar.style.background = "rgba(15,23,42,0.9)";
    marketBar.style.borderRadius = "999px";
    marketBar.style.overflow = "hidden";
    marketBar.style.display = "none";

    const fill = document.createElement("div");
    fill.id = "market-upgrade-bar-fill";
    fill.style.width = "0%";
    fill.style.height = "100%";
    fill.style.background = "#facc15";

    marketBar.appendChild(fill);
    market.appendChild(marketBar);
  }

// Ø§Ù„ÙˆÙ‚Øª ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ØŒ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù†Ù‰
let marketTime = document.getElementById("market-upgrade-bar-time");
if (!marketTime) {
  marketTime = document.createElement("div");
  marketTime.id = "market-upgrade-bar-time";
  marketTime.className = "building-upgrade-time";
  marketTime.style.position = "absolute";
  marketTime.style.bottom = "-44px";
  marketTime.style.left = "50%";
  marketTime.style.transform = "translateX(-50%)";
  marketTime.textContent = "";
  market.appendChild(marketTime);
}


  if (castleLevel < requiredLevel) {
    market.style.filter = "grayscale(1)";
    market.style.opacity = "0.5";

    const lock = document.createElement("div");
    lock.textContent = "ğŸ”’ Lv." + requiredLevel;
    lock.style.position = "absolute";
    lock.style.bottom = "4px";
    lock.style.left = "50%";
    lock.style.transform = "translateX(-50%)";
    lock.style.background = "rgba(0,0,0,0.7)";
    lock.style.padding = "2px 6px";
    lock.style.borderRadius = "8px";
    lock.style.fontSize = "10px";
    market.appendChild(lock);

    market.onclick = function () {
      alert(
        "Ø§Ù„Ø³ÙˆÙ‚ Ù…Ù‚ÙÙˆÙ„.\nÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " +
          requiredLevel +
          " Ø£ÙˆÙ„Ø§Ù‹."
      );
    };
  } else {
    market.style.filter = "none";
    market.style.opacity = "1";
// Ø§Ù„Ø³ÙˆÙ‚
market.onclick = function () {
  showBuildingPopup("market");
};


    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ØªØ­Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙÙ‚Ø·)
    marketStatusBox.textContent =
      "Lv." + (buildingLevels.market || 1);
    market.appendChild(marketStatusBox);
  }
}



// 9: Ø¨Ø±Ø¬ Ø§Ù„Ø¨ÙˆØ³Øª (building-9)
const booster = document.getElementById("building-9");
if (booster) {
  const requiredLevel = 8; // ÙŠÙØªØ­ Ø¹Ù†Ø¯ Ù…Ø³ØªÙˆÙ‰ 8

  booster.style.border = "none";
  booster.style.background = "transparent";
  booster.style.width = "120px";
  booster.style.height = "140px";
  booster.style.position = "absolute";
  booster.style.left = buildingPositions[8].left;
  booster.style.top = buildingPositions[8].top;
  booster.style.transform = "translate(-50%, -50%)";
  booster.style.zIndex = 95;
  booster.innerHTML = "";

  const boosterImg = document.createElement("img");
  boosterImg.src = "booster_tower.png";
  boosterImg.style.width = "100%";
  boosterImg.style.height = "100%";
  boosterImg.style.objectFit = "contain";
  boosterImg.style.pointerEvents = "none";
  booster.appendChild(boosterImg);

  // ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ø¨Ø±Ø¬ Ø§Ù„Ø¨ÙˆØ³Øª (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ù…ÙØªÙˆØ­)
  const boosterStatusBox = document.createElement("div");
  boosterStatusBox.id = "booster-tower-status-box";
  boosterStatusBox.style.position = "absolute";
  boosterStatusBox.style.bottom = "-18px";
  boosterStatusBox.style.left = "50%";
  boosterStatusBox.style.transform = "translateX(-50%)";
  boosterStatusBox.style.background = "rgba(0,0,0,0.7)";
  boosterStatusBox.style.padding = "2px 6px";
  boosterStatusBox.style.borderRadius = "8px";
  boosterStatusBox.style.fontSize = "10px";
  boosterStatusBox.style.minWidth = "70px";
  boosterStatusBox.style.textAlign = "center";

    // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… ØªØ±Ù‚ÙŠØ© Ø¨Ø±Ø¬ Ø§Ù„Ø¨ÙˆØ³Øª
  let boosterBar = document.getElementById("booster-tower-upgrade-bar");
  if (!boosterBar) {
    boosterBar = document.createElement("div");
    boosterBar.id = "booster-tower-upgrade-bar";
    boosterBar.style.position = "absolute";
    boosterBar.style.bottom = "-30px";
    boosterBar.style.left = "50%";
    boosterBar.style.transform = "translateX(-50%)";
    boosterBar.style.width = "80px";
    boosterBar.style.height = "6px";
    boosterBar.style.background = "rgba(15,23,42,0.9)";
    boosterBar.style.borderRadius = "999px";
    boosterBar.style.overflow = "hidden";
    boosterBar.style.display = "none";

    const fill = document.createElement("div");
    fill.id = "booster-tower-upgrade-bar-fill";
    fill.style.width = "0%";
    fill.style.height = "100%";
    fill.style.background = "#facc15";

    boosterBar.appendChild(fill);
    booster.appendChild(boosterBar);
  }

 // Ø§Ù„ÙˆÙ‚Øª ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ØŒ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù†Ù‰
let boosterTime = document.getElementById("booster-tower-upgrade-bar-time");
if (!boosterTime) {
  boosterTime = document.createElement("div");
  boosterTime.id = "booster-tower-upgrade-bar-time";
  boosterTime.className = "building-upgrade-time";
  boosterTime.style.position = "absolute";
  boosterTime.style.bottom = "-44px";
  boosterTime.style.left = "50%";
  boosterTime.style.transform = "translateX(-50%)";
  boosterTime.textContent = "";
  booster.appendChild(boosterTime);
}



  if (castleLevel < requiredLevel) {
    booster.style.filter = "grayscale(1)";
    booster.style.opacity = "0.5";

    const lock = document.createElement("div");
    lock.textContent = "ğŸ”’ Lv." + requiredLevel;
    lock.style.position = "absolute";
    lock.style.bottom = "4px";
    lock.style.left = "50%";
    lock.style.transform = "translateX(-50%)";
    lock.style.background = "rgba(0,0,0,0.7)";
    lock.style.padding = "2px 6px";
    lock.style.borderRadius = "8px";
    lock.style.fontSize = "10px";
    booster.appendChild(lock);

    booster.onclick = function () {
      alert(
        "Ø¨Ø±Ø¬ Ø§Ù„Ø¨ÙˆØ³Øª Ù…Ù‚ÙÙˆÙ„.\nÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " +
          requiredLevel +
          " Ø£ÙˆÙ„Ø§Ù‹."
      );
    };
  } else {
    booster.style.filter = "none";
    booster.style.opacity = "1";
    // Ø¨Ø±Ø¬ Ø§Ù„Ø¨ÙˆØ³ØªØ±
booster.onclick = function () {
  showBuildingPopup("booster");
};

    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ØªØ­Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙÙ‚Ø·)
    boosterStatusBox.textContent =
      "Lv." + (buildingLevels.booster || 1);
    booster.appendChild(boosterStatusBox);
  }
}

// 10: Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (building-10)
const hospital = document.getElementById("building-10");
if (hospital) {
  const requiredLevel = 10; // ØªÙØªØ­ Ø¹Ù†Ø¯ Ù…Ø³ØªÙˆÙ‰ 10

  hospital.style.border = "none";
  hospital.style.background = "transparent";
  hospital.style.width = "120px";
  hospital.style.height = "140px";
  hospital.style.position = "absolute";
  hospital.style.left = buildingPositions[9].left;
  hospital.style.top = buildingPositions[9].top;
  hospital.style.transform = "translate(-50%, -50%)";
  hospital.style.zIndex = 95;
  hospital.innerHTML = "";

  const hospitalImg = document.createElement("img");
  hospitalImg.src = "hospital.png";
  hospitalImg.style.width = "100%";
  hospitalImg.style.height = "100%";
  hospitalImg.style.objectFit = "contain";
  hospitalImg.style.pointerEvents = "none";
  hospital.appendChild(hospitalImg);

  // ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ (ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ù„Ùˆ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ù…ÙØªÙˆØ­)
  const hospitalStatusBox = document.createElement("div");
  hospitalStatusBox.id = "hospital-status-box";
  hospitalStatusBox.style.position = "absolute";
  hospitalStatusBox.style.bottom = "-18px";
  hospitalStatusBox.style.left = "50%";
  hospitalStatusBox.style.transform = "translateX(-50%)";
  hospitalStatusBox.style.background = "rgba(0,0,0,0.7)";
  hospitalStatusBox.style.padding = "2px 6px";
  hospitalStatusBox.style.borderRadius = "8px";
  hospitalStatusBox.style.fontSize = "10px";
  hospitalStatusBox.style.minWidth = "70px";
  hospitalStatusBox.style.textAlign = "center";

    // Ø´Ø±ÙŠØ· ØªÙ‚Ø¯Ù… ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
  let hospitalBar = document.getElementById("hospital-upgrade-bar");
  if (!hospitalBar) {
    hospitalBar = document.createElement("div");
    hospitalBar.id = "hospital-upgrade-bar";
    hospitalBar.style.position = "absolute";
    hospitalBar.style.bottom = "-30px";
    hospitalBar.style.left = "50%";
    hospitalBar.style.transform = "translateX(-50%)";
    hospitalBar.style.width = "80px";
    hospitalBar.style.height = "6px";
    hospitalBar.style.background = "rgba(15,23,42,0.9)";
    hospitalBar.style.borderRadius = "999px";
    hospitalBar.style.overflow = "hidden";
    hospitalBar.style.display = "none";

    const fill = document.createElement("div");
    fill.id = "hospital-upgrade-bar-fill";
    fill.style.width = "0%";
    fill.style.height = "100%";
    fill.style.background = "#facc15";

    hospitalBar.appendChild(fill);
    hospital.appendChild(hospitalBar);
  }

  // Ø§Ù„ÙˆÙ‚Øª ØªØ­Øª Ø§Ù„Ø¨Ø§Ø±ØŒ Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù…Ø¨Ù†Ù‰
  let hospitalTime = document.getElementById("hospital-upgrade-bar-time");
  if (!hospitalTime) {
    hospitalTime = document.createElement("div");
    hospitalTime.id = "hospital-upgrade-bar-time";
    hospitalTime.style.position = "absolute";
    hospitalTime.style.bottom = "-44px";
    hospitalTime.style.left = "50%";
    hospitalTime.style.transform = "translateX(-50%)";
    hospitalTime.style.fontSize = "10px";
    hospitalTime.style.textAlign = "center";
    hospitalTime.style.color = "#e5e7eb";
    hospitalTime.textContent = "";
    hospital.appendChild(hospitalTime);
  }

  if (castleLevel < requiredLevel) {
    hospital.style.filter = "grayscale(1)";
    hospital.style.opacity = "0.5";

    const lock = document.createElement("div");
    lock.textContent = "ğŸ”’ Lv." + requiredLevel;
    lock.style.position = "absolute";
    lock.style.bottom = "4px";
    lock.style.left = "50%";
    lock.style.transform = "translateX(-50%)";
    lock.style.background = "rgba(0,0,0,0.7)";
    lock.style.padding = "2px 6px";
    lock.style.borderRadius = "8px";
    lock.style.fontSize = "10px";
    hospital.appendChild(lock);

    hospital.onclick = function () {
      alert(
        "Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰ Ù…Ù‚ÙÙˆÙ„Ø©.\nÙ‚Ù… Ø¨ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ " +
          requiredLevel +
          " Ø£ÙˆÙ„Ø§Ù‹."
      );
    };
  } else {
    hospital.style.filter = "none";
    hospital.style.opacity = "1";
    // Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰
hospital.onclick = function () {
  showBuildingPopup("hospital");
};
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ØªØ­Øª Ø§Ù„Ù…Ø¨Ù†Ù‰ (Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…ÙØªÙˆØ­Ø© ÙÙ‚Ø·)
    hospitalStatusBox.textContent =
      "Lv." + (buildingLevels.hospital || 1);
    hospital.appendChild(hospitalStatusBox);
  }
}


    addTopBar();
    addBottomBar();
    inviteBtn.style.display = "flex";
    // startResourceAutoUpdate();  // ÙˆÙ‚ÙÙ†Ø§Ù‡Ø§ Ù…Ø¤Ù‚ØªÙ‹Ø§


    const rightArrowMenu = document.querySelector(".right-arrow-menu");
    if (rightArrowMenu) {
      rightArrowMenu.style.display = "block";
    }

    const tutorialDone = localStorage.getItem(TUTORIAL_DONE_KEY) === "1";
    if (!tutorialDone) {
      showTutorialStep();
    }
  } // Ù†Ù‡Ø§ÙŠØ© if (!document.getElementById("city-bg"))
}   // Ù†Ù‡Ø§ÙŠØ© function enterCity
function highlightBuildingInCity(buildingKey) {
  let buildingId = null;
  for (const cfg of Object.values(BUILDINGS_CONFIG)) {
    if (cfg.key === buildingKey) {
      buildingId = cfg.id; // Ù…Ø«Ø§Ù„: "building-1"
      break;
    }
  }
  if (!buildingId) {
    console.warn("No building id found for key:", buildingKey);
    return;
  }

  const el = document.getElementById(buildingId);
  if (!el) {
    console.warn("Building element not found:", buildingId);
    return;
  }

  const oldPointer = el.querySelector(".building-pointer");
  if (oldPointer) {
    oldPointer.remove();
  }

  el.style.position = el.style.position || "absolute";

  const pointer = document.createElement("div");
  pointer.className = "building-pointer";
  pointer.style.position = "absolute";
  pointer.style.left = "50%";
  pointer.style.top = "50%";
  pointer.style.transform = "translate(-50%, -50%) scale(1)";
  pointer.style.width = "40px";
  pointer.style.height = "40px";
  pointer.style.borderRadius = "50%";
  pointer.style.background = "rgba(0,0,0,0.6)";
  pointer.style.display = "flex";
  pointer.style.alignItems = "center";
  pointer.style.justifyContent = "center";
  pointer.style.zIndex = "999";
  pointer.style.cursor = "pointer";

  const icon = document.createElement("div");
  icon.textContent = "ğŸ‘†";
  icon.style.fontSize = "22px";
  pointer.appendChild(icon);

  el.appendChild(pointer);

  let elapsed = 0;
  const duration = 5000;
  const interval = 200;

  const pulse = setInterval(() => {
    elapsed += interval;
    const scale = pointer.style.transform.includes("scale(1.1)")
      ? "translate(-50%, -50%) scale(1)"
      : "translate(-50%, -50%) scale(1.1)";
    pointer.style.transform = scale;

    if (elapsed >= duration) {
      clearInterval(pulse);
      if (pointer && pointer.parentNode) {
        pointer.remove();
      }
    }
  }, interval);

  pointer.onclick = () => {
    clearInterval(pulse);
    if (pointer && pointer.parentNode) {
      pointer.remove();
    }
  };
}

function openGoldMinePage() {
  openMiningBuildingPanel("goldMine");
}





function openWoodMinePage() {
  openMiningBuildingPanel('woodMine');
}


function openSchoolPage() {
  initSchoolPanel();
  const panel = document.getElementById("school-panel");
  if (panel) panel.style.display = "block";
}
// Ø­Ø³Ø§Ø¨ ØªÙƒÙ„ÙØ© ØªØ¯Ø±ÙŠØ¨ Ø¯ÙØ¹Ø© Ø¬Ù†ÙˆØ¯ Ù„Ù„Ù‡Ø¬ÙˆÙ…
function getAttackTrainCost(amount, unit) {
  const baseFoodPerUnit = unit.atk * 3;   // Ø£ÙƒÙ„ Ù„ÙƒÙ„ Ø¬Ù†Ø¯ÙŠ
  const baseGoldPerUnit = unit.hp * 1.5;  // Ø°Ù‡Ø¨ Ù„ÙƒÙ„ Ø¬Ù†Ø¯ÙŠ

  const food = Math.floor(baseFoodPerUnit * amount);
  const gold = Math.floor(baseGoldPerUnit * amount);

  return { gold, food };
}
function getHealthTrainCost(amount, unit) {
  const baseFoodPerUnit = unit.hp * 2;
  const baseGoldPerUnit = unit.atk * 1.0;
  const food = Math.floor(baseFoodPerUnit * amount);
  const gold = Math.floor(baseGoldPerUnit * amount);
  return { gold, food };
}

function getHealthTrainTime(unit, amount, healthLevel) {
  let basePerUnit = 6;
  if (unit.hp >= 150) basePerUnit = 10;

  let total = basePerUnit * amount;

  if (healthLevel > 1) {
    total = Math.floor(total * (1 - (healthLevel - 1) * 0.03));
  }

  if (total < 5) total = 5;
  return total;
}

// Ø­Ø³Ø§Ø¨ ÙˆÙ‚Øª ØªØ¯Ø±ÙŠØ¨ Ø¯ÙØ¹Ø© Ø§Ù„Ø¬Ù†ÙˆØ¯ Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø© ÙˆØ§Ù„Ø§Ù…ØªÙ„Ø§Ø¡
function getAttackTrainTime(unit, amount, attackLevel) {
  let basePerUnit;
  if (unit.atk <= 15) basePerUnit = 8;
  else if (unit.atk <= 30) basePerUnit = 12;
  else if (unit.atk <= 60) basePerUnit = 18;
  else basePerUnit = 25;

  const baseBatchTime = basePerUnit * amount;

  // Ù†Ø³ØªØ®Ø¯Ù… attackLevel Ø§Ù„Ù‚Ø§Ø¯Ù… Ù…Ù† Ø§Ù„Ø¨Ø±Ø§Ù…ÙŠØªØ±ØŒ ÙˆÙ„Ùˆ Ø­Ø§Ø¨Ø¨ ØªØ¶Ù…Ù†:
  const lvl = attackLevel || buildingLevels.attackTower || 1;
  const capacity = getAttackArmyCapacity(lvl);
  const totalBefore = getTotalArmyCountForHero(currentHero);
  const fullness = capacity > 0 ? Math.min(1, totalBefore / capacity) : 0;

  const fullnessFactor = 0.8 + fullness * 1.7;
  const finalTime = baseBatchTime * fullnessFactor;

  return Math.floor(finalTime);
}

function startAttackTrainingTimer() {
  const wrapper = document.getElementById("attack-train-progress-wrapper");
  const fill = document.getElementById("attack-train-progress-fill");
  const timeEl = document.getElementById("attack-train-remaining-time");
  const speedups = document.getElementById("attack-train-speedups");

  if (!wrapper || !fill || !timeEl || !speedups) return;

  wrapper.style.display = "block";
  speedups.style.display = "block";

  if (attackTrainingInterval) clearInterval(attackTrainingInterval);

  const tick = () => {
    const now = Date.now();
    const diffMs = attackTrainingFinishAt - now;

    if (diffMs <= 0) {
      attackTrainingRemainingTime = 0;
      fill.style.width = "100%";
      timeEl.textContent = "ØªÙ…";
      clearInterval(attackTrainingInterval);
      attackTrainingInterval = null;
      finishAttackTraining();
      return;
    }

    attackTrainingRemainingTime = Math.floor(diffMs / 1000);
    timeEl.textContent = formatDuration(attackTrainingRemainingTime);

    const elapsed = attackTrainingTotalTime - attackTrainingRemainingTime;
    const ratio = attackTrainingTotalTime > 0 ? elapsed / attackTrainingTotalTime : 0;
    const percent = Math.max(0, Math.min(100, ratio * 100));
    fill.style.width = percent + "%";
  };

  tick();
  attackTrainingInterval = setInterval(tick, 1000);
}
function startHealthTrainingTimer() {
  const progressWrapper = document.getElementById("health-train-progress-wrapper");
  const remainingTimeEl = document.getElementById("health-train-remaining-time");
  const progressFill = document.getElementById("health-train-progress-fill");

  if (healthTrainingInterval) {
    clearInterval(healthTrainingInterval);
    healthTrainingInterval = null;
  }

  if (!healthTrainingInProgress || !progressWrapper || !remainingTimeEl || !progressFill) return;

  progressWrapper.style.display = "block";
  renderHealthTrainProgressUI();

  healthTrainingInterval = setInterval(() => {
    healthTrainingRemainingTime -= 1;
    if (healthTrainingRemainingTime <= 0) {
      healthTrainingRemainingTime = 0;
      clearInterval(healthTrainingInterval);
      healthTrainingInterval = null;
      finishHealthTraining();
    }
    renderHealthTrainProgressUI();
  }, 1000);
}
function renderHealthTrainProgressUI() {
  const progressWrapper = document.getElementById("health-train-progress-wrapper");
  const remainingTimeEl = document.getElementById("health-train-remaining-time");
  const progressFill = document.getElementById("health-train-progress-fill");

  if (!progressWrapper || !remainingTimeEl || !progressFill) return;

  if (!healthTrainingInProgress) {
    progressWrapper.style.display = "none";
    return;
  }

  progressWrapper.style.display = "block";
  if (typeof formatDuration === "function") {
    remainingTimeEl.textContent = formatDuration(healthTrainingRemainingTime);
  } else {
    remainingTimeEl.textContent = `${healthTrainingRemainingTime} Ø«Ø§Ù†ÙŠØ©`;
  }

  const total = healthTrainingTotalTime || 1;
  const ratio = Math.max(0, Math.min(1, (total - healthTrainingRemainingTime) / total));
  progressFill.style.width = (ratio * 100) + "%";
}
function finishHealthTraining() {
  if (!currentHealthTrainingHeroKey || !currentHealthTrainingUnitKey || !currentHealthTrainingAmount) {
    healthTrainingInProgress = false;
    renderHealthTrainProgressUI();
    saveGameState();
    return;
  }

  const heroKey = currentHealthTrainingHeroKey;
  const unitKey = currentHealthTrainingUnitKey;
  const amount = currentHealthTrainingAmount;

  if (!trainedHealthArmy[heroKey]) {
    trainedHealthArmy[heroKey] = {};
  }
  const prev = trainedHealthArmy[heroKey][unitKey] || 0;
  trainedHealthArmy[heroKey][unitKey] = prev + amount;
    // Ù‡Ù†Ø§ Ø®Ø·ÙˆØ© 3: Ø­ÙØ¸ Ø§Ù„Ù…Ø®Ø²ÙˆÙ† ÙÙŠ localStorage
  localStorage.setItem("raidex_trainedHealthArmy_v1", JSON.stringify(trainedHealthArmy));

  healthTrainingInProgress = false;
  healthTrainingFinishAt = null;
  healthTrainingRemainingTime = 0;
  healthTrainingTotalTime = 0;
  currentHealthTrainingHeroKey = null;
  currentHealthTrainingUnitKey = null;
  currentHealthTrainingAmount = 0;

  renderHealthTrainProgressUI();
  renderHealthArmyTraining();
  saveGameState();
}

function finishAttackTraining() {
  if (!currentTrainingHeroKey || !currentTrainingUnitKey || !currentTrainingAmount) {
    attackTrainingInProgress = false;
    return;
  }

  if (!trainedArmy[currentTrainingHeroKey]) {
    trainedArmy[currentTrainingHeroKey] = {};
  }
  if (typeof trainedArmy[currentTrainingHeroKey][currentTrainingUnitKey] !== "number") {
    trainedArmy[currentTrainingHeroKey][currentTrainingUnitKey] = 0;
  }

  trainedArmy[currentTrainingHeroKey][currentTrainingUnitKey] += currentTrainingAmount;

  attackTrainingInProgress = false;
  attackTrainingFinishAt = null;
  attackTrainingRemainingTime = 0;
  attackTrainingTotalTime = 0;
  currentTrainingHeroKey = null;
  currentTrainingUnitKey = null;
  currentTrainingAmount = 0;

  const wrapper = document.getElementById("attack-train-progress-wrapper");
  const fill = document.getElementById("attack-train-progress-fill");
  const timeEl = document.getElementById("attack-train-remaining-time");
  const speedups = document.getElementById("attack-train-speedups");

  if (wrapper && fill && timeEl && speedups) {
    wrapper.style.display = "none";
    speedups.style.display = "none";
    fill.style.width = "0%";
    timeEl.textContent = "0 Ø«Ø§Ù†ÙŠØ©";
  }

  localStorage.setItem("raidex_trainedArmy_v1", JSON.stringify(trainedArmy));
  saveGameState();

  updateArmyProfileView();
  updateProfileStatsFromArmy();
}


function openAttackArmyPage() {
  // Ù„Ø³Ù‡ Ù†Ø¸Ø§Ù… Ù‡Ø¬ÙˆÙ… Ø§Ù„Ø¬ÙŠØ´ Ù…Ø³ØªÙ‚Ù„ØŒ Ø³ÙŠØ¨Ù‡ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ
  initAttackArmyPanel();
  const panel = document.getElementById("attack-army-panel");
  if (panel) panel.style.display = "block";
}

function openHealthArmyPage() {
  // Ù„Ø³Ù‡ Ù†Ø¸Ø§Ù… ØµØ­Ø© Ø§Ù„Ø¬ÙŠØ´ Ù…Ø³ØªÙ‚Ù„ØŒ Ø³ÙŠØ¨Ù‡ Ø²ÙŠ Ù…Ø§ Ù‡Ùˆ
  initHealthArmyPanel();
  const panel = document.getElementById("health-army-panel");
  if (panel) panel.style.display = "block";
}

// Ù…Ù†Ø¬Ù… Ø§Ù„Ù„Ø­Ù… ÙŠÙØ¶Ù„ ÙŠØ³ØªØ®Ø¯Ù… Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ¹Ø¯ÙŠÙ† Ø§Ù„Ø®Ø§Øµ
function openMeatFarmPage() {
  openMiningBuildingPanel('meatFarm');
}

// Ù…Ù† Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¨Ø§Ù†Ù„ Ø§Ù„Ù…ÙˆØ­Ø¯ Ù„Ù„Ù…Ø¨Ø§Ù†ÙŠ
function openHeroesHallPage() {
  openBuildingPanel('heroesHall');
}

function openMarketPage() {
  openBuildingPanel('market');
}

function openBoosterTowerPage() {
  openBuildingPanel('booster');
}

function openHospitalPage() {
  openBuildingPanel('hospital');
}

// Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù†Ù„ Ù…ØªØ¬Ø± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø©
function initResourceShopPanel() {
  if (document.getElementById("resource-shop-panel")) return;

  const panel = document.createElement("div");
  panel.id = "resource-shop-panel";
  panel.className = "resource-shop-panel hidden";

  panel.style.position = "fixed";
  panel.style.top = "50%";
  panel.style.left = "50%";
  panel.style.transform = "translate(-50%, -50%)";
  panel.style.width = "80%";
  panel.style.maxWidth = "400px";
  panel.style.background = "#020617";
  panel.style.border = "2px solid #facc15";
  panel.style.borderRadius = "16px";
  panel.style.padding = "12px";
  panel.style.zIndex = "9999";
  panel.style.color = "#e5e7eb";
  panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.7)";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";

  const titleEl = document.createElement("div");
  titleEl.id = "resource-shop-title";
  titleEl.style.fontWeight = "bold";
  titleEl.style.fontSize = "18px";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#e5e7eb";
  closeBtn.style.fontSize = "18px";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = closeResourceShop;

  header.appendChild(titleEl);
  header.appendChild(closeBtn);

  const subEl = document.createElement("div");
  subEl.id = "resource-shop-sub";
  subEl.style.fontSize = "13px";
  subEl.style.marginBottom = "10px";
  subEl.style.color = "#9ca3af";

  const content = document.createElement("div");
  content.id = "resource-shop-content";

  panel.appendChild(header);
  panel.appendChild(subEl);
  panel.appendChild(content);

  document.body.appendChild(panel);

}

function initWoodMinePanel() {
  if (document.getElementById("wood-mine-panel")) return;

  const panel = document.createElement("div");
  panel.id = "wood-mine-panel";
  panel.className = "game-page-panel";
  panel.style.position = "fixed";
  panel.style.top = "50%";
  panel.style.left = "50%";
  panel.style.transform = "translate(-50%, -50%)";
  panel.style.width = "80%";
  panel.style.maxWidth = "400px";
  panel.style.background = "#020617";
  panel.style.border = "2px solid #facc15";
  panel.style.borderRadius = "16px";
  panel.style.padding = "12px";
  panel.style.zIndex = "9999";
  panel.style.color = "#e5e7eb";
  panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.7)";
  panel.style.display = "none";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.textContent = "Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨";
  title.style.fontWeight = "bold";
  title.style.fontSize = "18px";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#e5e7eb";
  closeBtn.style.fontSize = "18px";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => {
    panel.style.display = "none";
  };

  header.appendChild(title);
  header.appendChild(closeBtn);
  panel.appendChild(header);

  const tabsRow = document.createElement("div");
  tabsRow.style.display = "flex";
  tabsRow.style.marginBottom = "10px";
  tabsRow.style.borderBottom = "1px solid #374151";

  function makeTabButton(key, label) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.dataset.tab = key;
    btn.style.flex = "1";
    btn.style.padding = "6px 0";
    btn.style.border = "none";
    btn.style.background = "transparent";
    btn.style.color = "#9ca3af";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.onclick = () => switchTab(key);
    return btn;
  }

  const infoTabBtn = makeTabButton("info", "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª");
  const upgradeTabBtn = makeTabButton("upgrade", "Ø§Ù„ØªØ±Ù‚ÙŠØ©");
  infoTabBtn.style.color = "#facc15";

  tabsRow.appendChild(infoTabBtn);
  tabsRow.appendChild(upgradeTabBtn);
  panel.appendChild(tabsRow);

  const infoTab = document.createElement("div");
  infoTab.id = "wood-mine-panel-info";

  const upgradeTab = document.createElement("div");
  upgradeTab.id = "wood-mine-panel-upgrade";
  upgradeTab.style.display = "none";

  infoTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨ (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";
  upgradeTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù…Ù†Ø¬Ù… Ø§Ù„Ø®Ø´Ø¨ (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";

  panel.appendChild(infoTab);
  panel.appendChild(upgradeTab);

  document.body.appendChild(panel);

  function switchTab(key) {
    if (key === "info") {
      infoTab.style.display = "block";
      upgradeTab.style.display = "none";
      infoTabBtn.style.color = "#facc15";
      upgradeTabBtn.style.color = "#9ca3af";
    } else {
      infoTab.style.display = "none";
      upgradeTab.style.display = "block";
      infoTabBtn.style.color = "#9ca3af";
      upgradeTabBtn.style.color = "#facc15";
    }
  }
}
function initSchoolPanel() {
  if (document.getElementById("school-panel")) return;

  const panel = document.createElement("div");
  panel.id = "school-panel";
  panel.className = "game-page-panel";
  panel.style.position = "fixed";
  panel.style.top = "50%";
  panel.style.left = "50%";
  panel.style.transform = "translate(-50%, -50%)";
  panel.style.width = "80%";
  panel.style.maxWidth = "400px";
  panel.style.background = "#020617";
  panel.style.border = "2px solid #facc15";
  panel.style.borderRadius = "16px";
  panel.style.padding = "12px";
  panel.style.zIndex = "9999";
  panel.style.color = "#e5e7eb";
  panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.7)";
  panel.style.display = "none";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.textContent = "Ø§Ù„Ù…Ø¯Ø±Ø³Ø©";
  title.style.fontWeight = "bold";
  title.style.fontSize = "18px";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#e5e7eb";
  closeBtn.style.fontSize = "18px";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => {
    panel.style.display = "none";
  };

  header.appendChild(title);
  header.appendChild(closeBtn);
  panel.appendChild(header);

  const tabsRow = document.createElement("div");
  tabsRow.style.display = "flex";
  tabsRow.style.marginBottom = "10px";
  tabsRow.style.borderBottom = "1px solid #374151";

  function makeTabButton(key, label) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.dataset.tab = key;
    btn.style.flex = "1";
    btn.style.padding = "6px 0";
    btn.style.border = "none";
    btn.style.background = "transparent";
    btn.style.color = "#9ca3af";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.onclick = () => switchTab(key);
    return btn;
  }

  const infoTabBtn = makeTabButton("info", "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª");
  const upgradeTabBtn = makeTabButton("upgrade", "Ø§Ù„ØªØ±Ù‚ÙŠØ©");
  infoTabBtn.style.color = "#facc15";

  tabsRow.appendChild(infoTabBtn);
  tabsRow.appendChild(upgradeTabBtn);
  panel.appendChild(tabsRow);

  const infoTab = document.createElement("div");
  infoTab.id = "school-panel-info";

  const upgradeTab = document.createElement("div");
  upgradeTab.id = "school-panel-upgrade";
  upgradeTab.style.display = "none";

  infoTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ù…Ø¯Ø±Ø³Ø© (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";
  upgradeTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù„Ù…Ø¯Ø±Ø³Ø© (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";

  panel.appendChild(infoTab);
  panel.appendChild(upgradeTab);

  document.body.appendChild(panel);

  function switchTab(key) {
    if (key === "info") {
      infoTab.style.display = "block";
      upgradeTab.style.display = "none";
      infoTabBtn.style.color = "#facc15";
      upgradeTabBtn.style.color = "#9ca3af";
    } else {
      infoTab.style.display = "none";
      upgradeTab.style.display = "block";
      infoTabBtn.style.color = "#9ca3af";
      upgradeTabBtn.style.color = "#facc15";
    }
  }
}

function initMarketPanel() {
  if (document.getElementById("market-panel")) return;

  const panel = document.createElement("div");
  panel.id = "market-panel";
  panel.className = "game-page-panel";
  panel.style.position = "fixed";
  panel.style.top = "50%";
  panel.style.left = "50%";
  panel.style.transform = "translate(-50%, -50%)";
  panel.style.width = "80%";
  panel.style.maxWidth = "400px";
  panel.style.background = "#020617";
  panel.style.border = "2px solid #facc15";
  panel.style.borderRadius = "16px";
  panel.style.padding = "12px";
  panel.style.zIndex = "9999";
  panel.style.color = "#e5e7eb";
  panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.7)";
  panel.style.display = "none";

  // Header
  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.textContent = "Ø§Ù„Ø³ÙˆÙ‚";
  title.style.fontWeight = "bold";
  title.style.fontSize = "18px";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#e5e7eb";
  closeBtn.style.fontSize = "18px";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => {
    panel.style.display = "none";
  };

  header.appendChild(title);
  header.appendChild(closeBtn);
  panel.appendChild(header);

  // Tabs row
  const tabsRow = document.createElement("div");
  tabsRow.style.display = "flex";
  tabsRow.style.marginBottom = "10px";
  tabsRow.style.borderBottom = "1px solid #374151";

  function makeTabButton(key, label) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.dataset.tab = key;
    btn.style.flex = "1";
    btn.style.padding = "6px 0";
    btn.style.border = "none";
    btn.style.background = "transparent";
    btn.style.color = "#9ca3af";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.onclick = () => switchTab(key);
    return btn;
  }

  const infoTabBtn = makeTabButton("info", "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª");
  const upgradeTabBtn = makeTabButton("upgrade", "Ø§Ù„ØªØ±Ù‚ÙŠØ©");
  infoTabBtn.style.color = "#facc15";

  tabsRow.appendChild(infoTabBtn);
  tabsRow.appendChild(upgradeTabBtn);
  panel.appendChild(tabsRow);

  // Tabs content
  const infoTab = document.createElement("div");
  infoTab.id = "market-panel-info";

  const upgradeTab = document.createElement("div");
  upgradeTab.id = "market-panel-upgrade";
  upgradeTab.style.display = "none";

  infoTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ø³ÙˆÙ‚ (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";
  upgradeTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù„Ø³ÙˆÙ‚ (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";

  panel.appendChild(infoTab);
  panel.appendChild(upgradeTab);

  document.body.appendChild(panel);

  function switchTab(key) {
    if (key === "info") {
      infoTab.style.display = "block";
      upgradeTab.style.display = "none";
      infoTabBtn.style.color = "#facc15";
      upgradeTabBtn.style.color = "#9ca3af";
    } else {
      infoTab.style.display = "none";
      upgradeTab.style.display = "block";
      infoTabBtn.style.color = "#9ca3af";
      upgradeTabBtn.style.color = "#facc15";
    }
  }
}
function initMeatFarmPanel() {
  if (document.getElementById("meat-farm-panel")) return;

  const panel = document.createElement("div");
  panel.id = "meat-farm-panel";
  panel.className = "game-page-panel";
  panel.style.position = "fixed";
  panel.style.top = "50%";
  panel.style.left = "50%";
  panel.style.transform = "translate(-50%, -50%)";
  panel.style.width = "80%";
  panel.style.maxWidth = "400px";
  panel.style.background = "#020617";
  panel.style.border = "2px solid #facc15";   // â† Ù‡Ù†Ø§ Ù…Ù† ØºÙŠØ± " Ø¬ÙˆÙ‘Ù‡ "
  panel.style.borderRadius = "16px";
  panel.style.padding = "12px";
  panel.style.zIndex = "9999";
  panel.style.color = "#e5e7eb";
  panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.7)";
  panel.style.display = "none";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.textContent = "Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù…";
  title.style.fontWeight = "bold";
  title.style.fontSize = "18px";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#e5e7eb";
  closeBtn.style.fontSize = "18px";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => {
    panel.style.display = "none";
  };

  header.appendChild(title);
  header.appendChild(closeBtn);
  panel.appendChild(header);

  const tabsRow = document.createElement("div");
  tabsRow.style.display = "flex";
  tabsRow.style.marginBottom = "10px";
  tabsRow.style.borderBottom = "1px solid #374151"; // â† Ù†ÙØ³ Ø§Ù„ÙÙƒØ±Ø© Ù‡Ù†Ø§

  function makeTabButton(key, label) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.dataset.tab = key;
    btn.style.flex = "1";
    btn.style.padding = "6px 0";
    btn.style.border = "none";
    btn.style.background = "transparent";
    btn.style.color = "#9ca3af";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.onclick = () => switchTab(key);
    return btn;
  }

  const infoTabBtn = makeTabButton("info", "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª");
  const upgradeTabBtn = makeTabButton("upgrade", "Ø§Ù„ØªØ±Ù‚ÙŠØ©");
  infoTabBtn.style.color = "#facc15";

  tabsRow.appendChild(infoTabBtn);
  tabsRow.appendChild(upgradeTabBtn);
  panel.appendChild(tabsRow);

  const infoTab = document.createElement("div");
  infoTab.id = "meat-farm-panel-info";

  const upgradeTab = document.createElement("div");
  upgradeTab.id = "meat-farm-panel-upgrade";
  upgradeTab.style.display = "none";

  infoTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù… (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";
  upgradeTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù…Ø²Ø±Ø¹Ø© Ø§Ù„Ù„Ø­Ù… (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";

  panel.appendChild(infoTab);
  panel.appendChild(upgradeTab);

  document.body.appendChild(panel);

  function switchTab(key) {
    if (key === "info") {
      infoTab.style.display = "block";
      upgradeTab.style.display = "none";
      infoTabBtn.style.color = "#facc15";
      upgradeTabBtn.style.color = "#9ca3af";
    } else {
      infoTab.style.display = "none";
      upgradeTab.style.display = "block";
      infoTabBtn.style.color = "#9ca3af";
      upgradeTabBtn.style.color = "#facc15";
    }
  }
}
function initHospitalPanel() {
  if (document.getElementById("hospital-panel")) return;

  const panel = document.createElement("div");
  panel.id = "hospital-panel";
  panel.className = "game-page-panel";
  panel.style.position = "fixed";
  panel.style.top = "50%";
  panel.style.left = "50%";
  panel.style.transform = "translate(-50%, -50%)";
  panel.style.width = "80%";
  panel.style.maxWidth = "400px";
  panel.style.background = "#020617";
  panel.style.border = "2px solid #facc15";
  panel.style.borderRadius = "16px";
  panel.style.padding = "12px";
  panel.style.zIndex = "9999";
  panel.style.color = "#e5e7eb";
  panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.7)";
  panel.style.display = "none";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.textContent = "Ø§Ù„Ù…Ø³ØªØ´ÙÙ‰";
  title.style.fontWeight = "bold";
  title.style.fontSize = "18px";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#e5e7eb";
  closeBtn.style.fontSize = "18px";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => {
    panel.style.display = "none";
  };

  header.appendChild(title);
  header.appendChild(closeBtn);
  panel.appendChild(header);

  const tabsRow = document.createElement("div");
  tabsRow.style.display = "flex";
  tabsRow.style.marginBottom = "10px";
  tabsRow.style.borderBottom = "1px solid #374151";

  function makeTabButton(key, label) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.dataset.tab = key;
    btn.style.flex = "1";
    btn.style.padding = "6px 0";
    btn.style.border = "none";
    btn.style.background = "transparent";
    btn.style.color = "#9ca3af";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.onclick = () => switchTab(key);
    return btn;
  }

  const infoTabBtn = makeTabButton("info", "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª");
  const upgradeTabBtn = makeTabButton("upgrade", "Ø§Ù„ØªØ±Ù‚ÙŠØ©");
  infoTabBtn.style.color = "#facc15";

  tabsRow.appendChild(infoTabBtn);
  tabsRow.appendChild(upgradeTabBtn);
  panel.appendChild(tabsRow);

  const infoTab = document.createElement("div");
  infoTab.id = "hospital-panel-info";

  const upgradeTab = document.createElement("div");
  upgradeTab.id = "hospital-panel-upgrade";
  upgradeTab.style.display = "none";

  infoTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";
  upgradeTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù„Ù…Ø³ØªØ´ÙÙ‰ (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";

  panel.appendChild(infoTab);
  panel.appendChild(upgradeTab);

  document.body.appendChild(panel);

  function switchTab(key) {
    if (key === "info") {
      infoTab.style.display = "block";
      upgradeTab.style.display = "none";
      infoTabBtn.style.color = "#facc15";
      upgradeTabBtn.style.color = "#9ca3af";
    } else {
      infoTab.style.display = "none";
      upgradeTab.style.display = "block";
      infoTabBtn.style.color = "#9ca3af";
      upgradeTabBtn.style.color = "#facc15";
    }
  }
}
//  ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¬Ù†ÙˆØ¯ Ù„ÙƒÙ„ Ø¨Ø·Ù„ Ù‡Ø¬ÙˆÙ…
const HERO_ARMIES = {
  elephant: [
    { key: "ele_atk_soldier_1", name: "ÙÙŠÙ„ Ù…Ù‡Ø§Ø¬Ù… 1", img: "elephant_atk_soldier1.png", atk: 10,  hp: 60,  levelRequired: 1 },
    { key: "ele_atk_soldier_2", name: "ÙÙŠÙ„ Ù…Ù‡Ø§Ø¬Ù… 2", img: "elephant_atk_soldier2.png", atk: 18,  hp: 90,  levelRequired: 10 },
    { key: "ele_atk_soldier_3", name: "ÙÙŠÙ„ Ù…Ù‡Ø§Ø¬Ù… 3", img: "elephant_atk_soldier3.png", atk: 28,  hp: 130, levelRequired: 25 },
    { key: "ele_atk_soldier_4", name: "ÙÙŠÙ„ Ù…Ù‡Ø§Ø¬Ù… 4", img: "elephant_atk_soldier4.png", atk: 40,  hp: 180, levelRequired: 35 }
  ],
  tiger: [
    { key: "tig_soldier_1", name: "Ø¬Ù†Ø¯ÙŠ Ù†Ù…Ø± 1", img: "tiger_atk_soldier1.png", atk: 15, hp: 30, levelRequired: 1 },
    { key: "tig_soldier_2", name: "Ø¬Ù†Ø¯ÙŠ Ù†Ù…Ø± 2", img: "tiger_atk_soldier2.png", atk: 25, hp: 45, levelRequired: 10 },
    { key: "tig_soldier_3", name: "Ø¬Ù†Ø¯ÙŠ Ù†Ù…Ø± 3", img: "tiger_atk_soldier3.png", atk: 40, hp: 60, levelRequired: 25 },
    { key: "tig_soldier_4", name: "Ø¬Ù†Ø¯ÙŠ Ù†Ù…Ø± 4", img: "tiger_atk_soldier4.png", atk: 60, hp: 80, levelRequired: 35 }
  ],
  kong: [
    { key: "kong_atk_soldier_1", name: "ÙƒÙˆÙ†Ø¬ Ù…Ù‡Ø§Ø¬Ù… 1", img: "kong_atk_soldier1.png", atk: 20, hp: 50, levelRequired: 1 },
    { key: "kong_atk_soldier_2", name: "ÙƒÙˆÙ†Ø¬ Ù…Ù‡Ø§Ø¬Ù… 2", img: "kong_atk_soldier2.png", atk: 35, hp: 75, levelRequired: 10 },
    { key: "kong_atk_soldier_3", name: "ÙƒÙˆÙ†Ø¬ Ù…Ù‡Ø§Ø¬Ù… 3", img: "kong_atk_soldier3.png", atk: 55, hp: 100, levelRequired: 25 },
    { key: "kong_atk_soldier_4", name: "ÙƒÙˆÙ†Ø¬ Ù…Ù‡Ø§Ø¬Ù… 4", img: "kong_atk_soldier4.png", atk: 80, hp: 140, levelRequired: 35 }
  ]
};
let trainedArmy = {
  elephant: {
    ele_atk_soldier_1: 0,
    ele_atk_soldier_2: 0,
    ele_atk_soldier_3: 0,
    ele_atk_soldier_4: 0
  },
  tiger: {
    tig_soldier_1: 0,
    tig_soldier_2: 0,
    tig_soldier_3: 0,
    tig_soldier_4: 0
  },
  kong: {
    kong_atk_soldier_1: 0,
    kong_atk_soldier_2: 0,
    kong_atk_soldier_3: 0,
    kong_atk_soldier_4: 0
  }
};
const savedArmy = localStorage.getItem("raidex_trainedArmy_v1");
if (savedArmy) {
  try {
    const parsed = JSON.parse(savedArmy);
    trainedArmy = { ...trainedArmy, ...parsed };
  } catch (e) {
    console.error("Error parsing saved army", e);
  }
}
// ØªØ¹Ø±ÙŠÙ Ø¬Ù†ÙˆØ¯ Ø§Ù„ØµØ­Ù‡ Ù„ÙƒÙ„ Ø¨Ø·Ù„
const HERO_HEALTH_ARMIES = {
  elephant: [
    { key: "ele_health_soldier_1", name: "ÙÙŠÙ„ ØµØ­Ø© 1", img: "elephant_health_soldier1.png", atk: 5,  hp: 80,  levelRequired: 1 },
    { key: "ele_health_soldier_2", name: "ÙÙŠÙ„ ØµØ­Ø© 2", img: "elephant_health_soldier2.png", atk: 9,  hp: 120, levelRequired: 10 },
    { key: "ele_health_soldier_3", name: "ÙÙŠÙ„ ØµØ­Ø© 3", img: "elephant_health_soldier3.png", atk: 14, hp: 170, levelRequired: 25 },
    { key: "ele_health_soldier_4", name: "ÙÙŠÙ„ ØµØ­Ø© 4", img: "elephant_health_soldier4.png", atk: 20, hp: 230, levelRequired: 35 }
  ],
  tiger: [
    { key: "tig_health_soldier_1", name: "Ù†Ù…Ø± ØµØ­Ø© 1", img: "tiger_health_soldier1.png", atk: 6,  hp: 60,  levelRequired: 1 },
    { key: "tig_health_soldier_2", name: "Ù†Ù…Ø± ØµØ­Ø© 2", img: "tiger_health_soldier2.png", atk: 11, hp: 90,  levelRequired: 10 },
    { key: "tig_health_soldier_3", name: "Ù†Ù…Ø± ØµØ­Ø© 3", img: "tiger_health_soldier3.png", atk: 17, hp: 120, levelRequired: 25 },
    { key: "tig_health_soldier_4", name: "Ù†Ù…Ø± ØµØ­Ø© 4", img: "tiger_health_soldier4.png", atk: 24, hp: 150, levelRequired: 35 }
  ],
  kong: [
    { key: "kong_health_soldier_1", name: "ÙƒÙˆÙ†Ø¬ ØµØ­Ø© 1", img: "kong_health_soldier1.png", atk: 7,  hp: 70,  levelRequired: 1 },
    { key: "kong_health_soldier_2", name: "ÙƒÙˆÙ†Ø¬ ØµØ­Ø© 2", img: "kong_health_soldier2.png", atk: 13, hp: 110, levelRequired: 10 },
    { key: "kong_health_soldier_3", name: "ÙƒÙˆÙ†Ø¬ ØµØ­Ø© 3", img: "kong_health_soldier3.png", atk: 19, hp: 150, levelRequired: 25 },
    { key: "kong_health_soldier_4", name: "ÙƒÙˆÙ†Ø¬ ØµØ­Ø© 4", img: "kong_health_soldier4.png", atk: 26, hp: 200, levelRequired: 35 }
  ]
};
// Ù…Ø®Ø²ÙˆÙ† Ø¬Ù†ÙˆØ¯ Ø§Ù„ØµØ­Ø© Ù„ÙƒÙ„ Ø¨Ø·Ù„
let trainedHealthArmy = {
  elephant: {
    ele_health_soldier_1: 0,
    ele_health_soldier_2: 0,
    ele_health_soldier_3: 0,
    ele_health_soldier_4: 0
  },
  tiger: {
    tig_health_soldier_1: 0,
    tig_health_soldier_2: 0,
    tig_health_soldier_3: 0,
    tig_health_soldier_4: 0
  },
  kong: {
    kong_health_soldier_1: 0,
    kong_health_soldier_2: 0,
    kong_health_soldier_3: 0,
    kong_health_soldier_4: 0
  }
};
// ØªØ­Ù…ÙŠÙ„ Ù…Ø®Ø²ÙˆÙ† Ø¬Ù†ÙˆØ¯ Ø§Ù„ØµØ­Ø© Ù…Ù† Ø§Ù„ØªØ®Ø²ÙŠÙ†
const savedHealthArmy = localStorage.getItem("raidex_trainedHealthArmy_v1");
if (savedHealthArmy) {
  try {
    const parsed = JSON.parse(savedHealthArmy);
    trainedHealthArmy = { ...trainedHealthArmy, ...parsed };
  } catch (e) {
    console.error("Error parsing saved health army", e);
  }
}


function getAttackArmyCapacity(level) {
  const base = 500;
  const growth = 1.1;
  return Math.floor(base * Math.pow(growth, level - 1));
}

function getTotalArmyCountForHero(heroKey) {
  const heroArmy = trainedArmy[heroKey] || {};
  let total = 0;
  Object.values(heroArmy).forEach(count => {
    total += count;
  });
  return total;
}

// Ø­Ø¬Ù… Ø§Ù„Ø¯ÙØ¹Ø© = 2% Ù…Ù† Ø§Ù„Ø³Ø¹Ø© (Ø¨Ø­Ø¯ Ø£Ø¯Ù†Ù‰ ÙˆØ£Ù‚ØµÙ‰)
function getAttackTrainBatchSize(level) {
  const capacity = getAttackArmyCapacity(level);

  let batch = Math.floor(capacity * 0.02); // 2%

  if (batch < 10) batch = 10;   // Ù„Ø§ ÙŠÙ‚Ù„ Ø¹Ù† 10
  if (batch > 800) batch = 800; // Ù„Ø§ ÙŠØ²ÙŠØ¯ Ø¹Ù† 800 ÙÙŠ Ø§Ù„Ø¯ÙØ¹Ø©

  return batch;
}

function getArmyBonusForHero(heroKey) {
  const heroArmy = trainedArmy[heroKey] || {};
  const armyConfig = HERO_ARMIES[heroKey] || [];

  let totalAttack = 0;
  let totalHp = 0;

  Object.entries(heroArmy).forEach(([unitKey, count]) => {
    if (count <= 0) return;
    const unit = armyConfig.find(u => u.key === unitKey);
    if (!unit) return;

    totalAttack += unit.atk * count;
    totalHp += unit.hp * count;
  });

  return { totalAttack, totalHp };
}
function getDefenseArmyStatsForHero(heroKey) {
  const heroArmy = trainedDefenseArmy[heroKey] || {};
  const armyConfig = DEF_ARMIES[heroKey] || [];

  let totalAttack = 0;
  let totalHp = 0;

  Object.entries(heroArmy).forEach(([unitKey, count]) => {
    if (count <= 0) return;
    const unit = armyConfig.find(u => u.key === unitKey);
    if (!unit) return;

    totalAttack += unit.atk * count;
    totalHp += unit.hp * count;
  });

    return { totalAttack, totalHp };
}

function updateArmyProfileView() {
  const grid = document.querySelector(".army-grid");
  if (!grid) return;

  const heroKey = currentHero || "elephant";

  const heroAttackArmy = trainedArmy[heroKey] || {};
  const attackConfig = (HERO_ARMIES[heroKey] || []).slice(0, 4);

  const heroHealthArmy = trainedHealthArmy[heroKey] || {};
  const healthConfig = (HERO_HEALTH_ARMIES[heroKey] || []).slice(0, 4);

  const slots = Array.from(grid.querySelectorAll(".army-slot"));

  // ØªØµÙÙŠØ± ÙƒÙ„ Ø§Ù„Ø®Ø§Ù†Ø§Øª
  slots.forEach((slot) => {
    const icon = slot.querySelector(".army-slot-icon");
    const countEl = slot.querySelector(".army-slot-count");
    if (icon) {
      icon.style.backgroundImage = "";
      icon.style.backgroundSize = "";
      icon.style.backgroundPosition = "";
    }
    if (countEl) {
      countEl.textContent = "0";
    }
    slot.onclick = null;
  });

  let slotIndex = 0;

  // 4 ÙˆØ­Ø¯Ø§Øª Ù‡Ø¬ÙˆÙ… ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
  attackConfig.forEach((unit) => {
    if (!slots[slotIndex]) return;
    const slot = slots[slotIndex];
    const icon = slot.querySelector(".army-slot-icon");
    const countEl = slot.querySelector(".army-slot-count");

    const count =
      typeof heroAttackArmy[unit.key] === "number" ? heroAttackArmy[unit.key] : 0;

    if (icon) {
      icon.style.backgroundImage = `url(${unit.img})`;
      icon.style.backgroundSize = "cover";
      icon.style.backgroundPosition = "center";
    }
    if (countEl) {
      countEl.textContent = count.toString();
    }

    slot.onclick = () => {
      openArmyUnitPopup(unit, count, "attack");
    };

    slotIndex++;
  });

  // 4 ÙˆØ­Ø¯Ø§Øª ØµØ­Ø© ÙƒØ­Ø¯ Ø£Ù‚ØµÙ‰
  healthConfig.forEach((unit) => {
    if (!slots[slotIndex]) return;
    const slot = slots[slotIndex];
    const icon = slot.querySelector(".army-slot-icon");
    const countEl = slot.querySelector(".army-slot-count");

    const count =
      typeof heroHealthArmy[unit.key] === "number" ? heroHealthArmy[unit.key] : 0;

    if (icon) {
      icon.style.backgroundImage = `url(${unit.img})`;
      icon.style.backgroundSize = "cover";
      icon.style.backgroundPosition = "center";
    }
    if (countEl) {
      countEl.textContent = count.toString();
    }

    slot.onclick = () => {
      openArmyUnitPopup(unit, count, "health");
    };

    slotIndex++;

  });
}
function openArmyUnitPopup(unit, count, type) {
  const popup = document.getElementById("army-unit-popup");
  const titleEl = document.getElementById("army-unit-popup-title");
  const imgBox = document.getElementById("army-unit-popup-img");
  const nameEl = document.getElementById("army-unit-popup-name");
  const statsEl = document.getElementById("army-unit-popup-stats");
  const extraEl = document.getElementById("army-unit-popup-extra");
  const closeBtn = document.getElementById("army-unit-popup-close");

  if (!popup || !titleEl || !imgBox || !nameEl || !statsEl || !extraEl || !closeBtn) return;

  popup.style.display = "flex";

  titleEl.textContent = type === "attack" ? "ÙˆØ­Ø¯Ø© Ù‡Ø¬ÙˆÙ…" : "ÙˆØ­Ø¯Ø© ØµØ­Ø©";
  imgBox.style.backgroundImage = `url(${unit.img})`;
  nameEl.textContent = unit.name;

  statsEl.textContent = `Ù‡Ø¬ÙˆÙ…: ${unit.atk} | ØµØ­Ø©: ${unit.hp}` +
    (typeof count === "number" ? ` | Ø¹Ø¯Ø¯: ${count}` : "");

  extraEl.textContent = unit.levelRequired
    ? `Ù…ØªØ§Ø­Ø© Ù…Ù† Ù…Ø³ØªÙˆÙ‰ Ø¨Ø·Ù„ ${unit.levelRequired}`
    : "";

  closeBtn.onclick = () => {
    popup.style.display = "none";
  };

  popup.onclick = (e) => {
    if (e.target === popup) popup.style.display = "none";
  };
}

function updateProfileStatsFromArmy() {
  if (!currentHero) return;

  // 1) Ø¬ÙŠØ´ Ø§Ù„Ù‡Ø¬ÙˆÙ…
  const atkArmy = getArmyBonusForHero(currentHero);
  const atkAttack = atkArmy.totalAttack || 0;
  const atkHp = atkArmy.totalHp || 0;

  // 2) Ø¬ÙŠØ´ Ø§Ù„ØµØ­Ø© (Ø¨Ø§Ù„Ø£Ø³Ø§Ù…ÙŠ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ© Ø¹Ù†Ø¯Ùƒ)
  const heroHealthArmy = trainedHealthArmy[currentHero] || {};
  const healthConfig = HERO_HEALTH_ARMIES[currentHero] || [];

  let healthAttack = 0;
  let healthHp = 0;

  Object.entries(heroHealthArmy).forEach(([unitKey, count]) => {
    if (count <= 0) return;
    const unit = healthConfig.find(u => u.key === unitKey);
    if (!unit) return;
    healthAttack += unit.atk * count;
    healthHp += unit.hp * count;
  });

  // 3) Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù„ÙŠ ÙŠÙ†Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ø¨Ø±ÙˆÙØ§ÙŠÙ„
  const totalAttack = atkAttack + healthAttack;
  const totalHp = atkHp + healthHp;

  const attackEl = document.getElementById("profile-attack");
  const hpEl = document.getElementById("profile-hp");
  if (attackEl) attackEl.textContent = totalAttack.toString();
  if (hpEl) hpEl.textContent = totalHp.toString();
}


function initAttackArmyPanel() {
  if (document.getElementById("attack-army-panel")) return;

  const panel = document.createElement("div");
  panel.id = "attack-army-panel";
  panel.className = "game-page-panel";
  panel.style.position = "fixed";
  panel.style.top = "50%";
  panel.style.left = "50%";
  panel.style.transform = "translate(-50%, -50%)";
  panel.style.width = "80%";
  panel.style.maxWidth = "400px";
  panel.style.background = "#020617";
  panel.style.border = "2px solid #facc15";
  panel.style.borderRadius = "16px";
  panel.style.padding = "12px";
  panel.style.zIndex = "9999";
  panel.style.color = "#e5e7eb";
  panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.7)";
  panel.style.display = "none";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.textContent = "Ù…Ø¨Ù†Ù‰ Ø¬ÙŠØ´ Ø§Ù„Ù‡Ø¬ÙˆÙ…";
  title.style.fontWeight = "bold";
  title.style.fontSize = "18px";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#e5e7eb";
  closeBtn.style.fontSize = "18px";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => {
    panel.style.display = "none";
  };

  header.appendChild(title);
  header.appendChild(closeBtn);
  panel.appendChild(header);

  const tabsRow = document.createElement("div");
  tabsRow.style.display = "flex";
  tabsRow.style.marginBottom = "10px";
  tabsRow.style.borderBottom = "1px solid #374151";

  function makeTabButton(key, label) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.dataset.tab = key;
    btn.style.flex = "1";
    btn.style.padding = "6px 0";
    btn.style.border = "none";
    btn.style.background = "transparent";
    btn.style.color = "#9ca3af";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.onclick = () => switchTab(key);
    return btn;
  }

  const infoTabBtn = makeTabButton("info", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨");
  const upgradeTabBtn = makeTabButton("upgrade", "Ø§Ù„ØªØ±Ù‚ÙŠØ©");
  infoTabBtn.style.color = "#facc15";

  tabsRow.appendChild(infoTabBtn);
  tabsRow.appendChild(upgradeTabBtn);
  panel.appendChild(tabsRow);

const infoTab = document.createElement("div");
infoTab.id = "attack-army-panel-info";

infoTab.innerHTML = `
  <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø£ÙˆÙ„: Ø§Ù„ÙƒØ±ÙˆØª + Ø§Ø³Ù… Ø§Ù„ÙˆØ­Ø¯Ø© -->
  <div id="attack-army-cards-row"
       style="display:flex; gap:8px; margin-bottom:6px; justify-content:space-between;"></div>

  <div id="attack-army-selected-name"
       style="font-weight:bold; text-align:center; margin-bottom:4px;"></div>

  <!-- ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ÙƒØ±ÙˆØª ÙˆØ¬Ø²Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ -->
  <div id="attack-separator-top"
       style="height:1px; background:rgba(148,163,184,0.4); margin:6px 0 8px 0;"></div>

  <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù†ÙŠ: ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ¯Ø±ÙŠØ¨ -->
  <div id="attack-army-detail"
       style="display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:8px;"></div>

  <!-- ÙØ§ØµÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ¯Ø±ÙŠØ¨ ÙˆØ¬Ø²Ø¡ Ø§Ù„ØªØ³Ø±ÙŠØ¹ -->
  <div id="attack-separator-bottom"
       style="height:1px; background:rgba(148,163,184,0.4); margin:6px 0 8px 0;"></div>

  <!-- Ø§Ù„Ø¬Ø²Ø¡ Ø§Ù„Ø«Ø§Ù„Ø«: Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù… ÙˆØ¬Ø²Ø¡ Ø§Ù„ØªØ³Ø±ÙŠØ¹ (ÙŠØ¸Ù‡Ø±ÙˆØ§ ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ¯Ø±ÙŠØ¨) -->
  <div id="attack-train-progress-wrapper"
       style="margin-top:4px; display:none;">
    <div style="width:100%;height:8px;background:rgba(148,163,184,0.4);border-radius:999px;overflow:hidden;">
      <div id="attack-train-progress-fill"
           style="width:0;height:100%;background:#22c55e;"></div>
    </div>
    <div style="margin-top:4px;font-size:12px;text-align:center;color:#e5e7eb;">
      <span id="attack-train-remaining-time">0 Ø«Ø§Ù†ÙŠØ©</span>
    </div>
  </div>

  <div id="attack-train-speedups"
       style="margin-top:6px;display:none;font-size:11px;color:#e5e7eb;">
    <div style="margin-bottom:4px;">ØªØ³Ø±ÙŠØ¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨:</div>
    <div id="attack-train-speedups-row"
         style="display:flex;flex-wrap:wrap;gap:6px;"></div>
  </div>
`;


const upgradeTab = document.createElement("div");
upgradeTab.id = "attack-army-panel-upgrade";
upgradeTab.style.display = "none";
upgradeTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù…Ø¨Ù†Ù‰ Ø¬ÙŠØ´ Ø§Ù„Ù‡Ø¬ÙˆÙ… (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";

panel.appendChild(infoTab);
panel.appendChild(upgradeTab);

const cardsRow = infoTab.querySelector("#attack-army-cards-row");
const selectedNameEl = infoTab.querySelector("#attack-army-selected-name");
const detailEl = infoTab.querySelector("#attack-army-detail");

function renderAttackArmyTraining() {
  const armyList = HERO_ARMIES[currentHero] || [];
  const attackBuildingLevel = buildingLevels.attackTower || 1;

  cardsRow.innerHTML = "";
  selectedNameEl.textContent = "";
  detailEl.innerHTML = "";

  if (!armyList.length) {
    selectedNameEl.textContent = "Ù„Ø§ ØªÙˆØ¬Ø¯ ÙˆØ­Ø¯Ø§Øª Ù…ØªØ§Ø­Ø© Ù„Ù‡Ø°Ù‡ Ø§Ù„Ø´Ø®ØµÙŠØ© Ø­Ø§Ù„ÙŠØ§Ù‹.";
    return;
  }

  armyList.forEach((unit, index) => {
    const isLocked = attackBuildingLevel < unit.levelRequired;

    const card = document.createElement("div");
    card.style.flex = "1";
    card.style.background = "rgba(15,23,42,0.9)";
    card.style.border = "1px solid rgba(148,163,184,0.6)";
    card.style.borderRadius = "10px";
    card.style.padding = "4px";
    card.style.textAlign = "center";
    card.style.fontSize = "11px";
    card.style.cursor = "pointer";
    card.style.transition = "0.2s";
    card.style.position = "relative";

    if (isLocked) {
      card.style.opacity = "0.5";
    }

    card.innerHTML = `
      <div style="width:100%; height:40px; margin-bottom:4px; position:relative;">
        <img src="${unit.img}" style="width:100%; height:100%; object-fit:cover; border-radius:8px;">
        ${isLocked ? `
          <div style="
            position:absolute; inset:0;
            display:flex; align-items:center; justify-content:center;
            background:rgba(0,0,0,0.4);
            font-size:14px; font-weight:bold; color:#facc15;
          ">
            ğŸ”’ Lv.${unit.levelRequired}
          </div>
        ` : ""}
      </div>
      <div>${unit.name}</div>
    `;

    card.onclick = () => {
      Array.from(cardsRow.children).forEach(c => c.style.outline = "none");
      card.style.outline = "2px solid #facc15";

      selectedNameEl.textContent = unit.name;

      const currentCount =
        (trainedArmy[currentHero] && trainedArmy[currentHero][unit.key]) || 0;

    detailEl.innerHTML = `
  <div style="width:80px; height:80px; flex-shrink:0;">
    <img src="${unit.img}" style="width:100%; height:100%; object-fit:cover; border-radius:12px;">
  </div>
  <div style="font-size:13px; line-height:1.6;">
    <div>Ø§Ù„Ù‡Ø¬ÙˆÙ…: ${unit.atk}</div>
    <div>Ø§Ù„ØµØ­Ø©: ${unit.hp}</div>
    <div style="margin-top:4px;">
      Ø¹Ø¯Ø¯ Ø§Ù„Ø¬Ù†ÙˆØ¯ Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù†ÙˆØ¹:
      <span id="unit-count-text">${currentCount}</span>
    </div>

    ${isLocked ? `
      <div style="color:#f97316; margin-top:6px;">
        Ù‡Ø°Ù‡ Ø§Ù„ÙˆØ­Ø¯Ø© Ù…Ù‚ÙÙˆÙ„Ø©. ØªØ­ØªØ§Ø¬ Ù…Ø¨Ù†Ù‰ Ø¬ÙŠØ´ Ø§Ù„Ù‡Ø¬ÙˆÙ… Ù„ÙÙ„ ${unit.levelRequired} Ù„ÙØªØ­ Ø§Ù„ØªØ¯Ø±ÙŠØ¨.
      </div>
    ` : `
      <!-- Ø³Ø·Ø± Ø§Ù„ØªÙƒÙ„ÙØ© Ø§Ù„Ø¬Ø¯ÙŠØ¯ -->
      <div id="attack-train-cost" style="margin-top:6px; font-size:12px; color:#e5e7eb;">
        <!-- ÙŠÙ…ØªÙ„Ø¦ Ø¨Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø¹Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© -->
      </div>

      <div id="attack-train-info" style="margin-top:6px; font-size:12px; color:#e5e7eb;">
        <!-- ÙŠÙ…ØªÙ„Ø¦ Ø¨Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¨Ø¹Ø¯ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¯ÙØ¹Ø© -->
      </div>
      <button id="train-button"
              style="margin-top:8px; padding:6px 12px; border:none; border-radius:999px;
                     background:#22c55e; color:#0b1120; font-weight:bold; cursor:pointer; font-size:12px;">
        Ø¨Ø¯Ø¡ ØªØ¯Ø±ÙŠØ¨ Ø¯ÙØ¹Ø©
      </button>
    `}
  </div>
`;


      if (!isLocked) {
        const trainBtn = detailEl.querySelector("#train-button");
        const countSpan = detailEl.querySelector("#unit-count-text");
        const infoEl = detailEl.querySelector("#attack-train-info");
        const costEl = detailEl.querySelector("#attack-train-cost");

        if (trainBtn && countSpan && infoEl && costEl) {
          // Ø­Ø³Ø§Ø¨ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¯ÙØ¹Ø© Ù„Ø¹Ø±Ø¶Ù‡Ø§
          const heroKey = currentHero;
          const attackLevel = buildingLevels.attackTower || 1;
          const capacity = getAttackArmyCapacity(attackLevel);
          const totalBefore = getTotalArmyCountForHero(heroKey);
          const trainAmount = getAttackTrainBatchSize(attackLevel);
          const trainTimeSeconds = getAttackTrainTime(unit, trainAmount, attackLevel);
// Ù†Ø­Ø³Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ© Ù„Ù„Ø¯ÙØ¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
const costNow = getAttackTrainCost(trainAmount, unit);
const enoughGold = resources.gold >= costNow.gold;
const enoughFood = resources.food >= costNow.food;

if (!enoughGold || !enoughFood) {
  alert("Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ù„Ø§ ØªÙƒÙÙŠ Ù„ØªØ¯Ø±ÙŠØ¨ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ø¬Ù†ÙˆØ¯.");
  return;
}

// Ø®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
resources.gold -= costNow.gold;
resources.food -= costNow.food;
saveGameState();

// Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙƒÙ„ÙØ©
const cost = getAttackTrainCost(trainAmount, unit);
const hasGold = resources.gold >= cost.gold;
const hasFood = resources.food >= cost.food;

// Ø¹Ø±Ø¶ Ø§Ù„ØªÙƒÙ„ÙØ© ÙÙˆÙ‚ Ø§Ù„Ø²Ø±
costEl.innerHTML = `
  ØªÙƒÙ„ÙØ©:
  <span style="color:${hasGold ? "#e5e7eb" : "#ef4444"}">Ø°Ù‡Ø¨ ${cost.gold.toLocaleString()}</span> -
  <span style="color:${hasFood ? "#e5e7eb" : "#ef4444"}">Ù„Ø­Ù… ${cost.food.toLocaleString()}</span>
`;

          infoEl.textContent =
            `Ø¯ÙØ¹Ø© ØªØ¯Ø±ÙŠØ¨: ${trainAmount} Ø¬Ù†Ø¯ÙŠØŒ Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${formatDuration(trainTimeSeconds)}. ` +
            `Ø§Ù„Ø³Ø¹Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©: ${totalBefore}/${capacity}.`;

   trainBtn.onclick = () => {
  console.log("DEBUG click train", {
    attackTrainingInProgress,
    attackTrainingRemainingTime,
    attackTrainingFinishAt,
  });

  // Ù„Ùˆ ÙÙŠÙ‡ ØªØ¯Ø±ÙŠØ¨ ÙØ¹Ù„ÙŠ Ø´ØºÙ‘Ø§Ù„ (ÙˆÙ‚Øª > 0 Ùˆ finishAt Ù…ÙˆØ¬ÙˆØ¯)
  if (
    attackTrainingInProgress === true &&
    attackTrainingRemainingTime > 0 &&
    attackTrainingFinishAt
  ) {
    alert("ÙŠÙˆØ¬Ø¯ ØªØ¯Ø±ÙŠØ¨ Ø¢Ø®Ø± Ù‚ÙŠØ¯ Ø§Ù„ØªÙ†ÙÙŠØ° Ø­Ø§Ù„ÙŠØ§Ù‹. Ø§Ù†ØªØ¸Ø± Ø§Ù†ØªÙ‡Ø§Ø¡Ù‡ Ø£Ùˆ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ³Ø±ÙŠØ¹Ø§Øª.");
    return;
  }

  // Ù„Ùˆ Ø§Ù„ÙÙ„Ø§Øº true Ù„ÙƒÙ† Ù…ÙÙŠØ´ ÙˆÙ‚Øª Ø£Ùˆ finishAt => Ù†ØµÙ„Ù‘Ø­ Ø§Ù„Ø­Ø§Ù„Ø©
  if (
    attackTrainingInProgress === true &&
    (attackTrainingRemainingTime <= 0 || !attackTrainingFinishAt)
  ) {
    console.log("FIX stale training state -> resetting");
    attackTrainingInProgress = false;
    attackTrainingRemainingTime = 0;
    attackTrainingTotalTime = 0;
    attackTrainingFinishAt = null;
    currentTrainingHeroKey = null;
    currentTrainingUnitKey = null;
    currentTrainingAmount = 0;
  }

  const heroKey = currentHero;
  const attackLevel = buildingLevels.attackTower || 1;
  const capacity = getAttackArmyCapacity(attackLevel);
  const totalBefore = getTotalArmyCountForHero(heroKey);
  const trainAmount = getAttackTrainBatchSize(attackLevel);
  const trainTimeSeconds = getAttackTrainTime(unit, trainAmount, attackLevel);

  console.log("DEBUG train values", {
    heroKey,
    attackLevel,
    capacity,
    totalBefore,
    trainAmount,
    trainTimeSeconds,
  });

  if (totalBefore + trainAmount > capacity) {
    alert("Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ¯Ø±ÙŠØ¨ Ø§Ù„Ù…Ø²ÙŠØ¯ØŒ Ø³Ø¹Ø© Ù…Ø¨Ù†Ù‰ Ø¬ÙŠØ´ Ø§Ù„Ù‡Ø¬ÙˆÙ… Ù…Ù…ØªÙ„Ø¦Ø©.");
    return;
  }
const costNow = getAttackTrainCost(trainAmount, unit);
const enoughGold = resources.gold >= costNow.gold;
const enoughFood = resources.food >= costNow.food;

if (!enoughGold || !enoughFood) {
  alert("Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ù„Ø§ ØªÙƒÙÙŠ Ù„ØªØ¯Ø±ÙŠØ¨ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø© Ù…Ù† Ø§Ù„Ø¬Ù†ÙˆØ¯.");
  return;
}

resources.gold -= costNow.gold;
resources.food -= costNow.food;
saveGameState();

  attackTrainingInProgress = true;
  attackTrainingTotalTime = trainTimeSeconds;
  attackTrainingRemainingTime = trainTimeSeconds;
  attackTrainingFinishAt = Date.now() + trainTimeSeconds * 1000;
  currentTrainingHeroKey = heroKey;
  currentTrainingUnitKey = unit.key;
  currentTrainingAmount = trainAmount;

  saveGameState();
  startAttackTrainingTimer();

  infoEl.textContent =
    `Ø¬Ø§Ø±ÙŠ ØªØ¯Ø±ÙŠØ¨: ${trainAmount} Ø¬Ù†Ø¯ÙŠ. Ø§Ù„ÙˆÙ‚Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ: ${formatDuration(trainTimeSeconds)}.`;
};

        }
      }
    };

    if (index === 0) {
      setTimeout(() => card.onclick(), 0);
    }

    cardsRow.appendChild(card);
  });
}
renderAttackArmyTraining();
document.body.appendChild(panel);


  function switchTab(key) {
    if (key === "info") {
      infoTab.style.display = "block";
      upgradeTab.style.display = "none";
      infoTabBtn.style.color = "#facc15";
      upgradeTabBtn.style.color = "#9ca3af";
    } else {
      infoTab.style.display = "none";
      upgradeTab.style.display = "block";
      infoTabBtn.style.color = "#9ca3af";
      upgradeTabBtn.style.color = "#facc15";
    }
  }
}
function initHealthArmyPanel() {
  if (document.getElementById("health-army-panel")) return;

  const panel = document.createElement("div");
  panel.id = "health-army-panel";
  panel.className = "game-page-panel";
  panel.style.position = "fixed";
  panel.style.top = "50%";
  panel.style.left = "50%";
  panel.style.transform = "translate(-50%, -50%)";
  panel.style.width = "80%";
  panel.style.maxWidth = "400px";
  panel.style.background = "#020617";
  panel.style.border = "2px solid #facc15";
  panel.style.borderRadius = "16px";
  panel.style.padding = "12px";
  panel.style.zIndex = "9999";
  panel.style.color = "#e5e7eb";
  panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.7)";
  panel.style.display = "none";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.textContent = "Ù…Ø¨Ù†Ù‰ Ø¬ÙŠØ´ Ø§Ù„ØµØ­Ø©";
  title.style.fontWeight = "bold";
  title.style.fontSize = "18px";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#e5e7eb";
  closeBtn.style.fontSize = "18px";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => {
    panel.style.display = "none";
  };

  header.appendChild(title);
  header.appendChild(closeBtn);
  panel.appendChild(header);

  const tabsRow = document.createElement("div");
  tabsRow.style.display = "flex";
  tabsRow.style.marginBottom = "10px";
  tabsRow.style.borderBottom = "1px solid #374151";

  function makeTabButton(key, label) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.dataset.tab = key;
    btn.style.flex = "1";
    btn.style.padding = "6px 0";
    btn.style.border = "none";
    btn.style.background = "transparent";
    btn.style.color = "#9ca3af";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.onclick = () => switchTab(key);
    return btn;
  }

  const infoTabBtn = makeTabButton("info", "Ø§Ù„ØªØ¯Ø±ÙŠØ¨");
const upgradeTabBtn = makeTabButton("upgrade", "Ø§Ù„ØªØ±Ù‚ÙŠØ©");
  infoTabBtn.style.color = "#facc15";

  tabsRow.appendChild(infoTabBtn);
  tabsRow.appendChild(upgradeTabBtn);
  panel.appendChild(tabsRow);

  const infoTab = document.createElement("div");
  infoTab.id = "health-army-panel-info";

  const upgradeTab = document.createElement("div");
  upgradeTab.id = "health-army-panel-upgrade";
  upgradeTab.style.display = "none";

  infoTab.innerHTML = `
    <div id="health-army-cards-row"
         style="display:flex; gap:8px; margin-bottom:6px; justify-content:space-between;"></div>

    <div id="health-army-selected-name"
         style="font-weight:bold; text-align:center; margin-bottom:4px;"></div>

    <div id="health-separator-top"
         style="height:1px; background:rgba(148,163,184,0.4); margin:6px 0 8px 0;"></div>

    <div id="health-army-detail"
         style="display:flex; gap:10px; align-items:center; justify-content:center; margin-bottom:8px;"></div>

    <div id="health-separator-bottom"
         style="height:1px; background:rgba(148,163,184,0.4); margin:6px 0 8px 0;"></div>

    <div id="health-train-progress-wrapper"
         style="margin-top:4px; display:none;">
      <div style="width:100%;height:8px;background:rgba(148,163,184,0.4);border-radius:999px;overflow:hidden;">
        <div id="health-train-progress-fill"
             style="width:0;height:100%;background:#22c55e;"></div>
      </div>
      <div style="margin-top:4px;font-size:12px;text-align:center;color:#e5e7eb;">
        <span id="health-train-remaining-time">0 Ø«Ø§Ù†ÙŠØ©</span>
      </div>
    </div>

    <div id="health-train-speedups"
         style="margin-top:6px;display:none;font-size:11px;color:#e5e7eb;">
      <div style="margin-bottom:4px;">ØªØ³Ø±ÙŠØ¹ Ø§Ù„ØªØ¯Ø±ÙŠØ¨:</div>
      <div id="health-train-speedups-row"
           style="display:flex;flex-wrap:wrap;gap:6px;"></div>
    </div>
  `;

  upgradeTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù…Ø¨Ù†Ù‰ Ø¬ÙŠØ´ Ø§Ù„ØµØ­Ø© (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";

  panel.appendChild(infoTab);
  panel.appendChild(upgradeTab);

  document.body.appendChild(panel);

  function switchTab(key) {
    if (key === "info") {
      infoTab.style.display = "block";
      upgradeTab.style.display = "none";
      infoTabBtn.style.color = "#facc15";
      upgradeTabBtn.style.color = "#9ca3af";
    } else {
      infoTab.style.display = "none";
      upgradeTab.style.display = "block";
      infoTabBtn.style.color = "#9ca3af";
      upgradeTabBtn.style.color = "#facc15";
    }
  }
    renderHealthArmyTraining();
}
function renderHealthArmyTraining() {
  const panel = document.getElementById("health-army-panel");
  if (!panel) return;

  const cardsRow = panel.querySelector("#health-army-cards-row");
  const selectedNameEl = panel.querySelector("#health-army-selected-name");
  const detailEl = panel.querySelector("#health-army-detail");

  if (!cardsRow || !selectedNameEl || !detailEl) return;

  cardsRow.innerHTML = "";
  selectedNameEl.textContent = "";
  detailEl.innerHTML = "";

  const heroKey = currentHero || "elephant";
  const heroUnits = HERO_HEALTH_ARMIES[heroKey] || [];
  const healthBuildingLevel = buildingLevels.defenseTower || 1;
  if (heroUnits.length === 0) return;

  let selectedUnit = null;

  heroUnits.forEach((unit, index) => {
    const isLocked = healthBuildingLevel < unit.levelRequired;

const card = document.createElement("div");
card.style.flex = "1";
card.style.background = "rgba(15,23,42,0.95)";
card.style.borderRadius = "10px";
card.style.padding = "6px 4px";
card.style.textAlign = "center";
card.style.border = "1px solid rgba(148,163,184,0.6)";
card.style.fontSize = "11px";
card.style.position = "relative";
card.style.cursor = isLocked ? "default" : "pointer";
card.style.opacity = isLocked ? "0.5" : "1";

const imgWrapper = document.createElement("div");
imgWrapper.style.width = "100%";
imgWrapper.style.height = "40px";
imgWrapper.style.marginBottom = "4px";
imgWrapper.style.position = "relative";

const img = document.createElement("img");
img.src = unit.img;
img.style.width = "100%";
img.style.height = "100%";
img.style.objectFit = "cover";
img.style.borderRadius = "8px";

imgWrapper.appendChild(img);

const nameEl = document.createElement("div");
nameEl.textContent = unit.name;

card.appendChild(imgWrapper);
card.appendChild(nameEl);

if (isLocked) {
  const lock = document.createElement("div");
  lock.textContent = `ğŸ”’ Lv.${unit.levelRequired}`;
  lock.style.position = "absolute";
  lock.style.inset = "0";
  lock.style.display = "flex";
  lock.style.alignItems = "center";
  lock.style.justifyContent = "center";
  lock.style.background = "rgba(0,0,0,0.4)";
  lock.style.fontSize = "14px";
  lock.style.fontWeight = "bold";
  lock.style.color = "#facc15";
  lock.style.borderRadius = "10px";
  card.appendChild(lock);
} else {
  card.onclick = () => {
    Array.from(cardsRow.children).forEach(c => {
      c.style.outline = "none";
    });
    card.style.outline = "2px solid #facc15";
    selectedUnit = unit;
    renderSelectedHealthUnit(selectedUnit, selectedNameEl, detailEl);
  };

  if (!selectedUnit && index === 0) {
    selectedUnit = unit;
    setTimeout(() => card.onclick(), 0);
  }
}
    cardsRow.appendChild(card);
  });
}

function renderSelectedHealthUnit(selectedUnit, selectedNameEl, detailEl) {
  if (!selectedUnit) return;

  selectedNameEl.textContent = selectedUnit.name;
  detailEl.innerHTML = "";

  const box = document.createElement("div");
  box.style.display = "flex";
  box.style.alignItems = "center";
  box.style.gap = "10px";

  const imgBig = document.createElement("div");
  imgBig.style.width = "48px";
  imgBig.style.height = "48px";
  imgBig.style.borderRadius = "12px";
  imgBig.style.background = "rgba(31,41,55,0.9)";
  imgBig.style.border = "1px solid rgba(148,163,184,0.8)";
  imgBig.style.backgroundSize = "cover";
  imgBig.style.backgroundPosition = "center";
  imgBig.style.backgroundImage = `url(${selectedUnit.img})`;

  const rightCol = document.createElement("div");
  rightCol.style.display = "flex";
  rightCol.style.flexDirection = "column";
  rightCol.style.gap = "4px";
  rightCol.style.fontSize = "12px";

  const heroKey = currentHero || "elephant";
  const heroHealthData = trainedHealthArmy[heroKey] || {};
  const currentCount = heroHealthData[selectedUnit.key] || 0;

  const statsLine = document.createElement("div");
  statsLine.innerHTML = `
    <div>Ø§Ù„Ù‡Ø¬ÙˆÙ…: ${selectedUnit.atk}</div>
    <div>Ø§Ù„ØµØ­Ø©: ${selectedUnit.hp}</div>
  `;

  const countLine = document.createElement("div");
  countLine.textContent = `Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentCount}`;

  const trainRow = document.createElement("div");
  trainRow.style.display = "flex";
  trainRow.style.alignItems = "center";
  trainRow.style.gap = "6px";
  trainRow.style.marginTop = "4px";

  const amountInput = document.createElement("input");
  amountInput.type = "number";
  amountInput.min = "1";
  amountInput.value = "10";
  amountInput.style.width = "60px";
  amountInput.style.padding = "2px 4px";
  amountInput.style.borderRadius = "6px";
  amountInput.style.border = "1px solid rgba(148,163,184,0.8)";
  amountInput.style.background = "rgba(15,23,42,0.9)";
  amountInput.style.color = "#e5e7eb";
  amountInput.style.fontSize = "12px";

  const trainBtn = document.createElement("button");
  trainBtn.textContent = "ØªØ¯Ø±ÙŠØ¨ ØµØ­Ø©";
  trainBtn.style.padding = "4px 8px";
  trainBtn.style.border = "none";
  trainBtn.style.borderRadius = "8px";
  trainBtn.style.background = "#22c55e";
  trainBtn.style.color = "#0b1120";
  trainBtn.style.fontSize = "12px";
  trainBtn.style.cursor = "pointer";

  trainBtn.onclick = () => {
    const amount = parseInt(amountInput.value, 10) || 0;
    if (amount <= 0) {
      alert("Ù…Ù† ÙØ¶Ù„Ùƒ Ø£Ø¯Ø®Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­ Ù„Ù„ØªØ¯Ø±ÙŠØ¨.");
      return;
    }

    if (healthTrainingInProgress === true && healthTrainingRemainingTime === 0 && !healthTrainingFinishAt) {
      healthTrainingInProgress = false;
      healthTrainingRemainingTime = 0;
      healthTrainingTotalTime = 0;
      healthTrainingFinishAt = null;
      currentHealthTrainingHeroKey = null;
      currentHealthTrainingUnitKey = null;
      currentHealthTrainingAmount = 0;
    }

    if (healthTrainingInProgress) {
      alert("ÙŠÙˆØ¬Ø¯ ØªØ¯Ø±ÙŠØ¨ ØµØ­Ø© Ø¬Ø§Ø±ÙŠ Ø¨Ø§Ù„ÙØ¹Ù„. Ø§Ù†ØªØ¸Ø± Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ.");
      return;
    }

    const heroKey2 = currentHero || "elephant";
    const healthLevel = buildingLevels.defenseTower || 1;

    const { gold, food } = getHealthTrainCost(amount, selectedUnit);

    if (resources.gold < gold || resources.food < food) {
      alert("Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„ØªØ¯Ø±ÙŠØ¨ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙØ¹Ø© Ù…Ù† Ø¬Ù†ÙˆØ¯ Ø§Ù„ØµØ­Ø©.");
      return;
    }

    resources.gold -= gold;
    resources.food -= food;
    if (typeof updateTopBar === "function") updateTopBar();

    const totalTime = getHealthTrainTime(selectedUnit, amount, healthLevel);

    healthTrainingInProgress = true;
    healthTrainingTotalTime = totalTime;
    healthTrainingRemainingTime = totalTime;
    currentHealthTrainingHeroKey = heroKey2;
    currentHealthTrainingUnitKey = selectedUnit.key;
    currentHealthTrainingAmount = amount;
    healthTrainingFinishAt = Date.now() + totalTime * 1000;

    startHealthTrainingTimer();
    saveGameState();
    renderHealthTrainProgressUI();
  };

  trainRow.appendChild(amountInput);
  trainRow.appendChild(trainBtn);

  rightCol.appendChild(statsLine);
  rightCol.appendChild(countLine);
  rightCol.appendChild(trainRow);

  box.appendChild(imgBig);
  box.appendChild(rightCol);
  detailEl.appendChild(box);
}




function initHeroesHallPanel() {
  if (document.getElementById("heroes-hall-panel")) return;

  const panel = document.createElement("div");
  panel.id = "heroes-hall-panel";
  panel.className = "game-page-panel";
  panel.style.position = "fixed";
  panel.style.top = "50%";
  panel.style.left = "50%";
  panel.style.transform = "translate(-50%, -50%)";
  panel.style.width = "80%";
  panel.style.maxWidth = "400px";
  panel.style.background = "#020617";
  panel.style.border = "2px solid #facc15";
  panel.style.borderRadius = "16px";
  panel.style.padding = "12px";
  panel.style.zIndex = "9999";
  panel.style.color = "#e5e7eb";
  panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.7)";
  panel.style.display = "none";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.textContent = "Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„";
  title.style.fontWeight = "bold";
  title.style.fontSize = "18px";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#e5e7eb";
  closeBtn.style.fontSize = "18px";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => {
    panel.style.display = "none";
  };

  header.appendChild(title);
  header.appendChild(closeBtn);
  panel.appendChild(header);

  const tabsRow = document.createElement("div");
  tabsRow.style.display = "flex";
  tabsRow.style.marginBottom = "10px";
  tabsRow.style.borderBottom = "1px solid #374151";

  function makeTabButton(key, label) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.dataset.tab = key;
    btn.style.flex = "1";
    btn.style.padding = "6px 0";
    btn.style.border = "none";
    btn.style.background = "transparent";
    btn.style.color = "#9ca3af";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.onclick = () => switchTab(key);
    return btn;
  }

  const infoTabBtn = makeTabButton("info", "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª");
  const upgradeTabBtn = makeTabButton("upgrade", "Ø§Ù„ØªØ±Ù‚ÙŠØ©");
  infoTabBtn.style.color = "#facc15";

  tabsRow.appendChild(infoTabBtn);
  tabsRow.appendChild(upgradeTabBtn);
  panel.appendChild(tabsRow);

  const infoTab = document.createElement("div");
  infoTab.id = "heroes-hall-panel-info";

  const upgradeTab = document.createElement("div");
  upgradeTab.id = "heroes-hall-panel-upgrade";
  upgradeTab.style.display = "none";

  infoTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";
  upgradeTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ù‚Ø§Ø¹Ø© Ø§Ù„Ø£Ø¨Ø·Ø§Ù„ (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";

  panel.appendChild(infoTab);
  panel.appendChild(upgradeTab);

  document.body.appendChild(panel);

  function switchTab(key) {
    if (key === "info") {
      infoTab.style.display = "block";
      upgradeTab.style.display = "none";
      infoTabBtn.style.color = "#facc15";
      upgradeTabBtn.style.color = "#9ca3af";
    } else {
      infoTab.style.display = "none";
      upgradeTab.style.display = "block";
      infoTabBtn.style.color = "#9ca3af";
      upgradeTabBtn.style.color = "#facc15";
    }
  }
}
function initBoosterTowerPanel() {
  if (document.getElementById("booster-tower-panel")) return;

  const panel = document.createElement("div");
  panel.id = "booster-tower-panel";
  panel.className = "game-page-panel";
  panel.style.position = "fixed";
  panel.style.top = "50%";
  panel.style.left = "50%";
  panel.style.transform = "translate(-50%, -50%)";
  panel.style.width = "80%";
  panel.style.maxWidth = "400px";
  panel.style.background = "#020617";
  panel.style.border = "2px solid #facc15";
  panel.style.borderRadius = "16px";
  panel.style.padding = "12px";
  panel.style.zIndex = "9999";
  panel.style.color = "#e5e7eb";
  panel.style.boxShadow = "0 10px 30px rgba(0,0,0,0.7)";
  panel.style.display = "none";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "8px";

  const title = document.createElement("div");
  title.textContent = "Ø¨Ø±Ø¬ Ø§Ù„Ø¨ÙˆØ³Øª";
  title.style.fontWeight = "bold";
  title.style.fontSize = "18px";

  const closeBtn = document.createElement("button");
  closeBtn.textContent = "âœ–";
  closeBtn.style.background = "transparent";
  closeBtn.style.border = "none";
  closeBtn.style.color = "#e5e7eb";
  closeBtn.style.fontSize = "18px";
  closeBtn.style.cursor = "pointer";
  closeBtn.onclick = () => {
    panel.style.display = "none";
  };

  header.appendChild(title);
  header.appendChild(closeBtn);
  panel.appendChild(header);

  const tabsRow = document.createElement("div");
  tabsRow.style.display = "flex";
  tabsRow.style.marginBottom = "10px";
  tabsRow.style.borderBottom = "1px solid #374151";

  function makeTabButton(key, label) {
    const btn = document.createElement("button");
    btn.textContent = label;
    btn.dataset.tab = key;
    btn.style.flex = "1";
    btn.style.padding = "6px 0";
    btn.style.border = "none";
    btn.style.background = "transparent";
    btn.style.color = "#9ca3af";
    btn.style.cursor = "pointer";
    btn.style.fontWeight = "bold";
    btn.onclick = () => switchTab(key);
    return btn;
  }

  const infoTabBtn = makeTabButton("info", "Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª");
  const upgradeTabBtn = makeTabButton("upgrade", "Ø§Ù„ØªØ±Ù‚ÙŠØ©");
  infoTabBtn.style.color = "#facc15";

  tabsRow.appendChild(infoTabBtn);
  tabsRow.appendChild(upgradeTabBtn);
  panel.appendChild(tabsRow);

  const infoTab = document.createElement("div");
  infoTab.id = "booster-tower-panel-info";

  const upgradeTab = document.createElement("div");
  upgradeTab.id = "booster-tower-panel-upgrade";
  upgradeTab.style.display = "none";

  infoTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ù„Ø¨Ø±Ø¬ Ø§Ù„Ø¨ÙˆØ³Øª (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";
  upgradeTab.textContent = "Ù‡Ù†Ø§ Ù‚Ø³Ù… Ø§Ù„ØªØ±Ù‚ÙŠØ© Ù„Ø¨Ø±Ø¬ Ø§Ù„Ø¨ÙˆØ³Øª (Ù‡Ù†Ø¸Ø¨Ø·Ù‡ Ø¨Ø¹Ø¯ÙŠÙ†).";

  panel.appendChild(infoTab);
  panel.appendChild(upgradeTab);

  document.body.appendChild(panel);

  function switchTab(key) {
    if (key === "info") {
      infoTab.style.display = "block";
      upgradeTab.style.display = "none";
      infoTabBtn.style.color = "#facc15";
      upgradeTabBtn.style.color = "#9ca3af";
    } else {
      infoTab.style.display = "none";
      upgradeTab.style.display = "block";
      infoTabBtn.style.color = "#9ca3af";
      upgradeTabBtn.style.color = "#facc15";
    }
  }
}


// Right arrow options
const rightArrowBtn = document.getElementById("right-arrow-btn");
const rightOptions = document.getElementById("right-options");

if (rightArrowBtn && rightOptions) {
  rightArrowBtn.addEventListener("click", () => {
    rightOptions.classList.toggle("open");
    rightArrowBtn.classList.toggle("open");
  });
}

function closeRightMenu() {
  if (!rightOptions || !rightArrowBtn) return;
  rightOptions.classList.remove("open");
  rightArrowBtn.classList.remove("open");
}

const inviteIcon = document.getElementById("invite-icon");
const pvpIcon = document.getElementById("pvp-icon");
const chatIcon = document.getElementById("chat-icon");
const passIcon = document.getElementById("pass-icon");


// Ø±Ø¨Ø· Ø§Ù„Ø´Ø§Øª
const chatBackBtn = document.querySelector(".chat-back-btn");

if (chatIcon) {
  chatIcon.addEventListener("click", () => {
    openChat();
    closeRightMenu();
  });
}

if (chatBackBtn) {
  chatBackBtn.addEventListener("click", closeChat);
}

function formatNumberShort(n) {
  n = Number(n) || 0;
  if (n >= 1_000_000_000) return (n / 1_000_000_000).toFixed(1).replace(/\.0$/, "") + "B";
  if (n >= 1_000_000)     return (n / 1_000_000).toFixed(1).replace(/\.0$/, "") + "M";
  if (n >= 1_000)         return (n / 1_000).toFixed(1).replace(/\.0$/, "") + "K";
  return n.toString();
}

function addTopBar() {
  if (document.getElementById("top-bar")) return;

  const topBar = document.createElement("div");
  topBar.id = "top-bar";

  // Ø­Ø§ÙˆÙŠØ© Ø§Ù„ØµÙˆØ±Ø© + Ø§Ù„Ø¨Ø§ÙˆØ±
  const avatarWrapper = document.createElement("div");
  avatarWrapper.style.display = "flex";
  avatarWrapper.style.flexDirection = "column";
  avatarWrapper.style.alignItems = "center";
  avatarWrapper.style.gap = "2px";

  const avatar = document.createElement("img");
  avatar.id = "player-avatar";
  avatar.src = currentHero + ".png";
  avatar.addEventListener("click", openProfile);

  // Ø³Ø·Ø± Ø§Ù„Ù‚ÙˆØ© ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø©
  const powerLine = document.createElement("div");
  powerLine.id = "topbar-power";
  powerLine.style.fontSize = "11px";
  powerLine.style.color = "#facc15";
  powerLine.textContent = "Power: " + formatShortNumber(totalPower);

  avatarWrapper.appendChild(avatar);
  avatarWrapper.appendChild(powerLine);

  // ÙƒØ¨Ø³ÙˆÙ„Ø© Ø¹Ù…Ø§Ù„ Ø§Ù„Ø¨Ù†Ø§Ø¡ (ÙƒØ¨Ø³ÙˆÙ„Ø© ÙƒØ§Ù…Ù„Ø©)
  const buildersCapsule = document.createElement("div");
  buildersCapsule.id = "builders-capsule";
  buildersCapsule.style.display = "flex";
  buildersCapsule.style.alignItems = "center";
  buildersCapsule.style.gap = "4px";
 buildersCapsule.style.padding = "8px 12px";
  buildersCapsule.style.borderRadius = "999px";
  buildersCapsule.style.background = "rgba(15,23,42,0.9)";
buildersCapsule.style.fontSize = "16px";
  buildersCapsule.style.cursor = "pointer";

  const builderIcon = document.createElement("span");
  builderIcon.textContent = "ğŸ‘·";
builderIcon.style.fontSize = "16px";
  const buildersCount = document.createElement("span");
  buildersCount.id = "builders-count";
  // Ø¹Ø¯Ø¯ Ø§Ù„Ø¹Ù…Ø§Ù„ Ø§Ù„Ù…ØªØ§Ø­ÙŠÙ† / Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
  buildersCount.textContent = (maxBuilders - busyBuilders) + "/" + maxBuilders;

  buildersCapsule.appendChild(builderIcon);
  buildersCapsule.appendChild(buildersCount);

  buildersCapsule.onclick = function () {
    // TODO: openBuildersPanel();
  };

  // Ø­Ø§ÙˆÙŠØ© ÙƒØ¨Ø³ÙˆÙ„Ø§Øª Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
  const resourcesDiv = document.createElement("div");
  resourcesDiv.id = "resources";
  resourcesDiv.style.display = "flex";
  resourcesDiv.style.gap = "4px";

  // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ¨Ø³ÙˆÙ„Ø© Ù…ÙˆØ±Ø¯
  function makeResourceCapsule(key, icon) {
    const cap = document.createElement("div");
    cap.className = "resource-cap";
    cap.style.display = "flex";
    cap.style.alignItems = "center";
    cap.style.gap = "4px";
    cap.style.padding = "8px 12px";
    cap.style.borderRadius = "999px";
    cap.style.background = "rgba(15,23,42,0.9)";
    cap.style.fontSize = "16px";
    cap.style.cursor = "pointer";

    const iconSpan = document.createElement("span");
    iconSpan.textContent = icon;
iconSpan.style.fontSize = "16px";

    const valueSpan = document.createElement("span");
    valueSpan.id = "res-" + key;
    valueSpan.textContent = "0";

    const plusBtn = document.createElement("span");
    plusBtn.textContent = "+";
    plusBtn.style.fontWeight = "bold";
    plusBtn.style.marginLeft = "2px";

    // ÙØªØ­ Ø§Ù„Ø³ÙˆÙ‚ Ù…Ù† Ø§Ù„ÙƒØ¨Ø³ÙˆÙ„Ø© ÙƒÙ„Ù‡Ø§
    cap.onclick = function () {
      openResourceShop(key);
    };

    // ÙˆÙØªØ­ Ø§Ù„Ø³ÙˆÙ‚ ÙƒÙ…Ø§Ù† Ù…Ù† Ø²Ø± +
    plusBtn.onclick = function (ev) {
      ev.stopPropagation();
      openResourceShop(key);
    };

    cap.appendChild(iconSpan);
    cap.appendChild(valueSpan);
    cap.appendChild(plusBtn);
    resourcesDiv.appendChild(cap);
  }

  // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ¨Ø³ÙˆÙ„Ø§Øª: Ø°Ù‡Ø¨ - Ø®Ø´Ø¨ - Ù„Ø­Ù… - Ø¬ÙˆØ§Ù‡Ø±
  makeResourceCapsule("gold", "ğŸª™");
  makeResourceCapsule("wood", "ğŸŒ²");
  makeResourceCapsule("food", "ğŸ–");
  makeResourceCapsule("gem", "ğŸ’");

  // Ø²Ø± Ø§Ù„Ù…Ù†ÙŠÙˆ
  const menuBtn = document.createElement("span");
  menuBtn.id = "menu-btn";
  menuBtn.textContent = "â˜°";
menuBtn.addEventListener("click", function () {
  // TODO: Ø§ÙØªØ­ Ù…Ù†ÙŠÙˆ Ø¨Ø¹Ø¯ÙŠÙ†
});


  // ØªØ±ØªÙŠØ¨ Ø§Ù„ØªÙˆØ¨ Ø¨Ø§Ø±: Ø¨Ø±ÙˆÙØ§ÙŠÙ„ -> Ø¹Ù…Ø§Ù„ -> Ù…ÙˆØ§Ø±Ø¯ -> Ù…Ù†ÙŠÙˆ
  topBar.appendChild(avatarWrapper);
  topBar.appendChild(buildersCapsule);
  topBar.appendChild(resourcesDiv);
  topBar.appendChild(menuBtn);

  cityScreen.appendChild(topBar);

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø¯ÙˆØ±ÙŠÙ‹Ø§
  function updateTopBarInner() {
    const goldEl = document.getElementById("res-gold");
    if (goldEl) goldEl.textContent = formatNumberShort(resources.gold);

    const woodEl = document.getElementById("res-wood");
    if (woodEl) woodEl.textContent = formatNumberShort(resources.wood);

    const foodEl = document.getElementById("res-food");
    if (foodEl) foodEl.textContent = formatNumberShort(resources.food);

    const gemEl = document.getElementById("res-gem");
    if (gemEl) gemEl.textContent = formatNumberShort(resources.gem);

    const buildersEl = document.getElementById("builders-count");
    if (buildersEl) {
      const freeBuilders = maxBuilders - busyBuilders;
      buildersEl.textContent = freeBuilders + "/" + maxBuilders;
    }

    const powerEl = document.getElementById("topbar-power");
    if (powerEl) {
      powerEl.textContent = "Power: " + formatShortNumber(totalPower);
    }
  }

  updateTopBarInner();
  setInterval(updateTopBarInner, 2000);
}


     /* --- Bottom Bar --- */
function addBottomBar() {
  if (document.getElementById("bottom-bar")) return;
  const bottomBar = document.createElement("div");
  bottomBar.id = "bottom-bar";
  bottomBar.style.zIndex = 100;
  const items = [
    { name: "City", icon: "ğŸ™ï¸" },
    { name: "Task", icon: "ğŸ“‹" },
    { name: "War", icon: "âš”ï¸" },
    { name: "Clan", icon: "ğŸ°" },
    { name: "Fight", icon: "ğŸ”¥" },
  ];

  items.forEach((item) => {
    const div = document.createElement("div");
    div.classList.add("bar-item");

    if (item.name === "City") {
      div.classList.add("bar-item-active");
    }

    div.innerHTML = `<span>${item.icon}</span>${item.name}`;

    if (item.name === "Task") {
      div.id = "tasks-bar-item";            // â† Ø³Ø·Ø± Ø¬Ø¯ÙŠØ¯
      div.addEventListener("click", openTasksPage);
    } else if (item.name === "Clan") {
      div.addEventListener("click", openClanPage);
    }

    bottomBar.appendChild(div);
  });



  cityScreen.appendChild(bottomBar);
}

      /* --- Tasks --- */
      function generateDailyTasks() {
        tasks = [
          { desc: "Collect 100 gold", completed: false, reward: { gold: 100 } },
          { desc: "Collect 50 wood", completed: false, reward: { wood: 50 } },
          {
            desc: "Check Castle Upgrade",
            completed: false,
            reward: { gem: 10 },
          },
        ];
      }
      generateDailyTasks();

      function renderTasksPage() {
        tasksPageContent.innerHTML = "";
        tasks.forEach((t, i) => {
          const div = document.createElement("div");
          div.className = "task-item";
          if (t.completed) div.classList.add("completed");
          div.textContent = t.desc + (t.completed ? " âœ…" : "");
          div.addEventListener("click", () => {
            if (!t.completed) {
              t.completed = true;
              for (const r in t.reward) resources[r] += t.reward[r];
              renderTasksPage();
            }
          });
          tasksPageContent.appendChild(div);
        });
      }
function recalcTasksNotification() {
  // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù„ÙƒÙ„ ØªØ§Ø¨
  let hasMainReady = false;
  let hasDailyReady = false;
  let hasWeeklyReady = false;
  let hasSocialReady = false;

  const checkTasks = (list, stateObj, flagName) => {
    if (!stateObj) return;
    list.forEach(task => {
      const st = stateObj[task.id];
      if (st && st.done && !st.claimed) {
        if (flagName === "main") hasMainReady = true;
        if (flagName === "daily") hasDailyReady = true;
        if (flagName === "weekly") hasWeeklyReady = true;
        if (flagName === "social") hasSocialReady = true;
      }
    });
  };

  checkTasks(MAIN_TASKS, mainTasksState, "main");
  checkTasks(DAILY_TASKS, dailyTasksState, "daily");
  checkTasks(WEEKLY_TASKS, weeklyTasksState, "weekly");
  checkTasks(SOCIAL_TASKS, socialTasksState, "social");

  // ØµÙ†Ø§Ø¯ÙŠÙ‚ Daily/Weekly
  const hasDailyChestReady =
    DAILY_CHESTS.some(c => dailyPoints >= c.requiredPoints && !c.claimed);
  const hasWeeklyChestReady =
    WEEKLY_CHESTS.some(c => weeklyPoints >= c.requiredPoints && !c.claimed);

  if (hasDailyChestReady) hasDailyReady = true;
  if (hasWeeklyChestReady) hasWeeklyReady = true;

  // Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ø¹Ø§Ù… Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø© Tasks ØªØ­Øª
  hasTasksNotification =
    hasMainReady || hasDailyReady || hasWeeklyReady || hasSocialReady;

  updateTasksIconNotification(hasTasksNotification);
  updateTasksTabsNotification({
    main: hasMainReady,
    daily: hasDailyReady,
    weekly: hasWeeklyReady,
    social: hasSocialReady
  });
}
function updateTasksIconNotification(show) {
  const item = document.getElementById("tasks-bar-item");
  if (!item) return;

  const oldDot = item.querySelector(".tasks-notif-dot");
  if (oldDot) oldDot.remove();

  if (!show) return;

  const dot = document.createElement("div");
  dot.className = "tasks-notif-dot";
  dot.style.position = "absolute";
  dot.style.top = "4px";
  dot.style.right = "18px";
  dot.style.width = "8px";
  dot.style.height = "8px";
  dot.style.borderRadius = "50%";
  dot.style.background = "#ef4444";
  dot.style.boxShadow = "0 0 6px rgba(248, 113, 113, 0.9)";

  item.style.position = "relative";
  item.appendChild(dot);
}
function updateTasksTabsNotification(flags) {
  const tabs = document.querySelectorAll(".tasks-tab-btn");
  if (!tabs || !tabs.length) return;

  tabs.forEach(btn => {
    const tabKey = btn.getAttribute("data-tab");
    if (!tabKey) return;

    // Ø§Ù…Ø³Ø­ Ø£ÙŠ Ù†Ù‚Ø·Ø© Ù‚Ø¯ÙŠÙ…Ø©
    const oldDot = btn.querySelector(".tasks-tab-dot");
    if (oldDot) oldDot.remove();

    const hasNotif = !!flags[tabKey];
    if (!hasNotif) return;

    // Ø§Ø¹Ù…Ù„ Ù†Ù‚Ø·Ø© Ø¬Ø¯ÙŠØ¯Ø©
    const dot = document.createElement("div");
    dot.className = "tasks-tab-dot";
    dot.style.position = "absolute";
    dot.style.top = "2px";
    dot.style.right = "8px";
    dot.style.width = "7px";
    dot.style.height = "7px";
    dot.style.borderRadius = "50%";
    dot.style.background = "#facc15";
    dot.style.boxShadow = "0 0 6px rgba(250, 204, 21, 0.9)";

    btn.style.position = "relative";
    btn.appendChild(dot);
  });
}

   /* --- Profile --- */
function openProfile() {
  const statsPage = document.getElementById("stats-page");
  if (!statsPage) return;

  const playerName = localStorage.getItem("playerName") || "Player";
  const currentHeroStored = localStorage.getItem("hero") || "elephant";
  currentHero = currentHeroStored;

  // Ø¹Ù†Ø§ØµØ± Ø§Ù„Ù€ DOM
  const nameEl = document.getElementById("profile-name");
  const metaEl = document.getElementById("profile-meta");
  const subEl = document.getElementById("profile-sub");
  const heroImg = document.getElementById("profile-hero-img");
  const castleLevelEl = document.getElementById("profile-castle-level");
  const buildingsLevelEl = document.getElementById("profile-buildings-level");
  const powerEl = document.getElementById("profile-power");

  // Ø§Ù„Ø§Ø³Ù…
  if (nameEl) {
    nameEl.textContent = playerName;
  }

  // ØµÙˆØ±Ø© Ø§Ù„Ù‡ÙŠØ±Ùˆ
  if (heroImg) {
    heroImg.src = currentHero + ".png";
  }

  // ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
  let joinDate = localStorage.getItem("joinDate");
  if (!joinDate) {
    joinDate = new Date().toISOString();
    localStorage.setItem("joinDate", joinDate);
  }
  const diffDays = Math.floor(
    (new Date() - new Date(joinDate)) / (1000 * 60 * 60 * 24)
  );
  if (subEl) {
    subEl.textContent = `Joined: ${diffDays} days | Clan: None`;
  }

  // Castle Lv Ùˆ Power ÙÙŠ Ø§Ù„Ø³Ø·Ø± Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
 if (metaEl) {
  metaEl.textContent = `Castle Lv. ${castleLevel} â€¢ Power ${formatShortNumber(totalPower)}`;
}


  // Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ù€ grid
  if (castleLevelEl) {
    castleLevelEl.textContent = castleLevel.toString();
  }

  if (buildingsLevelEl) {
    const sumLevels =
      (buildingLevels.goldMine || 1) +
      (buildingLevels.woodMine || 1) +
      (buildingLevels.meatFarm || 1) +
      (buildingLevels.school || 1) +
      (buildingLevels.hospital || 1);
    buildingsLevelEl.textContent = sumLevels.toString();
  }

  if (powerEl) {
  powerEl.textContent = formatShortNumber(totalPower);
}


  // Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙŠØ´ (Ù†ÙØ³ ÙÙƒØ±ØªÙƒ Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©)
  renderArmy();

  // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¨Ø§Ù†Ù„
  statsPage.classList.remove("game-page-hidden");
}

function closeStats() {
  const statsPage = document.getElementById("stats-page");
  if (statsPage) {
    statsPage.classList.add("game-page-hidden");
  }
}

function renderArmy() {
  armyContainer.innerHTML = "";
  army.forEach((u) => {
    const div = document.createElement("div");
    div.className = "army-card";
    div.innerHTML = `<img src="${u.img}" width="50" height="50">
<span>âš”ï¸ ${u.attack}</span>
<span>ğŸ›¡ï¸ ${u.defense}</span>
<span>ğŸ’ ${u.capacity}</span>`;
    armyContainer.appendChild(div);
  });
}

function changeHero() {
  document.getElementById("hero-selection").classList.remove("hidden");
}

function selectHero(heroChoice) {
  if (heroes[heroChoice]) {
    currentHero = heroChoice;
    profileHeroImg.src = currentHero + ".png";
    localStorage.setItem("hero", currentHero);
    document.getElementById("player-avatar").src = currentHero + ".png";
    closeHeroSelection();
  }
}

function closeHeroSelection() {
  document.getElementById("hero-selection").classList.add("hidden");
}

      /* --- Invite --- */
      let inviteCode = localStorage.getItem("inviteCode");
      if (!inviteCode) {
        inviteCode = Math.random().toString(36).substring(2, 8).toUpperCase();
        localStorage.setItem("inviteCode", inviteCode);
      }
      inviteLinkInput.value = `https://t.me/raidex_mini_app?start=${inviteCode}`;
      let invitedFriends = JSON.parse(
        localStorage.getItem("invitedFriends") || "[]"
      );
      function updateFriendsList() {
        invitedFriendsList.innerHTML = "";
        if (invitedFriends.length === 0)
          invitedFriendsList.innerHTML = "<li>No friends joined yet.</li>";
        else
          invitedFriends.forEach((f) => {
            const li = document.createElement("li");
            li.textContent = f;
            li.style.padding = "5px 0";
            invitedFriendsList.appendChild(li);
          });
      }
      updateFriendsList();
      function openInvites() {
        invitesPage.classList.remove("hidden");
      }
      function closeInvites() {
        invitesPage.classList.add("hidden");
      }
      inviteBtn.addEventListener("click", openInvites);



   /* --- Start App --- */
window.addEventListener("load", () => {
  const selectedHero = localStorage.getItem("hero");
  let width = 0;
  const interval = setInterval(() => {
    width++;
    loadingFill1.style.width = width + "%";
    loadingFill1.textContent = width + "%";
    if (width >= 100) {
      clearInterval(interval);
      document.getElementById("loading1").style.display = "none";

      // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ + Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ù„Ø¹Ø©)
      loadGameState();
loadBuildingsState();    
      recalcBuildingsUnlockByCastleLevel(); 
            loadClanState();

      if (!selectedHero) {
        characterScreen.style.display = "block";
      } else {
        currentHero = selectedHero;
        enterCity();
      }
    }
  }, 30);
    wireClanButtons();

});

  window.addEventListener("load", () => {
  // Language Modal
  const languageSetting = document.getElementById("language-setting");
  const languageModal = document.getElementById("language-modal");
  if (languageSetting) {
    languageSetting.addEventListener("click", () => {
      languageModal.classList.remove("hidden");
    });
  }

  // Telegram / Twitter
  const telegramSetting = document.getElementById("telegram-setting");
  if (telegramSetting) {
    telegramSetting.addEventListener("click", () => {
      window.open("https://t.me/Raidex_Official", "_blank");
    });
  }

  const twitterSetting = document.getElementById("twitter-setting");
  if (twitterSetting) {
    twitterSetting.addEventListener("click", () => {
      window.open("https://x.com/raidexgames", "_blank");
    });
  }

  // Terms of Use
  const termsSetting = document.getElementById("terms-setting");
  if (termsSetting) {
    termsSetting.addEventListener("click", () => {
      alert(
        "Terms of Use:\n\nBy using this game, you agree to follow the rules and guidelines. Respect other players and avoid cheating. All data collected will be handled according to our Privacy Policy."
      );
    });
  }

  // Privacy Policy
  const privacySetting = document.getElementById("privacy-setting");
  if (privacySetting) {
    privacySetting.addEventListener("click", () => {
      alert(
        "Privacy Policy:\n\nWe respect your privacy. Any data collected (username, game progress) is stored securely and will not be shared with third parties. You can request data deletion at any time."
      );
    });
  }
    // â¬‡ï¸â¬‡ï¸ Ù‡Ù†Ø§ Ø£Ø¶Ù Ø±Ø¨Ø· Ø²Ø± Ø§Ù„ØªØ±Ù‚ÙŠØ© ÙˆØ§Ù„Ø¥Ù„ØºØ§Ø¡ â¬‡ï¸â¬‡ï¸
  const castleStartUpgradeBtn = document.getElementById("castle-start-upgrade-btn");
  if (castleStartUpgradeBtn) {
    castleStartUpgradeBtn.addEventListener("click", () => {
      startCastlePanelUpgrade();
    });
  }

  const castleCancelUpgradeBtn = document.getElementById("castle-cancel-upgrade-btn");
  if (castleCancelUpgradeBtn) {
    castleCancelUpgradeBtn.addEventListener("click", () => {
      cancelCastlePanelUpgrade();
    });
  }
});

// ===== Castle Panel logic (ÙØªØ­/Ù‚ÙÙ„) =====
function openCastlePanel() {
  const panel = document.getElementById("castle-panel");
  if (!panel) return;
  // Ø§Ù‚ÙÙ„ ÙƒÙ„ ØµÙØ­Ø§Øª Ø§Ù„Ø¬ÙŠÙ… Ø§Ù„Ù„ÙŠ Ø¨ÙŠÙ† Ø§Ù„ØªÙˆØ¨ ÙˆØ§Ù„Ø¨ÙˆØªÙ… Ø¨Ø§Ø±
  hideAllGamePages(); // ØªØ³ØªØ®Ø¯Ù… GAME_PAGE_IDS
  // Ø¸Ø§Ù‡Ø± Ø¨Ø§Ù†Ù„ Ø§Ù„Ù‚Ù„Ø¹Ø©
  panel.classList.remove("castle-hidden");
  panel.classList.add("castle-visible");

  // Ø­Ø¯Ù‘Ø« Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
  if (typeof updateCastleInfoTab === "function") {
    updateCastleInfoTab();
  }
  if (typeof updateCastleUpgradeTab === "function") {
    updateCastleUpgradeTab();
  }
}

function closeCastlePanel() {
  const panel = document.getElementById("castle-panel");
  if (!panel) return;
  panel.classList.remove("castle-visible");
  panel.classList.add("castle-hidden");
}

// Ø±Ø¨Ø· Ø²Ø± Ø§Ù„Ø³Ù‡Ù… Ø¬ÙˆÙ‡ panel + ØªØ¬Ù‡ÙŠØ² popup Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©
document.addEventListener("DOMContentLoaded", () => {
  // Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹
  const backBtn = document.getElementById("castle-back-btn");
  if (backBtn) {
    backBtn.addEventListener("click", () => {
      closeCastlePanel();
    });
  }

  // Ø¹Ù†Ø§ØµØ± popup Ø§Ù„Ø¥Ù„ØºØ§Ø¡
  const castleCancelPopup = document.getElementById("castle-cancel-popup");
  const castleCancelConfirmBtn = document.getElementById("castle-cancel-confirm");
  const castleCancelDismissBtn = document.getElementById("castle-cancel-dismiss");

  // Ø¥Ø®ÙØ§Ø¡ popup ÙÙŠ Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
  if (castleCancelPopup) {
    castleCancelPopup.style.display = "none";
  }

  // Ø²Ø± "Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©" ÙÙŠ panel Ø§Ù„Ù‚Ù„Ø¹Ø©
  const castleCancelUpgradeBtn = document.getElementById("castle-cancel-upgrade-btn");
  if (castleCancelUpgradeBtn) {
    castleCancelUpgradeBtn.addEventListener("click", () => {
      cancelCastlePanelUpgrade();
    });
  }

  // Ø­ÙØ¸ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ window Ø¹Ø´Ø§Ù† Ù†Ø³ØªØ®Ø¯Ù…Ù‡Ø§ ÙÙŠ Ø§Ù„Ø¯Ø§Ù„Ø©
  window.castleCancelPopup = castleCancelPopup;
  window.castleCancelConfirmBtn = castleCancelConfirmBtn;
  window.castleCancelDismissBtn = castleCancelDismissBtn;
});

// ØªØ¨Ø¯ÙŠÙ„ ØªØ¨ÙˆÙŠØ¨Ø§Øª Ø§Ù„Ù‚Ù„Ø¹Ø©
document.addEventListener("DOMContentLoaded", () => {
  const castleTabButtons = document.querySelectorAll(".castle-tab-button");
  const castleTabContents = document.querySelectorAll(".castle-tab-content");

  castleTabButtons.forEach((btn) => {
    btn.addEventListener("click", () => {
      const targetId = btn.getAttribute("data-tab");

      // ÙØ¹Ù‘Ù„ Ø§Ù„Ø²Ø± Ø§Ù„Ù…Ø®ØªØ§Ø±
      castleTabButtons.forEach((b) => b.classList.remove("active"));
      btn.classList.add("active");

      // Ø£Ø¸Ù‡Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ù†Ø§Ø³Ø¨
      castleTabContents.forEach((content) => {
        if (content.id === targetId) {
          content.classList.add("active");
        } else {
          content.classList.remove("active");
        }
      });
    });
  });
});
// ØªØ­Ø¯ÙŠØ« ØªØ¨ÙˆÙŠØ¨ "Ù…Ø¹Ù„ÙˆÙ…Ø§Øª"
function updateCastleInfoTab() {
  const levelEl = document.getElementById("castle-info-level");
  const powerEl = document.getElementById("castle-info-power");
  const storageEl = document.getElementById("castle-info-storage");

  if (levelEl) levelEl.textContent = castleLevel.toString();
  if (powerEl) powerEl.textContent = getCastlePowerForLevel(castleLevel).toString();
  if (storageEl) storageEl.textContent = getCastleStorageCapacity(castleLevel).toString();
}
function getCastleRequirementsForLevel(nextLevel) {
  const req = CASTLE_LEVEL_REQUIREMENTS[nextLevel];
  if (!req) return null;
  return req.requiredBuildings || null;
}

// ØªØ­Ø¯ÙŠØ« ØªØ¨ÙˆÙŠØ¨ "ØªØ±Ù‚ÙŠØ©"
function updateCastleUpgradeTab() {
  const currentLevelEl = document.getElementById("castle-upgrade-current-level");
  const nextLevelEl = document.getElementById("castle-upgrade-next-level");
  const goldCostEl = document.getElementById("castle-upgrade-gold-cost");
  const woodCostEl = document.getElementById("castle-upgrade-wood-cost");
  const foodCostEl = document.getElementById("castle-upgrade-food-cost");
  const timeEl = document.getElementById("castle-upgrade-time");

  const currentLevel = castleLevel;
  const nextLevel = Math.min(castleLevel + 1, castleMaxLevel);

  const goldCost = getCastleGoldCost(currentLevel);
  const woodCost = getCastleWoodCost(currentLevel);
  const foodCost = getCastleFoodCost(currentLevel);
  const upgradeTimeSec = getCastleUpgradeTime(currentLevel);

  if (currentLevelEl) currentLevelEl.textContent = currentLevel.toString();
  if (nextLevelEl) nextLevelEl.textContent = nextLevel.toString();
  if (goldCostEl) goldCostEl.textContent = goldCost.toString();
  if (woodCostEl) woodCostEl.textContent = woodCost.toString();
  if (foodCostEl) foodCostEl.textContent = foodCost.toString();
  if (timeEl) timeEl.textContent = formatDuration(upgradeTimeSec);
  // ----- Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ù„Ù„ØªØ±Ù‚ÙŠØ© -----
  const reqContainer = document.getElementById("castle-upgrade-required-buildings");
  if (!reqContainer) return;

  reqContainer.innerHTML = "";

  const requirements = getCastleRequirementsForLevel(nextLevel);
  if (!requirements) {
    return; // Ù…ÙÙŠØ´ Ù…ØªØ·Ù„Ø¨Ø§Øª Ø®Ø§ØµØ© Ù„Ù„Ù…Ø³ØªÙˆÙ‰ Ø¯Ù‡
  }

  const title = document.createElement("div");
  title.textContent = "Ù„ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø© ÙŠØ¬Ø¨ ØªØ·ÙˆÙŠØ± Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¨Ø§Ù†ÙŠ:";
  title.style.fontSize = "12px";
  title.style.margin = "6px 0 4px 0";
  reqContainer.appendChild(title);

  const row = document.createElement("div");
  row.style.display = "flex";
  row.style.flexWrap = "wrap";
  row.style.gap = "6px";
  reqContainer.appendChild(row);

  for (const [key, neededLevel] of Object.entries(requirements)) {
    const currentLvl = buildingLevels[key] || 0;
    const ok = currentLvl >= neededLevel;

    const item = document.createElement("div");
    item.style.minWidth = "90px";
    item.style.padding = "4px 6px";
    item.style.borderRadius = "8px";
    item.style.background = "rgba(15, 23, 42, 0.9)";
    item.style.fontSize = "11px";
    item.style.textAlign = "center";
item.style.cursor = "pointer";
item.onclick = () => {
  openBuildingPanel(key);
};

    const img = document.createElement("img");
    img.src = getBuildingImageByKey(key);
    img.style.width = "28px";
    img.style.height = "28px";
    img.style.objectFit = "contain";
    img.style.display = "block";
    img.style.margin = "0 auto 2px auto";

    const name = document.createElement("div");
    name.style.marginBottom = "2px";
    name.textContent = getBuildingNameByKey(key);

    const status = document.createElement("div");
    status.textContent = `Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: ${neededLevel} - Ø§Ù„Ø­Ø§Ù„ÙŠ: ${currentLvl}`;
    status.style.color = ok ? "#22c55e" : "#ef4444";

    item.appendChild(img);
    item.appendChild(name);
    item.appendChild(status);
    row.appendChild(item);
  }
}
function updateGoldMineUpgradeTab() {
  const currentLevelEl = document.getElementById("gold-mine-upgrade-current-level");
  const nextLevelEl    = document.getElementById("gold-mine-upgrade-next-level");
  const goldCostEl     = document.getElementById("gold-mine-upgrade-gold-cost");
  const woodCostEl     = document.getElementById("gold-mine-upgrade-wood-cost");
  const foodCostEl     = document.getElementById("gold-mine-upgrade-food-cost");
  const timeEl         = document.getElementById("gold-mine-upgrade-time");

  const infoLevelEl    = document.getElementById("gold-mine-info-level");
  const infoProdEl     = document.getElementById("gold-mine-info-production");

  const level     = goldMineLevel;
  const nextLevel = goldMineLevel + 1;

  const goldCost = getCastleGoldCost(level);
  const woodCost = getCastleWoodCost(level);
  const foodCost = getCastleFoodCost(level);
  const timeSec  = getCastleUpgradeTime(level);

  if (currentLevelEl) currentLevelEl.textContent = level.toString();
  if (nextLevelEl)    nextLevelEl.textContent    = nextLevel.toString();
  if (goldCostEl)     goldCostEl.textContent     = goldCost.toString();
  if (woodCostEl)     woodCostEl.textContent     = woodCost.toString();
  if (foodCostEl)     foodCostEl.textContent     = foodCost.toString();
  if (timeEl)         timeEl.textContent         = formatDuration(timeSec);

  if (infoLevelEl) infoLevelEl.textContent = level.toString();
  if (infoProdEl)  infoProdEl.textContent  = (level * 100).toString();
}

function startGoldMineUpgrade() {
  if (goldMineUpgradeInProgress) return;

  const level = goldMineLevel;
  const goldCost = getCastleGoldCost(level);
  const woodCost = getCastleWoodCost(level);
  const foodCost = getCastleFoodCost(level);
  const upgradeTimeSec = getCastleUpgradeTime(level);

  if (resources.gold < goldCost ||
      resources.wood < woodCost ||
      resources.food < foodCost) {
    alert("Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„ØªØ±Ù‚ÙŠØ© Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨.");
    return;
  }

  resources.gold -= goldCost;
  resources.wood -= woodCost;
  resources.food -= foodCost;

  lastGoldMineGoldCost = goldCost;
  lastGoldMineWoodCost = woodCost;
  lastGoldMineFoodCost = foodCost;

  if (typeof updateTopBar === "function") {
    updateTopBar();
  }

  goldMineUpgradeInProgress     = true;
  goldMineUpgradeRemainingTime  = upgradeTimeSec;
  goldMineUpgradeFinishAt       = Date.now() + upgradeTimeSec * 1000;

  saveGameState();

  const wrapper = document.getElementById("gold-mine-upgrade-progress-wrapper");
  const fill    = document.getElementById("gold-mine-upgrade-progress-fill");
  const timeEl  = document.getElementById("gold-mine-upgrade-remaining-time");

  if (wrapper) wrapper.style.display = "block";
  if (timeEl)  timeEl.textContent   = formatDuration(goldMineUpgradeRemainingTime);
  if (fill)    fill.style.width     = "100%";

  const totalTime = upgradeTimeSec;

  if (goldMineUpgradeInterval) clearInterval(goldMineUpgradeInterval);
  goldMineUpgradeInterval = setInterval(() => {
    goldMineUpgradeRemainingTime -= 1;
    if (goldMineUpgradeRemainingTime < 0) goldMineUpgradeRemainingTime = 0;

    if (timeEl) {
      timeEl.textContent = formatDuration(goldMineUpgradeRemainingTime);
    }

    const ratio = totalTime > 0 ? goldMineUpgradeRemainingTime / totalTime : 0;
    if (fill) {
      const percent = Math.max(0, Math.min(100, ratio * 100));
      fill.style.width = percent + "%";
    }

    if (goldMineUpgradeRemainingTime <= 0) {
      clearInterval(goldMineUpgradeInterval);
      goldMineUpgradeInterval = null;
      finishGoldMineUpgrade();
    }
  }, 1000);
}

function finishGoldMineUpgrade() {
  goldMineUpgradeInProgress = false;
  goldMineUpgradeFinishAt   = null;

  goldMineLevel += 1;
  buildingLevels.goldMine = goldMineLevel;

  updateGoldMineUpgradeTab();

  const wrapper = document.getElementById("gold-mine-upgrade-progress-wrapper");
  const fill    = document.getElementById("gold-mine-upgrade-progress-fill");
  const timeEl  = document.getElementById("gold-mine-upgrade-remaining-time");

  if (wrapper) wrapper.style.display = "none";
  if (fill)    fill.style.width     = "0%";
  if (timeEl)  timeEl.textContent   = formatDuration(0);

  saveGameState();
}

function startCastlePanelUpgrade() {
  if (upgradeInProgress) {
    return; // ÙÙŠ ØªØ±Ù‚ÙŠØ© Ø´ØºØ§Ù„Ø© Ø¨Ø§Ù„ÙØ¹Ù„
  }

  if (castleLevel >= castleMaxLevel) {
    alert("ÙˆØµÙ„Øª Ù„Ø£Ù‚ØµÙ‰ Ù…Ø³ØªÙˆÙ‰ Ù„Ù„Ù‚Ù„Ø¹Ø©");
    return;
  }

  const nextLevel = castleLevel + 1;
  if (!canUpgradeCastleTo(nextLevel)) {
    alert("Ø·ÙˆÙ‘Ø± Ù…Ø¨Ø§Ù†ÙŠ Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ (ÙˆØ§Ù„Ø´Ø±ÙˆØ· Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©) Ù‚Ø¨Ù„ ØªØ±Ù‚ÙŠØ© Ø§Ù„Ù‚Ù„Ø¹Ø©.");
    return;
  }

  const level = castleLevel;
  const goldCost = getCastleGoldCost(level);
  const woodCost = getCastleWoodCost(level);
  const foodCost = getCastleFoodCost(level);
  const upgradeTimeSec = getCastleUpgradeTime(level);

  console.log("DEBUG resources:", resources);
  console.log("DEBUG cost:", { goldCost, woodCost, foodCost });

  // ØªØ£ÙƒØ¯ Ø¥Ù† Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙƒÙØ§ÙŠØ©
  if (resources.gold < goldCost || resources.wood < woodCost || resources.food < foodCost) {
    alert("Not enough resources!");
    return;
  }

  // ØªØ£ÙƒØ¯ Ø¥Ù† ÙÙŠÙ‡ Ø¹Ø§Ù…Ù„ Ù…ØªØ§Ø­
  if (busyBuilders >= maxBuilders) {
    alert("No free builders available!");
    return;
  }

  // Ø®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯
  resources.gold -= goldCost;
  resources.wood -= woodCost;
  resources.food -= foodCost;

  // Ø­ÙØ¸ Ø¢Ø®Ø± ØªÙƒÙ„ÙØ© (Ù„Ù„Ø¥Ø±Ø¬Ø§Ø¹ Ø¹Ù†Ø¯ Ø§Ù„Ø¥Ù„ØºØ§Ø¡)
  lastUpgradeGoldCost = goldCost;
  lastUpgradeWoodCost = woodCost;
  lastUpgradeFoodCost = foodCost;

  // ØªØ­Ø¯ÙŠØ« Ø´Ø±ÙŠØ· Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙÙˆÙ‚ Ù„Ùˆ Ø¹Ù†Ø¯Ùƒ Ø¯Ø§Ù„Ø©
  if (typeof updateTopBar === "function") {
    updateTopBar();
  }

  // Ø­Ø¬Ø² Ø¹Ø§Ù…Ù„
  busyBuilders++;

  // ØªØ¬Ù‡ÙŠØ² Ø­Ø§Ù„Ø© Ø§Ù„ØªØ±Ù‚ÙŠØ©
  upgradeInProgress = true;
  upgradeRemainingTime = upgradeTimeSec;
  upgradeFinishAt = Date.now() + upgradeTimeSec * 1000;

  // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø®ØµÙ… Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ÙˆØ¨Ø¯Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©
  saveGameState();

  // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
  const progressWrapper = document.getElementById("castle-upgrade-progress-wrapper");
  const progressFill = document.getElementById("castle-upgrade-progress-fill");
  const remainingTimeEl = document.getElementById("castle-upgrade-remaining-time");

  if (progressWrapper) progressWrapper.style.display = "block";

  const totalTime = upgradeTimeSec;
  if (progressFill) progressFill.style.width = "100%";
  if (remainingTimeEl) remainingTimeEl.textContent = formatDuration(upgradeRemainingTime);

  // Ù†Ø­Ø¯Ù‘Ø« ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ±Ù‚ÙŠØ© Ø¨Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©
  updateCastleUpgradeTab();

  // Ù…Ø¤Ù‚Øª Ø§Ù„ØªØ±Ù‚ÙŠØ©
  if (upgradeInterval) clearInterval(upgradeInterval);

  upgradeInterval = setInterval(() => {
    upgradeRemainingTime -= 1;
    if (upgradeRemainingTime < 0) upgradeRemainingTime = 0;

    if (remainingTimeEl) remainingTimeEl.textContent = formatDuration(upgradeRemainingTime);

    const ratio = totalTime > 0 ? upgradeRemainingTime / totalTime : 0;
    if (progressFill) {
      const percent = Math.max(0, Math.min(100, ratio * 100));
      progressFill.style.width = percent + "%";
    }

    if (upgradeRemainingTime <= 0) {
      clearInterval(upgradeInterval);
      upgradeInterval = null;
      finishCastlePanelUpgrade();
    }
  }, 1000);
}

function startGoldMineUpgrade() {
  if (goldMineUpgradeInProgress) return;

  const level = goldMineLevel;
  const goldCost = getCastleGoldCost(level);
  const woodCost = getCastleWoodCost(level);
  const foodCost = getCastleFoodCost(level);
  const upgradeTimeSec = getCastleUpgradeTime(level);

  if (resources.gold < goldCost ||
      resources.wood < woodCost ||
      resources.food < foodCost) {
    alert("Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ ØºÙŠØ± ÙƒØ§ÙÙŠØ© Ù„ØªØ±Ù‚ÙŠØ© Ù…Ù†Ø¬Ù… Ø§Ù„Ø°Ù‡Ø¨.");
    return;
  }

  resources.gold -= goldCost;
  resources.wood -= woodCost;
  resources.food -= foodCost;

  lastGoldMineGoldCost = goldCost;
  lastGoldMineWoodCost = woodCost;
  lastGoldMineFoodCost = foodCost;

  if (typeof updateTopBar === "function") {
    updateTopBar();
  }

  goldMineUpgradeInProgress     = true;
  goldMineUpgradeRemainingTime  = upgradeTimeSec;
  goldMineUpgradeFinishAt       = Date.now() + upgradeTimeSec * 1000;

  saveGameState();

  const wrapper = document.getElementById("gold-mine-upgrade-progress-wrapper");
  const fill    = document.getElementById("gold-mine-upgrade-progress-fill");
  const timeEl  = document.getElementById("gold-mine-upgrade-remaining-time");

  if (wrapper) wrapper.style.display = "block";
  if (timeEl)  timeEl.textContent   = formatDuration(goldMineUpgradeRemainingTime);
  if (fill)    fill.style.width     = "100%";

  const totalTime = upgradeTimeSec;

  if (goldMineUpgradeInterval) clearInterval(goldMineUpgradeInterval);
  goldMineUpgradeInterval = setInterval(() => {
    goldMineUpgradeRemainingTime -= 1;
    if (goldMineUpgradeRemainingTime < 0) goldMineUpgradeRemainingTime = 0;

    if (timeEl) {
      timeEl.textContent = formatDuration(goldMineUpgradeRemainingTime);
    }

    const ratio = totalTime > 0 ? goldMineUpgradeRemainingTime / totalTime : 0;
    if (fill) {
      const percent = Math.max(0, Math.min(100, ratio * 100));
      fill.style.width = percent + "%";
    }

    if (goldMineUpgradeRemainingTime <= 0) {
      clearInterval(goldMineUpgradeInterval);
      goldMineUpgradeInterval = null;
      finishGoldMineUpgrade();
    }
  }, 1000);
}

function finishGoldMineUpgrade() {
  goldMineUpgradeInProgress = false;
  goldMineUpgradeFinishAt   = null;

  goldMineLevel += 1;
  buildingLevels.goldMine = goldMineLevel;

  updateGoldMineUpgradeTab();

  const wrapper = document.getElementById("gold-mine-upgrade-progress-wrapper");
  const fill    = document.getElementById("gold-mine-upgrade-progress-fill");
  const timeEl  = document.getElementById("gold-mine-upgrade-remaining-time");

  if (wrapper) wrapper.style.display = "none";
  if (fill)    fill.style.width     = "0%";
  if (timeEl)  timeEl.textContent   = formatDuration(0);

  saveGameState();
}

// â† Ù‡Ù†Ø§ Ù‚ÙÙ„Ù†Ø§ Ø§Ù„Ø¯Ø§Ù„Ø© ØµØ­
function cancelCastlePanelUpgrade() {
  if (!upgradeInProgress) return;

  if (!window.castleCancelPopup || !window.castleCancelConfirmBtn || !window.castleCancelDismissBtn) {
    return;
  }

  // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù€ popup
  window.castleCancelPopup.style.display = "flex";

  // Ø²Ø± "Ø¥Ù„ØºØ§Ø¡" ÙÙŠ popup
  window.castleCancelDismissBtn.onclick = () => {
    window.castleCancelPopup.style.display = "none";
  };

  // Ø²Ø± "Ù…ÙˆØ§ÙÙ‚" ÙÙŠ popup
  window.castleCancelConfirmBtn.onclick = () => {
    window.castleCancelPopup.style.display = "none";

    // Ø§Ø³ØªØ±Ø¬Ø§Ø¹ 50% Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…Ù†ÙÙ‚Ø©
    resources.gold += Math.floor(lastUpgradeGoldCost * 0.5);
    resources.wood += Math.floor(lastUpgradeWoodCost * 0.5);
    resources.food += Math.floor(lastUpgradeFoodCost * 0.5);

    if (upgradeInterval) {
      clearInterval(upgradeInterval);
      upgradeInterval = null;
    }

    upgradeInProgress = false;

    const progressWrapper = document.getElementById("castle-upgrade-progress-wrapper");
    const progressFill = document.getElementById("castle-upgrade-progress-fill");
    const remainingTimeEl = document.getElementById("castle-upgrade-remaining-time");

    if (progressWrapper) progressWrapper.style.display = "none";
    if (progressFill) progressFill.style.width = "0%";
    if (remainingTimeEl) remainingTimeEl.textContent = formatDuration(0);

    updateCastleInfoTab();
    updateCastleUpgradeTab();
    saveGameState();
  };
}

function finishCastlePanelUpgrade() {
  upgradeInProgress = false;
  currentUpgradeType = null;

  // Ø²ÙŠØ§Ø¯Ø© Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ù„Ø¹Ø©
  if (castleLevel < castleMaxLevel) {
    castleLevel += 1;
  }

  // ÙÙƒ Ø¹Ø§Ù…Ù„ Ø¨Ù†Ø§Ø¡ ÙˆØ§Ø­Ø¯
  busyBuilders--;
  if (busyBuilders < 0) busyBuilders = 0;

  // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª
  recalculatePower();
  updateCastleInfoTab();
  updateCastleUpgradeTab();

  // Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø´Ø±ÙŠØ· Ø§Ù„ØªÙ‚Ø¯Ù…
  const progressWrapper = document.getElementById("castle-upgrade-progress-wrapper");
  const progressFill = document.getElementById("castle-upgrade-progress-fill");
  const remainingTimeEl = document.getElementById("castle-upgrade-remaining-time");

  if (progressWrapper) progressWrapper.style.display = "none";
  if (progressFill) progressFill.style.width = "0%";
  if (remainingTimeEl) remainingTimeEl.textContent = formatDuration(0);

  // Ø­ÙØ¸ Ø§Ù„Ø­Ø§Ù„Ø© Ø¨Ø¹Ø¯ Ø§Ù„ØªØ±Ù‚ÙŠØ©
  saveGameState();
}


/* --- Start App --- */
window.addEventListener("load", () => {
  const selectedHero = localStorage.getItem("hero");
  let width = 0;
  const interval = setInterval(() => {
    width++;
    loadingFill1.style.width = width + "%";
    loadingFill1.textContent = width + "%";
    if (width >= 100) {
      clearInterval(interval);
      document.getElementById("loading1").style.display = "none";

      // ØªØ­Ù…ÙŠÙ„ Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© (Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ + Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ù„Ø¹Ø©)
      loadGameState();
if (typeof updateArmyProfileView === "function") {
  updateArmyProfileView();
}
if (typeof updateProfileStatsFromArmy === "function") {
  updateProfileStatsFromArmy();
}

loadBuildingsState();
recalcBuildingsUnlockByCastleLevel();
loadClanState();


      // Ø¨Ø¹Ø¯ Ù…Ø§ ÙƒÙ„ Ø­Ø§Ø¬Ø© Ø§ØªØ­Ù…Ù„Øª Ùˆ Ø§Ù„Ù€ DOM Ø¬Ø§Ù‡Ø²
      wireClanButtons();

      if (!selectedHero) {
        characterScreen.style.display = "block";
      } else {
        currentHero = selectedHero;
        enterCity();
      }
    }
  }, 30);
});

// ===== Clan basic state (Ù…Ø­Ù„ÙŠ) =====
const CLAN_STATE_KEY = "raidex_clan_state_v1";

let clanState = {
  name: null,
  role: null,     // "leader" | "member"
  members: [],    // [{name, role}]
};

function loadClanState() {
  try {
    const raw = localStorage.getItem(CLAN_STATE_KEY);
    if (!raw) return;
    const state = JSON.parse(raw);
    clanState = {
      ...clanState,
      ...state,
    };
  } catch (e) {
    console.error("Error loading clan state", e);
  }
}

function saveClanState() {
  try {
    localStorage.setItem(CLAN_STATE_KEY, JSON.stringify(clanState));
  } catch (e) {
    console.error("Error saving clan state", e);
  }
}

// ÙƒÙ„Ø§Ù†Ø§Øª Ù…Ù‚ØªØ±Ø­Ø© ÙˆÙ‡Ù…ÙŠØ©
const SUGGESTED_CLANS = [
  { name: "Raidex Warriors", members: 12, minCastleLevel: 3 },
  { name: "Desert Kings", members: 8, minCastleLevel: 1 },
  { name: "Shadow Legion", members: 20, minCastleLevel: 5 },
  { name: "Night Raiders", members: 15, minCastleLevel: 2 },
  { name: "Dragon Hearts", members: 30, minCastleLevel: 4 },
];
function wireClanButtons() {
  const createBtn = document.getElementById("clan-create-btn");
  const joinBtn = document.getElementById("clan-join-btn");
  const createTopBtn = document.getElementById("clan-create-top-btn");

  // Ù†Ø³ØªØ®Ø¯Ù… Ø²Ø± Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù„ÙŠ ÙÙˆÙ‚ Ù„Ùˆ Ù…ÙˆØ¬ÙˆØ¯ØŒ Ù„Ùˆ Ù…Ø´ Ù…ÙˆØ¬ÙˆØ¯ Ù†Ø±Ø¬Ø¹ Ù„Ù„Ù‚Ø¯ÙŠÙ…
  const anyCreateBtn = createTopBtn || createBtn;

  if (anyCreateBtn) {
    anyCreateBtn.onclick = createClan;
  }

  if (joinBtn) {
    joinBtn.onclick = () => {
      if (SUGGESTED_CLANS.length > 0) {
        joinClan(SUGGESTED_CLANS[0].name);
      }
    };
  }
}

function renderClanPage() {
  const listBox = document.getElementById("clan-list");
  const headerSub = document.getElementById("clan-header-sub");
  const guestView = document.getElementById("clan-guest-view");
  const memberView = document.getElementById("clan-member-view");

  const memberNameEl = document.getElementById("clan-member-name");
  const memberRoleEl = document.getElementById("clan-member-role");
  const memberCountEl = document.getElementById("clan-member-count");
  const leaveBtn = document.getElementById("clan-leave-btn");
  const overviewExtra = document.getElementById("clan-overview-extra");

  if (!listBox || !headerSub || !guestView || !memberView) return;

  // Ù„Ùˆ Ù…ÙÙŠØ´ ÙƒÙ„Ø§Ù†: Ù†Ø¹Ø±Ø¶ ÙˆØ§Ø¬Ù‡Ø© Guest
  if (!clanState.name) {
    guestView.style.display = "block";
    memberView.style.display = "none";
    headerSub.textContent = "Join or create a clan to play with others";
  } else {
    guestView.style.display = "none";
    memberView.style.display = "block";
    headerSub.textContent = `Clan: ${clanState.name}`;

    if (memberNameEl) {
      memberNameEl.textContent = clanState.name;
    }

    if (memberRoleEl) {
      const roleLabel =
        clanState.role === "leader" ? "Leader" : "Member";
      memberRoleEl.textContent = `Your role: ${roleLabel}`;
    }

    if (memberCountEl) {
      memberCountEl.textContent = `Members: ${clanState.members.length}`;
    }

    if (leaveBtn) {
      leaveBtn.onclick = leaveClan;
    }

    if (overviewExtra) {
      overviewExtra.innerHTML = "";

      const row1 = document.createElement("div");
      row1.textContent = "Clan level: 1 (placeholder)";

      const row2 = document.createElement("div");
      row2.textContent = "Total power: 0 (placeholder)";

      const row3 = document.createElement("div");
      row3.textContent =
        clanState.role === "leader"
          ? "You can manage this clan in Settings tab."
          : "Only the leader can change clan settings.";

      overviewExtra.appendChild(row1);
      overviewExtra.appendChild(row2);
      overviewExtra.appendChild(row3);
    }

    // Ø¯Ø§ÙŠÙ…Ù‹Ø§ Ù„Ù…Ø§ Ù†ÙØªØ­ member view Ù†Ø®Ù„ÙŠ ØªØ¨ÙˆÙŠØ¨ overview Ù‡Ùˆ Ø§Ù„Ù„ÙŠ Ø¸Ø§Ù‡Ø±
    switchClanTab("overview");
  }

  // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ÙƒÙ„Ø§Ù†Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© (Ù„Ù„Ù€ Guest)
  listBox.innerHTML = "";
  SUGGESTED_CLANS.forEach((c) => {
    const row = document.createElement("div");
    row.style.padding = "6px 8px";
    row.style.marginBottom = "4px";
    row.style.borderRadius = "10px";
    row.style.background = "rgba(15,23,42,0.9)";
    row.style.border = "1px solid rgba(148,163,184,0.4)";
    row.style.display = "flex";
    row.style.justifyContent = "space-between";
    row.style.alignItems = "center";
    row.style.fontSize = "13px";

    row.innerHTML = `
      <div>
        <div style="font-weight:bold;">${c.name}</div>
        <div style="font-size:11px; color:#9ca3af;">
          ${c.members} members â€¢ Min Castle Lv. ${c.minCastleLevel}
        </div>
      </div>
      <button style="padding:4px 10px; border:none; border-radius:999px; background:#0ea5e9; color:#0b1120; font-size:11px; cursor:pointer;">
        Join
      </button>
    `;

    const joinBtn = row.querySelector("button");
    joinBtn.onclick = () => {
      joinClan(c.name);
    };

    listBox.appendChild(row);
  });

  // Ø±Ø¨Ø· Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
  const tabButtons = document.querySelectorAll(".clan-tab-btn");
  tabButtons.forEach((btn) => {
    btn.onclick = () => {
      const key = btn.dataset.tab;
      if (!key) return;
      switchClanTab(key);
    };
  });
}

function createClan() {
  const name = prompt("Enter clan name:");
  if (!name) return;

  const playerName = localStorage.getItem("playerName") || "Player";

  clanState.name = name;
  clanState.role = "leader";
  clanState.members = [{ name: playerName, role: "leader" }];

  saveClanState();
  renderClanPage();
}

function joinClan(name) {
  const playerName = localStorage.getItem("playerName") || "Player";

  clanState.name = name;
  clanState.role = "member";
  clanState.members = [{ name: playerName, role: "member" }];

  saveClanState();
  renderClanPage();
}

function leaveClan() {
  if (!clanState.name) return;

  const confirmLeave = confirm(
    `Are you sure you want to leave clan "${clanState.name}"?`
  );
  if (!confirmLeave) return;

  clanState.name = null;
  clanState.role = null;
  clanState.members = [];

  saveClanState();
  renderClanPage();
}

function switchClanTab(key) {
  const panels = document.querySelectorAll(".clan-tab-panel");
  const buttons = document.querySelectorAll(".clan-tab-btn");

  panels.forEach((p) => {
    p.style.display = p.id === `clan-tab-${key}` ? "block" : "none";
  });

  buttons.forEach((b) => {
    if (b.dataset.tab === key) {
      b.style.color = "#facc15";
    } else {
      b.style.color = "#9ca3af";
    }
  });
}

/* ============================
   Unified Page Manager + Resource Shop Styling
   ============================ */

// 1) Helper: Ù…Ø¯ÙŠØ± ØµÙØ­Ø§Øª Ø¨ÙŠÙ† Ø§Ù„Ù€ top-bar ÙˆØ§Ù„Ù€ bottom-bar
const GAME_PAGE_IDS = ["tasks-page", "invites-page", "resource-shop-panel", "clan-page"];

function hideAllGamePages() {
  GAME_PAGE_IDS.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.classList.add("game-page-hidden");
    }
  });
}

function showGamePage(id) {
  hideAllGamePages();
  const el = document.getElementById(id);
  if (el) {
    el.classList.remove("game-page-hidden");
  }
}

// === Tasks Page ===
function openTasksPage() {
  const tasksPage = document.getElementById("tasks-page");
  if (!tasksPage) return;

  currentTasksTab = "main";        // Ù†Ø¶Ù…Ù† ÙŠÙØªØ­ Ø¹Ù„Ù‰ Main
  showGamePage("tasks-page");
  switchTasksTab("main");          // Ø¯ÙŠ Ù‡ØªÙ†Ø¯Ù‡ Ø¬ÙˆØ§Ù‡Ø§ renderTasksPage
}


function closeTasksPage() {
  const tasksPage = document.getElementById("tasks-page");
  if (!tasksPage) return;
  tasksPage.classList.add("game-page-hidden");
}
function openDailyLoginPage() {
  showGamePage("daily-login-page");
  renderDailyLoginCalendar();
}

function closeDailyLoginPage() {
  const page = document.getElementById("daily-login-page");
  if (page) page.classList.add("game-page-hidden");
}
function renderDailyLoginCalendar() {
  const container = document.getElementById("daily-login-calendar");
  const streakEl = document.getElementById("daily-login-streak");
  
  if (!container) return;

  container.innerHTML = "";

  const todayStr = new Date().toDateString();
  const canClaimToday = dailyLoginState.lastLoginDate !== todayStr;

  // Ø¹Ø±Ø¶ Ø§Ù„Ù€streak
  if (streakEl) {
    streakEl.textContent = `Streak: ${dailyLoginState.claimedDays.length} days`;
  }

  DAILY_LOGIN_REWARDS.forEach((reward) => {
    const dayNum = reward.day;
    const isClaimed = dailyLoginState.claimedDays.includes(dayNum);
    const isToday = dayNum === dailyLoginState.currentDay + 1;

    const dayBox = document.createElement("div");
    dayBox.style.background = isClaimed ? "rgba(34, 197, 94, 0.2)" : "rgba(15, 23, 42, 0.9)";
    dayBox.style.border = isToday && canClaimToday ? "2px solid #facc15" : "1px solid #334155";
    dayBox.style.borderRadius = "12px";
    dayBox.style.padding = "10px 6px";
    dayBox.style.textAlign = "center";
    dayBox.style.position = "relative";
    dayBox.style.cursor = (isToday && canClaimToday && !isClaimed) ? "pointer" : "default";
    dayBox.style.transition = "transform 0.2s";

    if (isToday && canClaimToday && !isClaimed) {
      dayBox.style.boxShadow = "0 0 12px rgba(250, 204, 21, 0.6)";
      dayBox.onmouseenter = () => (dayBox.style.transform = "scale(1.05)");
      dayBox.onmouseleave = () => (dayBox.style.transform = "scale(1)");
    }

    const dayLabel = document.createElement("div");
    dayLabel.style.fontSize = "12px";
    dayLabel.style.fontWeight = "bold";
    dayLabel.style.marginBottom = "4px";
    dayLabel.style.color = isClaimed ? "#22c55e" : "#e5e7eb";
    dayLabel.textContent = `Day ${dayNum}`;

    const rewardText = document.createElement("div");
    rewardText.style.fontSize = "10px";
    rewardText.style.color = "#9ca3af";
    const parts = [];
    if (reward.gold) parts.push(`${reward.gold.toLocaleString()} ğŸŸ¡`);
    if (reward.wood) parts.push(`${reward.wood.toLocaleString()} ğŸªµ`);
    if (reward.food) parts.push(`${reward.food.toLocaleString()} ğŸ–`);
    if (reward.gem) parts.push(`${reward.gem} ğŸ’`);
    rewardText.innerHTML = parts.join("<br>");

    if (isClaimed) {
      const check = document.createElement("div");
      check.textContent = "âœ…";
      check.style.position = "absolute";
      check.style.top = "4px";
      check.style.right = "4px";
      check.style.fontSize = "16px";
      dayBox.appendChild(check);
    }

    dayBox.appendChild(dayLabel);
    dayBox.appendChild(rewardText);

    if (isToday && canClaimToday && !isClaimed) {
      dayBox.onclick = () => claimDailyLogin(dayNum);
    }

    container.appendChild(dayBox);
  });
}
function claimDailyLogin(dayNum) {
  const todayStr = new Date().toDateString();
  
  if (dailyLoginState.claimedDays.includes(dayNum)) return;
  if (dayNum !== dailyLoginState.currentDay + 1) return;
  if (dailyLoginState.lastLoginDate === todayStr) return;

  const reward = DAILY_LOGIN_REWARDS.find(r => r.day === dayNum);
  if (!reward) return;

  if (reward.gold) resources.gold += reward.gold;
  if (reward.wood) resources.wood += reward.wood;
  if (reward.food) resources.food += reward.food;
  if (reward.gem) resources.gem += reward.gem;

  dailyLoginState.lastLoginDate = todayStr;
  dailyLoginState.claimedDays.push(dayNum);
  dailyLoginState.currentDay = dayNum;

saveDailyLoginState();
updateDailyLoginBanner();
updateDailyLoginIcon();
updateRes();
renderDailyLoginCalendar();

  // ÙØªØ­ Popup
  openDailyLoginClaimPopup(dayNum, reward);
}

function openDailyLoginClaimPopup(dayNum, reward) {
  const popup = document.getElementById("daily-login-claim-popup");
  const dayEl = document.getElementById("daily-login-claim-day");
  const rewardsEl = document.getElementById("daily-login-claim-rewards");

  if (!popup || !dayEl || !rewardsEl) return;

  dayEl.textContent = `Day ${dayNum}`;

  rewardsEl.innerHTML = "";
  const iconStyle = "width:24px; height:24px; border-radius:6px; background:#111827; display:flex; align-items:center; justify-content:center; font-size:14px;";

  if (reward.gold) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸŸ¡</div><div>${reward.gold.toLocaleString()} Gold</div>`;
    rewardsEl.appendChild(item);
  }
  if (reward.wood) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸªµ</div><div>${reward.wood.toLocaleString()} Wood</div>`;
    rewardsEl.appendChild(item);
  }
  if (reward.food) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸ–</div><div>${reward.food.toLocaleString()} Food</div>`;
    rewardsEl.appendChild(item);
  }
  if (reward.gem) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸ’</div><div>${reward.gem} Gems</div>`;
    rewardsEl.appendChild(item);
  }

  popup.classList.remove("hidden");
}

function closeDailyLoginClaimPopup() {
  const popup = document.getElementById("daily-login-claim-popup");
  if (popup) popup.classList.add("hidden");
}


function switchTasksTab(tab) {
  currentTasksTab = tab;

  const btns = document.querySelectorAll(".tasks-tab-btn");
  btns.forEach(btn => {
    const t = btn.getAttribute("data-tab");
    if (t === tab) btn.classList.add("tasks-tab-active");
    else btn.classList.remove("tasks-tab-active");
  });

  renderTasksPage();
}
function renderTasksPage() {
  const container = document.getElementById("tasks-page-content");
  if (!container) return;

  let tasksList;
  let tasksState;

  if (currentTasksTab === "main") {
    tasksList = MAIN_TASKS;
    tasksState = mainTasksState;
  } else if (currentTasksTab === "daily") {
    tasksList = DAILY_TASKS;
    tasksState = dailyTasksState;
  } else if (currentTasksTab === "weekly") {
    tasksList = WEEKLY_TASKS;
    tasksState = weeklyTasksState;
  } else {
    tasksList = SOCIAL_TASKS;
    tasksState = socialTasksState;
  }

  container.innerHTML = "";

  // --- Daily Track bar + chests ---
  if (currentTasksTab === "daily") {
    const trackWrapper = document.createElement("div");
    trackWrapper.style.marginBottom = "10px";

    const title = document.createElement("div");
    title.textContent = "Daily Reward Track";
    title.style.fontSize = "12px";
    title.style.marginBottom = "4px";
    title.style.opacity = "0.8";
    trackWrapper.appendChild(title);

    const barOuter = document.createElement("div");
    barOuter.style.position = "relative";
    barOuter.style.height = "18px";
    barOuter.style.borderRadius = "999px";
    barOuter.style.background = "rgba(15, 23, 42, 0.9)";
    barOuter.style.overflow = "hidden";
    barOuter.style.boxShadow = "0 0 10px rgba(56, 189, 248, 0.6)";

    const barFill = document.createElement("div");
    barFill.style.height = "100%";
    const percent = Math.max(0, Math.min(100, dailyPoints)); // dailyPoints/1 Ù„Ø£Ù† Ø§Ù„Ù…Ø§ÙƒØ³ 100
    barFill.style.width = percent + "%";
    barFill.style.background = "linear-gradient(90deg, #0ea5e9, #22c55e)";
    barFill.style.transition = "width 0.3s ease-out";
    barOuter.appendChild(barFill);

    const barText = document.createElement("div");
    barText.textContent = `${dailyPoints} / 100 pts`;
    barText.style.position = "absolute";
    barText.style.left = "50%";
    barText.style.top = "50%";
    barText.style.transform = "translate(-50%, -50%)";
    barText.style.fontSize = "11px";
    barText.style.fontWeight = "bold";
    barOuter.appendChild(barText);

    trackWrapper.appendChild(barOuter);

    // Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚ ÙÙˆÙ‚ Ø§Ù„Ø¨Ø§Ø±
    const chestsRow = document.createElement("div");
    chestsRow.style.display = "flex";
    chestsRow.style.justifyContent = "space-between";
    chestsRow.style.marginTop = "6px";

    DAILY_CHESTS.forEach((chest, index) => {
      const chestWrapper = document.createElement("div");
      chestWrapper.style.position = "relative";
      chestWrapper.style.flex = "1";
      chestWrapper.style.textAlign = "center";

      const chestIcon = document.createElement("div");
      chestIcon.textContent = "ğŸ“¦";
      chestIcon.style.fontSize = "20px";
      chestIcon.style.cursor = "pointer";

      const unlocked = dailyPoints >= chest.requiredPoints;
      const claimed = chest.claimed;

      if (claimed) {
        chestIcon.style.opacity = "0.6";
      } else if (unlocked) {
        chestIcon.style.textShadow = "0 0 8px rgba(250, 204, 21, 0.9)";
      } else {
        chestIcon.style.opacity = "0.7";
      }

      chestIcon.onclick = function () {
        openDailyChestPopup(index);
      };

      // Ù†Ù‚Ø·Ø© Ø¥Ø´Ø¹Ø§Ø± Ù„Ùˆ Ù…ØªØ§Ø­ ÙˆÙ…Ø´ Ù…ØªØ³ØªÙ„Ù…
      if (unlocked && !claimed) {
        const dot = document.createElement("div");
        dot.style.position = "absolute";
        dot.style.top = "0px";
        dot.style.right = "20px";
        dot.style.width = "8px";
        dot.style.height = "8px";
        dot.style.borderRadius = "50%";
        dot.style.background = "#ef4444";
        dot.style.boxShadow = "0 0 6px rgba(248, 113, 113, 0.9)";
        chestWrapper.appendChild(dot);
      }

      const label = document.createElement("div");
      label.textContent = chest.requiredPoints + " pts";
      label.style.fontSize = "10px";
      label.style.marginTop = "2px";
      label.style.opacity = "0.8";

      chestWrapper.appendChild(chestIcon);
      chestWrapper.appendChild(label);
      chestsRow.appendChild(chestWrapper);
    });

    trackWrapper.appendChild(chestsRow);

    // Ø®Ø· ÙØ§ØµÙ„
    const separator = document.createElement("div");
    separator.style.height = "1px";
    separator.style.background = "rgba(148, 163, 184, 0.5)";
    separator.style.marginTop = "8px";
    trackWrapper.appendChild(separator);

    container.appendChild(trackWrapper);
  }
  // --- Weekly Track bar + chests ---
  if (currentTasksTab === "weekly") {
    const trackWrapper = document.createElement("div");
    trackWrapper.style.marginBottom = "10px";

    const title = document.createElement("div");
    title.textContent = "Weekly Reward Track";
    title.style.fontSize = "12px";
    title.style.marginBottom = "4px";
    title.style.opacity = "0.8";
    trackWrapper.appendChild(title);

    const barOuter = document.createElement("div");
    barOuter.style.position = "relative";
    barOuter.style.height = "18px";
    barOuter.style.borderRadius = "999px";
    barOuter.style.background = "rgba(15, 23, 42, 0.9)";
    barOuter.style.overflow = "hidden";
    barOuter.style.boxShadow = "0 0 10px rgba(56, 189, 248, 0.6)";

    const barFill = document.createElement("div");
    barFill.style.height = "100%";
    const weeklyPercent = Math.max(0, Math.min(100, (weeklyPoints / 1000) * 100));
    barFill.style.width = weeklyPercent + "%";
    barFill.style.background = "linear-gradient(90deg, #0ea5e9, #a855f7)";
    barFill.style.transition = "width 0.3s ease-out";
    barOuter.appendChild(barFill);

    const barText = document.createElement("div");
    barText.textContent = `${weeklyPoints} / 1000 pts`;
    barText.style.position = "absolute";
    barText.style.left = "50%";
    barText.style.top = "50%";
    barText.style.transform = "translate(-50%, -50%)";
    barText.style.fontSize = "11px";
    barText.style.fontWeight = "bold";
    barOuter.appendChild(barText);

    trackWrapper.appendChild(barOuter);

    const chestsRow = document.createElement("div");
    chestsRow.style.display = "flex";
    chestsRow.style.justifyContent = "space-between";
    chestsRow.style.marginTop = "6px";

    WEEKLY_CHESTS.forEach((chest, index) => {
      const chestWrapper = document.createElement("div");
      chestWrapper.style.position = "relative";
      chestWrapper.style.flex = "1";
      chestWrapper.style.textAlign = "center";

      const chestIcon = document.createElement("div");
      chestIcon.textContent = "ğŸ—ƒï¸";
      chestIcon.style.fontSize = "20px";
      chestIcon.style.cursor = "pointer";

      const unlocked = weeklyPoints >= chest.requiredPoints;
      const claimed = chest.claimed;

      if (claimed) {
        chestIcon.style.opacity = "0.6";
      } else if (unlocked) {
        chestIcon.style.textShadow = "0 0 8px rgba(250, 204, 21, 0.9)";
      } else {
        chestIcon.style.opacity = "0.7";
      }

      chestIcon.onclick = function () {
        openWeeklyChestPopup(index);
      };

      if (unlocked && !claimed) {
        const dot = document.createElement("div");
        dot.style.position = "absolute";
        dot.style.top = "0px";
        dot.style.right = "20px";
        dot.style.width = "8px";
        dot.style.height = "8px";
        dot.style.borderRadius = "50%";
        dot.style.background = "#ef4444";
        dot.style.boxShadow = "0 0 6px rgba(248, 113, 113, 0.9)";
        chestWrapper.appendChild(dot);
      }

      const label = document.createElement("div");
      label.textContent = chest.requiredPoints + " pts";
      label.style.fontSize = "10px";
      label.style.marginTop = "2px";
      label.style.opacity = "0.8";

      chestWrapper.appendChild(chestIcon);
      chestWrapper.appendChild(label);
      chestsRow.appendChild(chestWrapper);
    });

    trackWrapper.appendChild(chestsRow);

    const separator = document.createElement("div");
    separator.style.height = "1px";
    separator.style.background = "rgba(148, 163, 184, 0.5)";
    separator.style.marginTop = "8px";
    trackWrapper.appendChild(separator);

    container.appendChild(trackWrapper);
  }

  // --- Ø¨Ø§Ù‚ÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù„ÙŠ Ø¨ÙŠØ±Ø³Ù… Ø§Ù„Ù…Ù‡Ø§Ù… (Ù†ÙØ³Ù‡ Ø²ÙŠ Ù…Ø§ ÙƒØ§Ù†) ---
  tasksList.forEach(task => {
    const state = tasksState[task.id] || { progress: 0, done: false, claimed: false };
    const progress = Math.min(state.progress, task.target);
    const isDone = progress >= task.target;
    const isClaimed = state.claimed;

    const div = document.createElement("div");
    div.className = "task-item" + (isDone ? " completed" : "");
    div.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div>
          <div style="font-weight:bold;">${task.title}</div>
          <div style="font-size:12px; opacity:0.8;">${task.desc}</div>
          <div style="font-size:12px; margin-top:4px;">
            Progress: ${progress} / ${task.target}
          </div>
          <div style="font-size:12px; margin-top:2px; color:#facc15;">
            Reward: Resources/Gems
          </div>
        </div>
        <button
          style="margin-left:8px; padding:6px 10px; border:none; border-radius:10px;
                 background:${isClaimed ? '#4b5563' : isDone ? '#22c55e' : '#6b7280'};
                 color:white; font-size:12px; cursor:${isDone && !isClaimed ? 'pointer' : 'default'};"
          onclick="claimTaskReward('${currentTasksTab}','${task.id}')"
          ${isDone && !isClaimed ? "" : "disabled"}
        >
          ${isClaimed ? "Claimed" : isDone ? "Claim" : "In progress"}
        </button>
      </div>
    `;
    container.appendChild(div);
  });
}


function formatTaskReward(reward) {
  const parts = [];
  if (reward.gem) parts.push(`${reward.gem} Gems`);
  if (reward.gold) parts.push(`${formatShortNumber(reward.gold)} Gold`);
  if (reward.wood) parts.push(`${formatShortNumber(reward.wood)} Wood`);
  if (reward.food) parts.push(`${formatShortNumber(reward.food)} Food`);
  return parts.join(" + ");
}

function claimTaskReward(tab, taskId) {
  let tasksState;
  if (tab === "main") tasksState = mainTasksState;
  else if (tab === "daily") tasksState = dailyTasksState;
  else if (tab === "weekly") tasksState = weeklyTasksState;
  else tasksState = socialTasksState;

  if (!tasksState) return;
  const state = tasksState[taskId];
  if (!state || !state.done || state.claimed) return;

  const list = tab === "main" ? MAIN_TASKS :
               tab === "daily" ? DAILY_TASKS :
               tab === "weekly" ? WEEKLY_TASKS : SOCIAL_TASKS;
  const task = list.find(t => t.id === taskId);
  if (!task) return;

  if (task.reward.gem) resources.gem += task.reward.gem;
  if (task.reward.gold) resources.gold += task.reward.gold;
  if (task.reward.wood) resources.wood += task.reward.wood;
  if (task.reward.food) resources.food += task.reward.food;

  // Ø¥Ø¶Ø§ÙØ© Ù†Ù‚Ø§Ø· Ø§Ù„Ù€Daily Track
  if (tab === "daily" && typeof task.points === "number") {
    dailyPoints += task.points;
    if (dailyPoints > 100) dailyPoints = 100;
  }

state.claimed = true;
saveTasksState();
recalcTasksNotification();
updateRes();
renderTasksPage();
}


// === Invites Page ===
function openInvites() {
  const invitesPage = document.getElementById("invites-page");
  if (!invitesPage) return;
  showGamePage("invites-page");
}

function closeInvites() {
  const invitesPage = document.getElementById("invites-page");
  if (!invitesPage) return;
  invitesPage.classList.add("game-page-hidden");
}
// === Clan Page ===
function openClanPage() {
  showGamePage("clan-page");
  renderClanPage();
}

function closeClanPage() {
  const clanPage = document.getElementById("clan-page");
  if (!clanPage) return;
  clanPage.classList.add("game-page-hidden");
}


// 2) ØªØ­Ø³ÙŠÙ† Ù…ØªØ¬Ø± Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ + ØªÙˆØ­ÙŠØ¯ Ù…ÙƒØ§Ù†Ù‡ Ø¨ÙŠÙ† Ø§Ù„Ø¨Ø§Ø±ÙŠÙ†

// Ù†Ø¶Ù…Ù† Ø£Ù† Ø§Ù„Ù€ panel Ù„Ù‡ Ø§Ù„Ù€ class Ø§Ù„ØµØ­ÙŠØ­
(function initResourceShopLayoutOnce() {
  const panel = document.getElementById("resource-shop-panel");
  if (!panel) return;
  panel.classList.add("game-page-panel", "game-page-hidden");
})();

let currentShopResource = "gold"; // gold | wood | food

function openResourceShop(resourceType) {
    console.log("openResourceShop called with:", resourceType);
  currentShopResource = resourceType || currentShopResource || "gold";

  const panel   = document.getElementById("resource-shop-panel");
  const titleEl = document.getElementById("resource-shop-title");
  const subEl   = document.getElementById("resource-shop-sub");
  const content = document.getElementById("resource-shop-content");

  if (!panel || !titleEl || !subEl || !content) return;

  const nameAr =
    currentShopResource === "gold" ? "Ø§Ù„Ø°Ù‡Ø¨" :
    currentShopResource === "wood" ? "Ø§Ù„Ø®Ø´Ø¨" :
    "Ø§Ù„Ù„Ø­Ù…";

  titleEl.textContent = `Ø´Ø±Ø§Ø¡ ${nameAr}`;
  subEl.textContent   = `Ø§Ø®ØªØ± Ø¨Ø§Ù‚Ø© ${nameAr} ØªØ±ÙŠØ¯ Ø´Ø±Ø§Ø¡Ù‡Ø§ Ø¨Ø§Ù„Ø¬ÙˆØ§Ù‡Ø±`;

  content.innerHTML = "";

  RESOURCE_PACKS.forEach(pack => {
    const btn = document.createElement("button");
    btn.className = "resource-pack-btn";

    if (currentShopResource === "gold") {
      btn.classList.add("resource-pack-gold");
    } else if (currentShopResource === "wood") {
      btn.classList.add("resource-pack-wood");
    } else {
      btn.classList.add("resource-pack-food");
    }

    btn.innerHTML = `
      <div>
        <div>${pack.amount.toLocaleString()}</div>
        <span class="amount">ÙˆØ­Ø¯Ø© Ù…Ù† ${nameAr}</span>
      </div>
      <span class="price">${pack.costGem.toLocaleString()} ğŸ’</span>
    `;
    btn.onclick = () => {
      buyResourcePack(currentShopResource, pack.amount, pack.costGem);
    };
    content.appendChild(btn);
  });

  showGamePage("resource-shop-panel");
}

function closeResourceShop() {
  const panel = document.getElementById("resource-shop-panel");
  if (!panel) return;
  panel.classList.add("game-page-hidden");
}

// 3) Ù†Ø±Ø¨Ø· bottom bar Ø²Ø± Ø§Ù„Ù…Ù‡Ø§Ù… Ù„Ùˆ Ù…Ø´ Ù…Ø±Ø¨ÙˆØ·
(function wireBottomBarButtons() {
  const bottomBar = document.getElementById("bottom-bar");
  if (!bottomBar) return;

  const items = bottomBar.querySelectorAll(".bar-item");
  items.forEach(item => {
    const text = (item.textContent || "").trim().toLowerCase();
    if (text === "task" || text === "tasks") {
      item.onclick = openTasksPage;
    }
  });
})();
document.addEventListener("DOMContentLoaded", function () {
  // ===== Building Panel (open/close + Ø²Ø± Ø§Ù„ØªØ±Ù‚ÙŠØ©) =====
  function openBuildingUpgradePanel() {
    const panel = document.getElementById("building-panel");
    if (panel) panel.classList.remove("hidden");
  }

  function closeBuildingUpgradePanel() {
    const panel = document.getElementById("building-panel");
    if (panel) panel.classList.add("hidden");
  }

  const closeBtn = document.getElementById("building-panel-close-btn");
  if (closeBtn) {
    closeBtn.addEventListener("click", closeBuildingUpgradePanel);
  }

  const castleStartUpgradeBtn = document.getElementById("castle-start-upgrade-btn");
  if (castleStartUpgradeBtn) {
    castleStartUpgradeBtn.addEventListener("click", function () {
      startCastlePanelUpgrade();
    });
  }

  const castleCancelUpgradeBtn = document.getElementById("castle-cancel-upgrade-btn");
  if (castleCancelUpgradeBtn) {
    castleCancelUpgradeBtn.addEventListener("click", function () {
      cancelCastlePanelUpgrade();
    });
  }

const buildingPanelUpgradeBtn = document.getElementById("building-panel-upgrade-btn");
if (buildingPanelUpgradeBtn) {
  buildingPanelUpgradeBtn.addEventListener("click", function () {
    console.log("CLICK building-panel-upgrade-btn");

    if (!currentBuildingKey) {
      console.log("No currentBuildingKey, cannot upgrade");
      return;
    }

    console.log("CALL startGenericBuildingUpgrade with", currentBuildingKey);
    startGenericBuildingUpgrade(currentBuildingKey);

    // Ø¨Ø¹Ø¯ Ù…Ø§ Ù†Ø¨Ø¯Ø£ Ø§Ù„ØªØ±Ù‚ÙŠØ©ØŒ ÙØ¹Ù‘Ù„ Ø²Ø± Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ© ÙÙˆØ±Ù‹Ø§
    const cancelBtn = document.getElementById("building-panel-cancel-upgrade-btn");
    if (cancelBtn) {
      const up = buildingUpgrades[currentBuildingKey];
      if (up && up.inProgress) {
        cancelBtn.style.display = "block";
        cancelBtn.onclick = function () {
          cancelBuildingUpgrade(currentBuildingKey);
          cancelBtn.style.display = "none";
          updateBuildingUpgradePanelForTimer(currentBuildingKey);
        };
      }
    }

    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„ØªØ§ÙŠÙ…Ø± ÙÙŠ Ø§Ù„Ø¨Ø§Ù†Ù„ Ø¨Ø¹Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ±Ù‚ÙŠØ©
    updateBuildingUpgradePanelForTimer(currentBuildingKey);
  });
}
}); // Ù‡Ù†Ø§ Ø¨ØªÙ†ØªÙ‡ÙŠ ÙƒÙ„ Ø±Ø¨Ø·Ø§Øª Ø§Ù„Ù€ DOMContentLoaded

// ===== Global chat fetch (Ø¹Ø±Ø¶ Ø§Ù„Ø±Ø³Ø§Ø¦Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±) =====
let lastChatFetchTime = 0;

async function loadGlobalChatMessages() {
  const area = document.getElementById("chat-global");
  if (!area) return;

  try {
    const res = await fetch("https://raidex-backend-production.up.railway.app/chat/latest?chatType=global&limit=50");
    const data = await res.json();
    if (!data || !Array.isArray(data.messages)) return;

    area.innerHTML = "";

    data.messages.forEach((msg) => {
      const div = document.createElement("div");
      div.className = "chat-message";
      div.textContent = msg.name + ": " + msg.text;
      area.appendChild(div);
    });

    area.scrollTop = area.scrollHeight;
  } catch (e) {
    console.error("Error loading global chat messages", e);
  }
}
// ===== Chat logic Ù…Ø¹ ØªØ¨ÙˆÙŠØ¨Ø§Øª + Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø³ÙŠØ±ÙØ± =====
let currentChatTab = "global";

function openChat() {
  const panel = document.getElementById("chat-panel");
  if (!panel) return;
  panel.classList.remove("chat-hidden");
  panel.classList.add("chat-visible");
}

function closeChat() {
  const panel = document.getElementById("chat-panel");
  if (!panel) return;
  panel.classList.remove("chat-visible");
  panel.classList.add("chat-hidden");
}

function switchChatTab(tabKey) {
  currentChatTab = tabKey;

  const chatTabs = document.querySelectorAll(".chat-tab");
  const chatAreas = {
    global: document.getElementById("chat-global"),
    clan: document.getElementById("chat-clan"),
    friends: document.getElementById("chat-friends"),
    system: document.getElementById("chat-system"),
  };

  // ÙØ¹Ù‘Ù„ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø®ØªØ§Ø±
  chatTabs.forEach((btn) => {
    btn.classList.toggle("active", btn.dataset.chat === tabKey);
  });

  // Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…Ø³Ø§Ø­Ø§Øª
  Object.keys(chatAreas).forEach((key) => {
    const area = chatAreas[key];
    if (!area) return;
    if (key === tabKey) {
      area.classList.remove("chat-hidden");
    } else {
      area.classList.add("chat-hidden");
    }
  });
}

function addChatMessageToArea(tabKey, text, isMe = false) {
  const areaId =
    tabKey === "global" ? "chat-global" :
    tabKey === "clan" ? "chat-clan" :
    tabKey === "friends" ? "chat-friends" :
    "chat-system";

  const area = document.getElementById(areaId);
  if (!area) return;

  const div = document.createElement("div");
  div.className = "chat-message";
  if (isMe) div.style.color = "#facc15";
  div.textContent = text;
  area.appendChild(div);
  area.scrollTop = area.scrollHeight;
}

async function handleSendChat() {
  const input = document.getElementById("chat-input");
  if (!input) return;
  const text = input.value.trim();
  if (!text) return;

  // Ù†Ø¶ÙŠÙ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù…Ø­Ù„ÙŠÙ‹Ø§ ÙÙŠ Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø­Ø§Ù„ÙŠ
  addChatMessageToArea(currentChatTab, text, true);
  input.value = "";

  // Ù„Ùˆ Ø¬Ù„ÙˆØ¨Ø§Ù„ØŒ Ù†Ø¨Ø¹ØªÙ‡Ø§ Ù„Ù„Ø³ÙŠØ±ÙØ±
  if (currentChatTab === "global") {
    try {
      const res = await fetch("https://raidex-backend-production.up.railway.app/chat/send", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          name: localStorage.getItem("playerName") || "Player",
          text: text,
          chatType: "global",
        }),
      });

      const data = await res.json();
      console.log("Chat send result:", data);
    } catch (e) {
      console.error("Error sending chat message", e);
    }
  }
}

// Ø±Ø¨Ø· Ø§Ù„Ø£Ø²Ø±Ø§Ø± Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
window.addEventListener("load", () => {
  const chatIcon   = document.getElementById("chat-icon");
  const chatBackBtn = document.querySelector(".chat-back-btn");
  const chatTabs   = document.querySelectorAll(".chat-tab");
  const chatSendBtn = document.getElementById("chat-send-btn");
  const chatInput  = document.getElementById("chat-input");

  if (chatIcon) {
    chatIcon.addEventListener("click", openChat);
  }

  if (chatBackBtn) {
    chatBackBtn.addEventListener("click", closeChat);
  }

  if (chatTabs && chatTabs.length) {
    chatTabs.forEach((btn) => {
      btn.addEventListener("click", () => {
        const key = btn.dataset.chat;
        if (!key) return;
        switchChatTab(key);
      });
    });
  }

  if (chatSendBtn) {
    chatSendBtn.addEventListener("click", handleSendChat);
  }

  if (chatInput) {
    chatInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") handleSendChat();
    });
  }
  // Ø£ÙˆÙ„ ØªØ­Ù…ÙŠÙ„ Ù„Ù„Ø±Ø³Ø§Ø¦Ù„
  loadGlobalChatMessages();
  // ØªØ­Ø¯ÙŠØ« ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ
  setInterval(loadGlobalChatMessages, 10000);

  // Ø§Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ
  switchChatTab("global");
});
// ===== Ø¬Ù„Ø¨ Ø±Ø³Ø§Ø¦Ù„ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ± =====
async function loadGlobalChatMessages() {
  const area = document.getElementById("chat-global");
  if (!area) return;

  try {
    const res = await fetch(
      "https://raidex-backend-production.up.railway.app/chat/latest?chatType=global&limit=50"
    );
    const data = await res.json();
    if (!data || !Array.isArray(data.messages)) return;

    area.innerHTML = "";

    data.messages.forEach((msg) => {
      const div = document.createElement("div");
      div.className = "chat-message";
      div.textContent = msg.name + ": " + msg.text;
      area.appendChild(div);
    });

    area.scrollTop = area.scrollHeight;
  } catch (e) {
    console.error("Error loading global chat messages", e);
  }
}
// ===== DEV TOOLS (Ù„Ùƒ Ø£Ù†Øª ÙÙ‚Ø· Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„) =====

// ÙØ¹Ù‘Ù„/Ø£ØºÙ„Ù‚ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø·ÙˆØ± Ù…Ù† Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„:
// window.__DEV_GOD_MODE__ = true Ø£Ùˆ false
window.__DEV_GOD_MODE__ = false;

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¯Ø§Ø®Ù„ÙŠØ©
function devLog(msg) {
  console.log("%c[DEV]", "color:#facc15;font-weight:bold;", msg);
}

// Ø¶Ø¨Ø· Ù…ÙˆØ§Ø±Ø¯ + Ù…Ø³ØªÙˆÙ‰ Ù‚Ù„Ø¹Ø©
function devSetState(options) {
  if (!window.__DEV_GOD_MODE__) {
    devLog("God mode Ù…ØºÙ„Ù‚. Ù†ÙÙ‘Ø°: window.__DEV_GOD_MODE__ = true Ø£ÙˆÙ„Ø§.");
    return;
  }

  options = options || {};

  // Ù…ÙˆØ§Ø±Ø¯
  if (options.resources) {
    resources.gold = options.resources.gold ?? resources.gold;
    resources.wood = options.resources.wood ?? resources.wood;
    resources.food = options.resources.food ?? resources.food;
    resources.gem  = options.resources.gem  ?? resources.gem;
  }

  // Ù…Ø³ØªÙˆÙ‰ Ø§Ù„Ù‚Ù„Ø¹Ø©
  if (typeof options.castleLevel === "number") {
    castleLevel = options.castleLevel;
  }

  // Ù…Ø³ØªÙˆÙŠØ§Øª Ù…Ø¨Ø§Ù†ÙŠ (Ù„Ùˆ Ø­Ø§Ø¨Ø¨)
  if (options.buildingLevels) {
    for (const [key, lvl] of Object.entries(options.buildingLevels)) {
      buildingLevels[key] = lvl;
    }
  }

  saveGameState();
  recalcBuildingsUnlockByCastleLevel && recalcBuildingsUnlockByCastleLevel();
  recalculatePower && recalculatePower();
  if (typeof updateTopBar === "function") updateTopBar();

  devLog("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© (resources / castle / buildings).");
}

// Ø¯ÙˆØ§Ù„ Ø³Ø±ÙŠØ¹Ø© Ø¬Ø§Ù‡Ø²Ø©
function devMaxAll() {
  devSetState({
    castleLevel: 50,
    resources: {
      gold: 999999999,
      wood: 999999999,
      food: 999999999,
      gem:  999999
    },
    buildingLevels: {
      goldMine: 50,
      woodMine: 50,
      meatFarm: 50,
      school: 50,
      attackTower: 50,
      defenseTower: 50,
      heroesHall: 50,
      market: 50,
      booster: 50,
      hospital: 50
    }
  });
}

function devCastleTo(level) {
  devSetState({ castleLevel: level });
}

function devAddResources({ gold = 0, wood = 0, food = 0, gem = 0 } = {}) {
  if (!window.__DEV_GOD_MODE__) {
    devLog("God mode Ù…ØºÙ„Ù‚. Ù†ÙÙ‘Ø°: window.__DEV_GOD_MODE__ = true Ø£ÙˆÙ„Ø§.");
    return;
  }
  resources.gold += gold;
  resources.wood += wood;
  resources.food += food;
  resources.gem  += gem;
  saveGameState();
  if (typeof updateTopBar === "function") updateTopBar();
  devLog(`+${gold} gold, +${wood} wood, +${food} food, +${gem} gem`);
}
let currentDailyChestIndex = null;

function openDailyChestPopup(index) {
  const chest = DAILY_CHESTS[index];
  if (!chest) return;

  currentDailyChestIndex = index;

  const popup = document.getElementById("daily-chest-popup");
  const titleEl = document.getElementById("daily-chest-title");
  const statusEl = document.getElementById("daily-chest-status");
  const rewardsEl = document.getElementById("daily-chest-rewards");
  const claimBtn = document.getElementById("daily-chest-claim-btn");

  if (!popup || !titleEl || !statusEl || !rewardsEl || !claimBtn) return;

  const unlocked = dailyPoints >= chest.requiredPoints;
  const claimed = chest.claimed;

  titleEl.textContent = `Daily Chest ${index + 1}`;

  // Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø± ÙˆØ§Ù„Ù†Øµ
  if (!unlocked) {
    statusEl.textContent = `Reach ${chest.requiredPoints} points to unlock this chest.`;
    statusEl.style.color = "#f97316";
    claimBtn.disabled = true;
    claimBtn.style.opacity = "0.6";
    claimBtn.style.cursor = "default";
  } else if (claimed) {
    statusEl.textContent = "You already claimed this chest.";
    statusEl.style.color = "#9ca3af";
    claimBtn.disabled = true;
    claimBtn.style.opacity = "0.6";
    claimBtn.style.cursor = "default";
  } else {
    statusEl.textContent = "Chest is ready to claim!";
    statusEl.style.color = "#22c55e";
    claimBtn.disabled = false;
    claimBtn.style.opacity = "1";
    claimBtn.style.cursor = "pointer";
  }

  // Ø¹Ø±Ø¶ Ø§Ù„Ø¬ÙˆØ§Ø¦Ø² ÙƒØ£ÙŠÙ‚ÙˆÙ†Ø§Øª + Ø£Ø±Ù‚Ø§Ù…
  rewardsEl.innerHTML = "";
  const r = chest.rewards || {};
  const iconStyle = "width:24px; height:24px; border-radius:6px; background:#111827; display:flex; align-items:center; justify-content:center; font-size:14px;";

  if (r.gold) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸŸ¡</div><div>${r.gold.toLocaleString()} Gold</div>`;
    rewardsEl.appendChild(item);
  }
  if (r.wood) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸªµ</div><div>${r.wood.toLocaleString()} Wood</div>`;
    rewardsEl.appendChild(item);
  }
  if (r.food) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.AlignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸ–</div><div>${r.food.toLocaleString()} Food</div>`;
    rewardsEl.appendChild(item);
  }
  if (r.gem) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸ’</div><div>${r.gem.toLocaleString()} Gems</div>`;
    rewardsEl.appendChild(item);
  }

  popup.classList.remove("hidden");
}

function closeDailyChestPopup() {
  const popup = document.getElementById("daily-chest-popup");
  if (popup) popup.classList.add("hidden");
  currentDailyChestIndex = null;
}

function confirmDailyChestClaim() {
  if (currentDailyChestIndex === null) return;

  const chest = DAILY_CHESTS[currentDailyChestIndex];
  if (!chest) return;

  const unlocked = dailyPoints >= chest.requiredPoints;
  const claimed = chest.claimed;
  if (!unlocked || claimed) return;

  const r = chest.rewards || {};
  if (r.gold) resources.gold += r.gold;
  if (r.wood) resources.wood += r.wood;
  if (r.food) resources.food += r.food;
  if (r.gem) resources.gem += r.gem;

 chest.claimed = true;
saveTasksState();
recalcTasksNotification();
updateRes();
renderTasksPage();
closeDailyChestPopup();
}

let currentChestType = null;   // "daily" Ø£Ùˆ "weekly"
let currentChestIndex = null;

function openDailyChestPopup(index) {
  currentChestType = "daily";
  currentChestIndex = index;
  openChestPopupFromData(DAILY_CHESTS[index], index);
}

function openWeeklyChestPopup(index) {
  currentChestType = "weekly";
  currentChestIndex = index;
  openChestPopupFromData(WEEKLY_CHESTS[index], index);
}

function openChestPopupFromData(chest, index) {
  if (!chest) return;

  const popup = document.getElementById("chest-popup");
  const titleEl = document.getElementById("chest-title");
  const statusEl = document.getElementById("chest-status");
  const rewardsEl = document.getElementById("chest-rewards");
  const claimBtn = document.getElementById("chest-claim-btn");

  if (!popup || !titleEl || !statusEl || !rewardsEl || !claimBtn) return;

  const points = currentChestType === "daily" ? dailyPoints : weeklyPoints;
  const unlocked = points >= chest.requiredPoints;
  const claimed = chest.claimed;

  titleEl.textContent =
    (currentChestType === "daily" ? "Daily Chest " : "Weekly Chest ") + (index + 1);

  if (!unlocked) {
    statusEl.textContent = `Reach ${chest.requiredPoints} points to unlock this chest.`;
    statusEl.style.color = "#f97316";
    claimBtn.disabled = true;
    claimBtn.style.opacity = "0.6";
    claimBtn.style.cursor = "default";
  } else if (claimed) {
    statusEl.textContent = "You already claimed this chest.";
    statusEl.style.color = "#9ca3af";
    claimBtn.disabled = true;
    claimBtn.style.opacity = "0.6";
    claimBtn.style.cursor = "default";
  } else {
    statusEl.textContent = "Chest is ready to claim!";
    statusEl.style.color = "#22c55e";
    claimBtn.disabled = false;
    claimBtn.style.opacity = "1";
    claimBtn.style.cursor = "pointer";
  }

  rewardsEl.innerHTML = "";
  const r = chest.rewards || {};
  const iconStyle =
    "width:24px; height:24px; border-radius:6px; background:#111827; display:flex; align-items:center; justify-content:center; font-size:14px;";

  if (r.gold) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸŸ¡</div><div>${r.gold.toLocaleString()} Gold</div>`;
    rewardsEl.appendChild(item);
  }
  if (r.wood) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸªµ</div><div>${r.wood.toLocaleString()} Wood</div>`;
    rewardsEl.appendChild(item);
  }
  if (r.food) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸ–</div><div>${r.food.toLocaleString()} Food</div>`;
    rewardsEl.appendChild(item);
  }
  if (r.gem) {
    const item = document.createElement("div");
    item.style.display = "flex";
    item.style.alignItems = "center";
    item.style.gap = "4px";
    item.innerHTML = `<div style="${iconStyle}">ğŸ’</div><div>${r.gem.toLocaleString()} Gems</div>`;
    rewardsEl.appendChild(item);
  }

  popup.classList.remove("hidden");
}

function closeChestPopup() {
  const popup = document.getElementById("chest-popup");
  if (popup) popup.classList.add("hidden");
  currentChestType = null;
  currentChestIndex = null;
}

function confirmChestClaim() {
  if (currentChestType === null || currentChestIndex === null) return;

  const isDaily = currentChestType === "daily";
  const chestsArr = isDaily ? DAILY_CHESTS : WEEKLY_CHESTS;
  const chest = chestsArr[currentChestIndex];
  if (!chest) return;

  const points = isDaily ? dailyPoints : weeklyPoints;
  const unlocked = points >= chest.requiredPoints;
  const claimed = chest.claimed;
  if (!unlocked || claimed) return;

  const r = chest.rewards || {};
  if (r.gold) resources.gold += r.gold;
  if (r.wood) resources.wood += r.wood;
  if (r.food) resources.food += r.food;
  if (r.gem) resources.gem += r.gem;

 chest.claimed = true;
saveTasksState();
recalcTasksNotification();
updateRes();
renderTasksPage();
closeChestPopup();

}
const infoBtnBottom = document.getElementById("bottom-info-btn");
const upgradeBtnBottom = document.getElementById("bottom-upgrade-btn");

if (infoBtnBottom) {
  infoBtnBottom.onclick = function () {
    if (!currentBuildingKey) return;
    openBuildingPanel(currentBuildingKey);   // Ø§ÙØªØ­ Ø§Ù„Ø¨Ø§Ù†Ù„ Ø§Ù„Ù…ÙˆØ­Ù‘Ø¯
    switchBuildingPanelTab('info');          // ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª
  };
}

if (upgradeBtnBottom) {
  upgradeBtnBottom.onclick = function () {
    if (!currentBuildingKey) return;
    openBuildingPanel(currentBuildingKey);   // Ù†ÙØ³ Ø§Ù„Ø¨Ø§Ù†Ù„
    switchBuildingPanelTab('upgrade');       // ØªØ¨ÙˆÙŠØ¨ Ø§Ù„ØªØ±Ù‚ÙŠØ©
  };
}





    </script>

      <div id="settings-screen">
    <div class="settings-header">
      <span>âš™ï¸ Settings</span>
      <button onclick="closeSettings()">âœ–</button>
    </div>

    <div class="settings-content">

    <div class="setting-item" id="language-setting">ğŸŒ Language</div>

    <div class="setting-item" id="telegram-setting">ğŸ“¢ Telegram Channel</div>

    <div class="setting-item" id="twitter-setting">ğŸ¦ Twitter Channel</div>

    <div class="setting-item" id="terms-setting">ğŸ“œ Terms of Use</div>

    <div class="setting-item" id="privacy-setting">ğŸ”’ Privacy Policy</div>
    </div>

    <div id="language-modal" class="full-page hidden">
  <div style="margin: auto; background: #1e293b; padding: 20px; border-radius: 15px; width: 80%; max-width: 300px; text-align: center;">
    <h3 style="color:white;">Select Language / Ø§Ø®ØªØ± Ø§Ù„Ù„ØºØ©</h3>
    <button style="margin: 10px; padding: 8px 15px; border-radius: 10px; border:none; background:#007bff; color:white; cursor:pointer;" onclick="setLanguage('en')">English</button>
    <button style="margin: 10px; padding: 8px 15px; border-radius: 10px; border:none; background:#007bff; color:white; cursor:pointer;" onclick="setLanguage('ar')">Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©</button>
    <br>
    <button style="margin-top: 10px; padding: 6px 12px; border-radius: 10px; border:none; background:#555; color:white; cursor:pointer;" onclick="closeLanguageModal()">Cancel</button>
  </div>
  </div>
  </div>
  <div id="tutorial-overlay" style="display:none;">
  <div id="tutorial-box">
    <p id="tutorial-text"></p>
    <button id="tutorial-next">Ø§Ù„ØªØ§Ù„ÙŠ</button>
  </div>
</div>
<div id="castle-cancel-popup" class="full-page hidden">
  <div class="page-content" style="max-width: 320px; margin:auto; margin-top: 30vh; text-align:center; background:#1e293b; color:#fff; padding:16px; border-radius:14px;">
    <p style="margin-bottom:12px;">
      Ø³ØªÙÙ‚Ø¯ 50% Ù…Ù† Ø§Ù„Ù…ÙˆØ§Ø±Ø¯ Ø§Ù„Ù…ÙÙ†ÙÙÙ‚Ø© Ø¹Ù„Ù‰ Ø§Ù„ØªØ±Ù‚ÙŠØ©. Ù‡Ù„ ØªØ±ÙŠØ¯ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©ØŸ
    </p>
    <button id="castle-cancel-confirm"
            style="margin:4px; padding:6px 14px; border-radius:10px; border:none; background:#ef4444; color:#fff; cursor:pointer;">
      Ù…ÙˆØ§ÙÙ‚
    </button>
    <button id="castle-cancel-dismiss"
            style="margin:4px; padding:6px 14px; border-radius:10px; border:none; background:#4b5563; color:#fff; cursor:pointer;">
      Ø¥Ù„ØºØ§Ø¡
    </button>
  </div>
</div>
<script>
  const tg = window.Telegram && window.Telegram.WebApp ? window.Telegram.WebApp : null;
  tg && tg.ready();

  const user = tg && tg.initDataUnsafe ? tg.initDataUnsafe.user : null;

  console.log("Telegram user from WebApp:", user);

  const API_BASE = "https://raidex-backend-production.up.railway.app";

  async function registerTelegramPlayer() {
    if (!user) {
      console.log("No Telegram user data available.");
      return;
    }

    try {
      const res = await fetch(API_BASE + "/register-telegram-player", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          telegramId: user.id,
          telegramName: user.username || user.first_name || "Unknown"
        })
      });

      const data = await res.json();
      console.log("Registered Telegram player:", data);
    } catch (err) {
      console.error("Error registering telegram player:", err);
    }
  }

  window.addEventListener("load", () => {
    registerTelegramPlayer();
  });
</script>

  </body>
</html>